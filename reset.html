<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b6b;
            --primary-dark: #ee5a52;
            --primary-light: #ff9e9e;
            --secondary: #4ecdc4;
            --secondary-dark: #3db8af;
            --tertiary: #45b7d1;
            --background: #0f172a;
            --background-light: #1e293b;
            --background-lighter: #334155;
            --card-bg: rgba(30, 41, 59, 0.8);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-muted: #cbd5e1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.3);
            --glow: 0 0 15px rgba(255, 107, 107, 0.5);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--background) 0%, #1a1f35 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            max-width: 1300px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
        }
        
        .game-area, .info-area {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }
        
        .game-area::before, .info-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--tertiary));
            border-radius: 20px 20px 0 0;
        }
        
        .info-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .game-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #ff9a9e, #fad0c4, #fbc2eb, #84fab0, #8fd3f4, #ffd83d, #a18cd1, #fbc2eb, #a6c1ee, #fecfef, #f5d300, #ff8042);
            background-size: 800% 800%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: gradient-animation 3s linear infinite;
            /* 确保浏览器兼容性 */
            -webkit-animation: gradient-animation 3s linear infinite;
            -moz-animation: gradient-animation 3s linear infinite;
            -o-animation: gradient-animation 3s linear infinite;
            display: inline-block; /* 确保渐变效果正确应用 */
        }
        
        .game-stage {
            font-size: 16px;
            color: #4ecdc4;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .water-tree-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }
        
        .tree-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }
        
        .tree-status div {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .water-tree-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #4ECDC4, #45B7D1);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }
        
        .water-tree-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(78, 205, 196, 0.4);
        }
        
        .water-tree-results {
            padding: 15px;
            background-color: var(--card-bg-dark);
            border-radius: 8px;
            min-height: 60px;
            font-size: 14px;
            color: var(--text-color-secondary);
            border: 1px dashed var(--card-border);
        }
        
        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        /* 浏览器兼容性 */
        @-webkit-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @-moz-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @-o-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        .stats {
            display: flex;
            gap: 15px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            min-width: 150px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-top: 5px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
        
        .block-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .block-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .block-category {
            display: flex;
            gap: 10px;
            background: var(--background-light);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .category-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .category-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-light);
        }
        
        .category-btn:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .block-display {
            width: 280px;
            height: 280px;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--card-border);
        }
        
        .block-display:hover {
            transform: scale(1.03);
            box-shadow: var(--glow), var(--shadow);
            border-color: var(--primary);
        }
        
        .block-display:active {
            transform: scale(0.98);
        }
        
        .block-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .block-hp {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .block-rewards {
            font-size: 16px;
            margin-top: 5px;
            text-align: center;
            color: var(--text-muted);
        }
        
        .block-nav-btn {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            border: none;
            color: var(--text);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
        }
        
        .block-nav-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            background: var(--background-light);
            border-radius: 12px;
            padding: 5px;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            font-weight: 600;
            position: relative;
        }
        
        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: var(--shadow-light);
        }
        
        .tab-btn:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab-content {
            display: none;
            height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .boost-item, .resource-item, .shop-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: box-shadow 0.3s ease, background 0.3s ease;
        }
        
        .boost-item:hover, .resource-item:hover, .shop-item:hover {
            box-shadow: var(--shadow);
        }
        
        .shop-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .shop-item-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .shop-item button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-light);
            width: 100%;
        }
        
        .shop-item button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(233, 69, 96, 0.4);
        }
        
        .shop-item button:disabled {
            background: linear-gradient(135deg, #555 0%, #777 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .alchemy-area {
            margin-top: 20px;
        }
        
        .alchemy-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .alchemy-input input {
            flex: 1;
            padding: 12px;
            background: var(--background-lighter);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
        }
        
        .alchemy-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }
        
        .alchemy-btn, .convert-alchemy-btn, button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-light);
        }
        
        .alchemy-btn:hover, .convert-alchemy-btn:hover, button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .convert-alchemy-btn {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
            margin-top: 15px;
            width: 100%;
        }
        
        .convert-alchemy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        .alchemy-results {
            margin-top: 15px;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-light);
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--background-lighter);
            border-radius: 6px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        h2 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: inline-block;
        }
        
        .pickaxe-use-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
        }
        
        .pickaxe-use-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .pickaxe-use-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .level-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .level-icon {
            font-size: 24px;
            color: var(--primary);
        }
        
        .damage-popup {
            position: absolute;
            color: var(--primary);
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 1s forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* 已在文件开头定义了带炫彩渐变的.game-title样式 */
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        .convert-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }
        
        .convert-info {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-muted);
            text-align: center;
        }
        
        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .auto-save-info {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
        }
        
        .pickaxe-count {
            background: rgba(255, 107, 107, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin-left: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .achievement-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .achievement-item.unlocked {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        
        .achievement-item.locked {
            opacity: 0.6;
            filter: grayscale(0.8);
        }
        
        .achievement-status {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
            font-weight: 500;
        }
        
        .achievement-item.unlocked .achievement-status {
            color: var(--text);
        }
        
        .achievement-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: slideInRight 0.5s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .shop-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: var(--background-light);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .shop-categories .category-btn {
            flex: 1;
            background: transparent;
            color: var(--text-muted);
        }
        
        .alchemy-value-display {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }
        
        .alchemy-value-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .alchemy-value-amount {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
            margin-top: 5px;
        }
        
        /* 自定义滚动条 */
        .tab-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .tab-content::-webkit-scrollbar-track {
            background: var(--background-lighter);
            border-radius: 5px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .tab-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--secondary-dark));
        }
        
        /* 响应式调整 */
        @media (max-width: 1100px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .stat-item {
                min-width: 130px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .game-area, .info-area {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .block-navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .block-category {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 8px;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-item {
                width: 100%;
                min-width: auto;
            }
            
            .block-display {
                width: 240px;
                height: 240px;
            }
            
            .alchemy-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-area">
            <div class="header">
                <div>
                    <div class="game-title">重置v1.0.0</div>
                    <div class="game-stage" id="game-stage">当前阶段: 第一阶段</div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div>总伤害</div>
                        <div class="stat-value" id="total-damage">1.00</div>
                    </div>
                    <div class="stat-item">
                        <div>金币</div>
                        <div class="stat-value" id="gold">0</div>
                    </div>
                    <div class="stat-item">
                        <div>奖杯</div>
                        <div class="stat-value" id="trophies">0</div>
                    </div>
                </div>
            </div>

            <div class="block-area">
                <div class="block-navigation">
                    <button class="block-nav-btn" id="prev-block"><i class="fas fa-chevron-left"></i></button>
                    <div class="block-category">
                        <button class="category-btn active" data-category="main1">主线1</button>
                        <button class="category-btn" data-category="side1">支线1</button>
                    </div>
                    <button class="block-nav-btn" id="next-block"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="block-display" id="block-display">
                    <div class="block-name" id="block-name">土块</div>
                    <div class="block-hp" id="block-hp">100/100</div>
                    <div class="block-rewards" id="block-rewards">基础奖励: 1金币</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="boosts"><i class="fas fa-chart-line"></i> 增益</button>
                <button class="tab-btn" data-tab="resources"><i class="fas fa-gem"></i> 资源</button>
                <button class="tab-btn" data-tab="shop"><i class="fas fa-shopping-cart"></i> 商店</button>
                <button class="tab-btn" data-tab="alchemy"><i class="fas fa-flask"></i> 炼药</button>
                <button class="tab-btn" data-tab="achievements"><i class="fas fa-trophy"></i> 成就</button>
                <button class="tab-btn" data-tab="water-tree"><i class="fas fa-tint"></i> 浇树</button>
            </div>

            <div class="tab-content active" id="boosts-tab">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>增益效果</h2>
                </div>
                <div id="boosts-list">
                    <!-- 增益项将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="resources-tab">
                <div class="section-title">
                    <i class="fas fa-gem"></i>
                    <h2>资源</h2>
                </div>
                <div id="resources-list">
                    <!-- 资源项将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="shop-tab">
                <div class="section-title">
                    <i class="fas fa-shopping-cart"></i>
                    <h2>商店</h2>
                </div>
                <div class="shop-categories">
                    <button class="category-btn active" data-shop="main1">主线1商店</button>
                    <button class="category-btn" data-shop="side1">支线1商店</button>
                    <button class="category-btn" data-shop="items">物品商店</button>
                </div>
                <div id="shop-items">
                    <!-- 商店物品将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="alchemy-tab">
                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    <h2>炼药系统</h2>
                </div>
                <div class="alchemy-area">
                    <div class="alchemy-value-display">
                        当前炼药价值: <span class="alchemy-value-amount" id="alchemy-value-amount">0</span>
                    </div>
                    <button class="convert-alchemy-btn" id="convert-alchemy-btn">一键换取炼药价值</button>
                    <div class="alchemy-input">
                        <input type="number" id="alchemy-value-input" placeholder="单次炼药价值" min="1" value="1">
                        <input type="number" id="alchemy-times" placeholder="炼药次数" min="1" max="10000" value="1">
                        <button class="alchemy-btn" id="alchemy-btn">开始炼药</button>
                    </div>
                    <div class="alchemy-results" id="alchemy-results">
                        炼药结果将显示在这里
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <div class="section-title">
                    <i class="fas fa-trophy"></i>
                    <h2>成就系统</h2>
                </div>
                <div id="achievements-list">
                    <!-- 成就列表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="tab-content" id="water-tree-tab">
                <div class="section-title">
                    <i class="fas fa-tree"></i>
                    <h2>树系统</h2>
                </div>
                <div class="water-tree-area">
                    <div class="stat-item">
                        <div>
                            <div>树等级: <span id="tree-level">1</span></div>
                            <div>树经验: <span id="tree-exp">0</span>/<span id="tree-exp-needed">10</span></div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="tree-exp-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <button class="water-tree-btn" id="water-tree-btn">到达阶段2解锁浇树系统</button>
                    <div class="water-tree-results" id="water-tree-results">
                        浇树结果将显示在这里
                    </div>
                </div>
            </div>
        </div>

        <div class="info-area">
            <div class="section-title">
                <i class="fas fa-hard-hat"></i>
                <h2>当前镐子</h2>
            </div>
            <div class="boost-item">
                <div>
                    <div id="current-pickaxe">木镐</div>
                    <div>增益: <span id="pickaxe-boost">1</span></div>
                    <div>金币倍率: <span id="gold-multiplier">1</span></div>
                    <div>使用增益增加: <span id="usage-gain">0.01</span></div>
                </div>
            </div>

            <div class="level-area">
                <i class="fas fa-level-up-alt level-icon"></i>
                <div>
                    <div>等级: <span id="level">0</span></div>
                    <div>经验: <span id="exp">0</span>/<span id="exp-needed">0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="section-title">
                <i class="fas fa-calculator"></i>
                <h2>统计数据</h2>
            </div>
            <div class="stat-item">
                <div>
                    <div>使用增益: <span id="usage-boost">1</span></div>
                    <div>奖杯增益: <span id="trophy-boost">1</span></div>
                    <div>等级增益: <span id="level-boost">1</span></div>
                    <div>炼药增益: <span id="alchemy-boost">1</span></div>
                    <div>游戏阶段: <span id="game-stage">1</span></div>
                    <div id="tree-boost">浇树增益: 1.00</div>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fas fa-robot"></i>
                <h2>自动挖矿</h2>
            </div>
            <button class="alchemy-btn" id="auto-mining-toggle">开启自动挖矿</button>
            
            <!-- 树系统已移至浇树区域 -->

            <div class="section-title">
                <i class="fas fa-exchange-alt"></i>
                <h2>金币兑换</h2>
            </div>
            <button class="convert-btn" id="convert-btn">全部兑换为奖杯</button>
            <div class="convert-info" id="convert-info">
                当前可兑换: 0 奖杯
            </div>
            <div class="auto-save-info">
                <i class="fas fa-save"></i> 每5秒自动保存
            </div>

            <div class="section-title">
                <i class="fas fa-info-circle"></i>
                <h2>游戏说明</h2>
            </div>
            <div style="margin-top: 10px; font-size: 14px; line-height: 1.6;">
                <p><i class="fas fa-mouse-pointer"></i> 点击方块进行挖掘</p>
                <p><i class="fas fa-coins"></i> 获得金币和经验值</p>
                <p><i class="fas fa-trophy"></i> 使用金币兑换奖杯</p>
                <p><i class="fas fa-level-up-alt"></i> 经验值满后自动升级</p>
                <p><i class="fas fa-shopping-cart"></i> 在商店购买更好的镐子</p>
                <p><i class="fas fa-flask"></i> 使用炼药系统提升炼药增益</p>
            </div>
        </div>
    </div>

    <div class="save-notification" id="save-notification">
        <i class="fas fa-check-circle"></i> 游戏已自动保存
    </div>
    <div class="achievement-notification" id="achievement-notification" style="display: none;">
        <i class="fas fa-trophy"></i> <span id="achievement-name">成就解锁！</span>
    </div>

    <script>
        // 游戏数据定义
        const gameData = {
            // 方块数据
            blocks: {
                main1: [
                    { name: "土块", hp: 100, baseGold: 1 },
                    { name: "草块", hp: 500, baseGold: 2 },
                    { name: "木块", hp: 2000, baseGold: 3 },
                    { name: "石块", hp: 10000, baseGold: 5 },
                    { name: "硬石块", hp: 50000, baseGold: 10 },
                    { name: "深板岩", hp: 300000, baseGold: 15 },
                    { name: "煤炭块", hp: 1780000, baseGold: 20 },
                    { name: "铜块", hp: 7800000, baseGold: 30 },
                    { name: "铁块", hp: 91000000, baseGold: 40 },
                    { name: "金块", hp: 260000000, baseGold: 50 },
                    { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                    { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                    { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                    { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                    { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                    { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                    { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                    { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                    { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                    { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                    { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                ],
                side1: [
                    { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                    { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                    { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } }
                ]
            },
            
            // 镐子数据
            pickaxes: {
                main1: [
                    { name: "木镐", cost: { trophies: 1 }, boost: 1, goldMultiplier: 1, usageGain: 0.01 },
                    { name: "石镐", cost: { trophies: 2 }, boost: 2, goldMultiplier: 1, usageGain: 0.02 },
                    { name: "铁镐", cost: { trophies: 6 }, boost: 5, goldMultiplier: 1, usageGain: 0.05 },
                    { name: "金镐", cost: { trophies: 24 }, boost: 10, goldMultiplier: 1, usageGain: 0.1 },
                    { name: "钻石镐", cost: { trophies: 120 }, boost: 20, goldMultiplier: 1, usageGain: 0.2 },
                    { name: "下届合金镐", cost: { trophies: 600 }, boost: 50, goldMultiplier: 1, usageGain: 0.5 },
                    { name: "黑曜石镐", cost: { trophies: 3000 }, boost: 100, goldMultiplier: 1, usageGain: 1 },
                    { name: "红曜石镐", cost: { fragments: { "红曜石碎片": 10 }, basePickaxe: "黑曜石镐" }, boost: 150, goldMultiplier: 1, usageGain: 1.5 },
                    { name: "蓝曜石镐", cost: { fragments: { "蓝曜石碎片": 10 }, basePickaxe: "红曜石镐" }, boost: 200, goldMultiplier: 1, usageGain: 2 },
                    { name: "红蓝镐", cost: { fragments: { "下界之星": 10 }, basePickaxes: ["红曜石镐", "蓝曜石镐"] }, boost: 300, goldMultiplier: 1, usageGain: 3 },
                    { name: "基岩镐", cost: { fragments: { "基岩碎片": 10 }, basePickaxe: "红蓝镐" }, boost: 500, goldMultiplier: 1, usageGain: 4 },
                    { name: "木核心镐", cost: { fragments: { "木核心": 10 }, basePickaxe: "红蓝镐" }, boost: 800, goldMultiplier: 1.5, usageGain: 5 },
                    { name: "土核心镐", cost: { fragments: { "土核心": 10 }, basePickaxes: ["木核心镐", "基岩镐"] }, boost: 1200, goldMultiplier: 1.5, usageGain: 6 },
                    { name: "水立方镐", cost: { fragments: { "水立方": 5 }, usageBoost: 100000 }, boost: 2000, goldMultiplier: 1.5, usageGain: 7 },
                    { name: "火立方镐", cost: { fragments: { "火立方": 5 }, usageBoost: 100000 }, boost: 3000, goldMultiplier: 1.5, usageGain: 8 },
                    { name: "金立方镐", cost: { fragments: { "金立方": 5 }, usageBoost: 100000 }, boost: 5000, goldMultiplier: 1.5, usageGain: 9 },
                    { name: "五行镐", cost: { fragments: { "五行转换器": 1 }, basePickaxes: ["金立方镐", "木核心镐", "水立方镐", "火立方镐", "土核心镐"] }, boost: 15000, goldMultiplier: 2.5, usageGain: 15 }
                ],
                side1: [
                    { name: "紫水晶镐Ⅰ", cost: { fragments: { "紫水晶": 10 } }, boost: 120, goldMultiplier: 1, usageGain: 2 },
                    { name: "紫水晶镐Ⅱ", cost: { fragments: { "紫水晶镐Ⅰ": 8 } }, boost: 240, goldMultiplier: 1, usageGain: 3 },
                    { name: "紫水晶镐Ⅲ", cost: { fragments: { "紫水晶镐Ⅱ": 6 } }, boost: 400, goldMultiplier: 1.5, usageGain: 5 },
                    { name: "紫水晶镐Ⅳ", cost: { fragments: { "紫水晶镐Ⅲ": 4 } }, boost: 800, goldMultiplier: 1.5, usageGain: 8 },
                    { name: "紫水晶镐Ⅴ", cost: { fragments: { "紫水晶镐Ⅳ": 2 } }, boost: 1500, goldMultiplier: 2, usageGain: 10 }
                ],
                items: [
                    { name: "红曜石", cost: { fragments: { "红曜石碎片": 365 } } },
                    { name: "蓝曜石", cost: { fragments: { "蓝曜石碎片": 366 } } },
                    { name: "五行转换器", cost: { fragments: { "蓝曜石": 5, "红曜石": 5, "紫水晶镐Ⅴ": 1 } } }
                ]
            },
            
            // 炼药价值
            alchemyValues: {
                "下界之星": 1,
                "基岩碎片": 5,
                "坤坤": 25,
                "木核心": 50,
                "土核心": 80,
                "水立方": 120,
                "火立方": 160,
                "金立方": 200
            },
            
            // 万进制单位
            units: ['', '万', '亿', '万亿', '兆', '万兆', '亿兆', '万亿兆', '京', '万京', '亿京', '万亿京', '兆京', '万兆京', '亿兆京', '万亿兆京', '垓', '万垓', '亿垓', '万亿垓', '兆垓', '万兆垓', '亿兆垓', '万亿兆垓', '京垓', '万京垓', '亿京垓', '万亿京垓', '兆京垓', '万兆京垓', '亿兆京垓', '万亿兆京垓', '杼', '万杼', '亿杼', '万亿杼', '兆杼', '万兆杼', '亿兆杼', '万亿兆杼', '京杼', '万京杼', '亿京杼', '万亿京杼', '兆京杼', '万兆京杼', '亿兆京杼', '万亿兆京杼', '垓杼', '万垓杼', '亿垓杼', '万亿垓杼', '兆垓杼', '万兆垓杼', '亿兆垓杼', '万亿兆垓杼', '京垓杼', '万京垓杼', '亿京垓杼', '万亿京垓杼', '兆京垓杼', '万兆京垓杼', '亿兆京垓杼', '万亿兆京垓杼', '穰', '万穰', '亿穰', '万亿穰', '兆穰', '万兆穰', '亿兆穰', '万亿兆穰', '京穰', '万京穰', '亿京穰', '万亿京穰', '兆京穰']
        };

        // 游戏状态 - 使用window.gameState确保全局一致
        if (!window.gameState) {
            window.gameState = {
                level: 0,
                exp: 0,
                gold: 0,
                trophies: 0,
                currentBlockCategory: "main1",
                currentBlockIndex: 0,
                currentPickaxe: "木镐",
                usageBoost: 1,
                alchemyBoost: 1,
                alchemyValue: 0,
                gameStage: 1,
                resources: {
                    "红曜石碎片": 0,
                    "蓝曜石碎片": 0,
                    "基岩碎片": 0,
                    "木核心": 0,
                    "土核心": 0,
                    "水立方": 0,
                    "火立方": 0,
                    "金立方": 0,
                    "紫水晶": 0,
                    "下界之星": 0,
                    "坤坤": 0,
                    "红曜石": 0,
                    "蓝曜石": 0,
                    "五行转换器": 0
                },
                pickaxes: {
                    "木镐": 1,
                    "石镐": 0,
                    "铁镐": 0,
                    "金镐": 0,
                    "钻石镐": 0,
                    "下届合金镐": 0,
                    "黑曜石镐": 0,
                    "红曜石镐": 0,
                    "蓝曜石镐": 0,
                    "红蓝镐": 0,
                    "基岩镐": 0,
                    "木核心镐": 0,
                    "土核心镐": 0,
                    "水立方镐": 0,
                    "火立方镐": 0,
                    "金立方镐": 0,
                    "五行镐": 0,
                    "紫水晶镐Ⅰ": 0,
                    "紫水晶镐Ⅱ": 0,
                    "紫水晶镐Ⅲ": 0,
                    "紫水晶镐Ⅳ": 0,
                    "紫水晶镐Ⅴ": 0
                },
                blockHp: {}
            };
        }

        // 初始化方块血量
        function initBlockHp() {
            try {
                // 验证必要的数据结构
                if (!gameData || typeof gameData !== 'object' || !gameData.blocks) {
                    console.error('初始化方块血量失败：游戏数据无效');
                    return;
                }
                
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1, blockHp: {} };
                }
                
                // 确保blockHp对象存在
                if (!window.gameState.blockHp) {
                    window.gameState.blockHp = {};
                }
                
                // 遍历所有方块分类
                for (const category in gameData.blocks) {
                    try {
                        // 确保分类数据有效
                        if (!gameData.blocks.hasOwnProperty(category) || !Array.isArray(gameData.blocks[category])) {
                            console.warn(`跳过无效的方块分类: ${category}`);
                            continue;
                        }
                        
                        // 初始化该分类的血量数组
                        window.gameState.blockHp[category] = [];
                        
                        // 遍历该分类下的所有方块
                        for (let i = 0; i < gameData.blocks[category].length; i++) {
                            try {
                                const block = gameData.blocks[category][i];
                                // 验证方块数据和血量
                                if (!block || typeof block.hp !== 'number' || isNaN(block.hp) || block.hp < 0) {
                                    // 使用默认血量值
                                    window.gameState.blockHp[category][i] = 100;
                                    console.warn(`方块 ${category}[${i}] 的血量无效，使用默认值 100`);
                                } else {
                                    window.gameState.blockHp[category][i] = Math.max(1, block.hp); // 确保血量至少为1
                                }
                            } catch (blockError) {
                                console.error(`初始化方块 ${category}[${i}] 血量失败:`, blockError);
                                // 出错时使用默认值
                                window.gameState.blockHp[category][i] = 100;
                            }
                        }
                    } catch (categoryError) {
                        console.error(`初始化方块分类 ${category} 失败:`, categoryError);
                        // 出错时初始化空数组
                        window.gameState.blockHp[category] = [];
                    }
                }
            } catch (e) {
                console.error('初始化方块血量失败:', e);
                // 确保blockHp至少是一个空对象
                window.gameState.blockHp = {};
            }
        }

        // 格式化数字为万进制，保留两位小数（整数不保留）
        function formatNumber(num) {
            num = Number(num) || 0;
            
            if (num < 10000000) {
                // 对于小于千万的数字，如果是整数则不保留小数
                if (Number.isInteger(num)) {
                    return num.toLocaleString();
                } else {
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }
            }
            
            let unitIndex = 0;
            while (num >= 10000 && unitIndex < gameData.units.length - 1) {
                num /= 10000;
                unitIndex++;
            }
            
            // 对于大数字，保留两位小数，如果是整数则不保留
            if (Number.isInteger(num)) {
                return num.toString() + gameData.units[unitIndex];
            } else {
                return num.toFixed(2).replace(/\.?0+$/, '') + gameData.units[unitIndex];
            }
        }

        // 计算所需经验
        function getExpNeeded(level) {
            // 修复经验计算公式，确保升级难度合理
            return Math.round(Math.pow(1.01, level) * 10) / 10;
        }

        // 计算奖杯数量
        function calculateTrophies(gold) {
            // 新公式：(金币/100)^0.8
            if (gold < 100) return 0;
            return Math.floor(Math.pow(gold / 100, 0.8));
        }

        // 计算奖杯增益
        function calculateTrophyBoost(trophies) {
            return 1 + Math.pow(trophies, 0.4);
        }

        // 计算等级增益
        function calculateLevelBoost(level) {
            return 1 + Math.pow(level, 0.5);
        }

        // 计算总伤害
        function calculateTotalDamage() {
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            const trophyBoost = calculateTrophyBoost(window.gameState.trophies);
             const levelBoost = calculateLevelBoost(window.gameState.level);
            
            return pickaxeBoost * window.gameState.usageBoost * trophyBoost * levelBoost * window.gameState.alchemyBoost;
        }

        // 保存游戏状态
        function saveGame() {
            try {
                // 验证gameState是否有效
                if (!window.gameState || typeof window.gameState !== 'object') {
                    console.error('保存失败：游戏状态无效');
                    return;
                }
                
                // 创建一个干净的游戏状态副本，避免保存循环引用或无效数据
                const cleanGameState = {
                    level: Math.max(0, Number(window.gameState.level) || 0),
                    exp: Math.max(0, Number(window.gameState.exp) || 0),
                    gold: Math.max(0, Number(window.gameState.gold) || 0),
                    trophies: Math.max(0, Number(window.gameState.trophies) || 0),
                    currentBlockCategory: String(window.gameState.currentBlockCategory || "main1"),
                    currentBlockIndex: Math.max(0, Number(window.gameState.currentBlockIndex) || 0),
                    currentPickaxe: String(window.gameState.currentPickaxe || "木镐"),
                    usageBoost: Math.max(1, Number(window.gameState.usageBoost) || 1),
                    alchemyBoost: Math.max(1, Number(window.gameState.alchemyBoost) || 1),
                    alchemyValue: Math.max(0, Number(window.gameState.alchemyValue) || 0),
                    // 新增状态保存
                    treeLevel: Math.max(1, Number(window.gameState.treeLevel) || 1),
                    treeExp: Math.max(0, Number(window.gameState.treeExp) || 0),
                    autoMiningEnabled: Boolean(window.gameState.autoMiningEnabled || false),
                    totalDamage: Math.max(0, Number(window.gameState.totalDamage) || 0),
                    gameStage: Math.max(1, Number(window.gameState.gameStage) || 1),
                    achievements: { ...(window.gameState.achievements || {}) },
                    resources: { ...(window.gameState.resources || {}) },
                    pickaxes: { ...(window.gameState.pickaxes || {}) },
                    blockHp: { ...(window.gameState.blockHp || {}) }
                };
                
                // 确保resources和pickaxes中的值都是有效的数字
                for (const [key, value] of Object.entries(cleanGameState.resources)) {
                    cleanGameState.resources[key] = Math.max(0, Number(value) || 0);
                }
                
                for (const [key, value] of Object.entries(cleanGameState.pickaxes)) {
                    cleanGameState.pickaxes[key] = Math.max(0, Number(value) || 0);
                }
                
                // 尝试保存到localStorage
                try {
                    localStorage.setItem('miningGameState', JSON.stringify(cleanGameState));
                    
                    // 显示保存通知
                    try {
                        showSaveNotification();
                    } catch (notificationError) {
                        console.warn('显示保存通知失败:', notificationError);
                    }
                    
                    return true;
                } catch (storageError) {
                    // 处理localStorage相关错误
                    if (storageError.name === 'QuotaExceededError') {
                        console.error('保存失败：存储空间不足');
                        // 尝试清理一些非关键数据后重试
                        try {
                            // 移除blockHp以减少数据大小
                            const minimalGameState = { ...cleanGameState };
                            delete minimalGameState.blockHp;
                            localStorage.setItem('miningGameState', JSON.stringify(minimalGameState));
                            return true;
                        } catch (retryError) {
                            console.error('精简数据后保存仍失败:', retryError);
                        }
                    } else {
                        console.error('保存到localStorage失败:', storageError);
                    }
                }
            } catch (e) {
                console.error('保存游戏失败:', e);
            }
            return false;
        }

        // 加载游戏状态
        function loadGame() {
            try {
                // 确保gameState已经初始化
                if (!window.gameState) {
                    initGameState();
                }
                
                // 尝试从localStorage加载
                const savedState = localStorage.getItem('miningGameState');
                if (!savedState) {
                    console.log('没有找到保存的游戏数据');
                    return false;
                }
                
                // 解析保存的数据
                let parsedState;
                try {
                    parsedState = JSON.parse(savedState);
                } catch (parseError) {
                    console.error('解析保存数据失败:', parseError);
                    initGameState();
                    return false;
                }
                
                // 验证解析后的数据
                if (!parsedState || typeof parsedState !== 'object') {
                    console.error('无效的游戏数据格式');
                    initGameState();
                    return false;
                }
                
                // 安全地合并保存的状态，确保数据有效性
                window.gameState.level = Math.max(0, Number(parsedState.level) || 0);
                window.gameState.exp = Math.max(0, Number(parsedState.exp) || 0);
                // 加载新增的数据
                window.gameState.treeLevel = Math.max(1, Number(parsedState.treeLevel) || 1);
                window.gameState.treeExp = Math.max(0, Number(parsedState.treeExp) || 0);
                window.gameState.autoMiningEnabled = Boolean(parsedState.autoMiningEnabled || false);
                window.gameState.totalDamage = Math.max(0, Number(parsedState.totalDamage) || 0);
                window.gameState.gameStage = Math.max(1, Number(parsedState.gameStage) || 1);
                window.gameState.achievements = { ...(parsedState.achievements || window.gameState.achievements) };
                window.gameState.gold = Math.max(0, Number(parsedState.gold) || 0);
                window.gameState.trophies = Math.max(0, Number(parsedState.trophies) || 0);
                window.gameState.currentBlockCategory = String(parsedState.currentBlockCategory || "main1");
                window.gameState.currentBlockIndex = Math.max(0, Number(parsedState.currentBlockIndex) || 0);
                window.gameState.currentPickaxe = String(parsedState.currentPickaxe || "木镐");
                window.gameState.usageBoost = Math.max(1, Number(parsedState.usageBoost) || 1);
                window.gameState.alchemyBoost = Math.max(1, Number(parsedState.alchemyBoost) || 1);
                window.gameState.alchemyValue = Math.max(0, Number(parsedState.alchemyValue) || 0);
                
                // 确保复杂对象存在且有效
                if (!window.gameState.resources) window.gameState.resources = {};
                if (parsedState.resources && typeof parsedState.resources === 'object') {
                    for (const [key, value] of Object.entries(parsedState.resources)) {
                        window.gameState.resources[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                if (!window.gameState.pickaxes) window.gameState.pickaxes = {};
                if (parsedState.pickaxes && typeof parsedState.pickaxes === 'object') {
                    for (const [key, value] of Object.entries(parsedState.pickaxes)) {
                        window.gameState.pickaxes[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                if (!window.gameState.blockHp) window.gameState.blockHp = {};
                if (parsedState.blockHp && typeof parsedState.blockHp === 'object') {
                    for (const [key, value] of Object.entries(parsedState.blockHp)) {
                        window.gameState.blockHp[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                // 确保至少有木镐
                if (!window.gameState.pickaxes["木镐"] || window.gameState.pickaxes["木镐"] < 1) {
                    window.gameState.pickaxes["木镐"] = 1;
                }
                
                console.log('游戏数据加载成功');
                return true;
            } catch (e) {
                console.error('加载游戏失败:', e);
                // 重置为初始状态
                try {
                    initGameState();
                } catch (initError) {
                    console.error('初始化游戏状态失败:', initError);
                }
                return false;
            }
        }

        // 显示保存通知
        function showSaveNotification() {
            try {
                // 查找通知元素
                const notification = document.getElementById('save-notification');
                
                // 检查元素是否存在
                if (!notification || !(notification instanceof HTMLElement)) {
                    console.warn('保存通知元素不存在');
                    // 如果通知元素不存在，可以创建一个临时通知
                    try {
                        const tempNotification = document.createElement('div');
                        tempNotification.textContent = '游戏已保存';
                        tempNotification.style.cssText = 
                            'position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: green; color: white; border-radius: 5px; z-index: 1000;';
                        document.body.appendChild(tempNotification);
                        
                        setTimeout(() => {
                            if (document.body.contains(tempNotification)) {
                                document.body.removeChild(tempNotification);
                            }
                        }, 2000);
                    } catch (createError) {
                        console.warn('创建临时保存通知失败:', createError);
                    }
                    return;
                }
                
                // 移除可能存在的旧的定时器，防止多个动画重叠
                if (notification._saveTimeout) {
                    clearTimeout(notification._saveTimeout);
                }
                
                // 显示通知
                notification.classList.add('show');
                
                // 设置定时器隐藏通知
                notification._saveTimeout = setTimeout(() => {
                    try {
                        if (notification && document.body.contains(notification)) {
                            notification.classList.remove('show');
                        }
                    } catch (hideError) {
                        console.warn('隐藏保存通知失败:', hideError);
                    }
                }, 2000);
            } catch (e) {
                console.error('显示保存通知失败:', e);
            }
        }

        // 更新UI
        function updateUI() {
            try {
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { level: 1, exp: 0, gold: 0, trophies: 0, gameStage: 1, treeLevel: 1, treeExp: 0, autoMiningEnabled: false };
                }
                
                // 更新基本状态
                const levelElement = document.getElementById("level");
                const expElement = document.getElementById("exp");
                const expNeededElement = document.getElementById("exp-needed");
                const goldElement = document.getElementById("gold");
                const trophiesElement = document.getElementById("trophies");
                const totalDamageElement = document.getElementById("total-damage");
                
                if (levelElement) levelElement.textContent = window.gameState.level;
                if (expElement) expElement.textContent = formatNumber(window.gameState.exp);
                if (expNeededElement) expNeededElement.textContent = formatNumber(getExpNeeded(window.gameState.level));
                if (goldElement) goldElement.textContent = formatNumber(window.gameState.gold);
                if (trophiesElement) trophiesElement.textContent = formatNumber(window.gameState.trophies);
                if (totalDamageElement) totalDamageElement.textContent = formatNumber(calculateTotalDamage());
                
                // 更新游戏阶段（使用updateGameStageDisplay函数）
                updateGameStageDisplay();
                
                // 根据游戏阶段更新标签可见性
                updateTabsVisibility();
                
                // 更新自动挖矿状态
                const autoMiningToggle = document.getElementById("auto-mining-toggle");
                if (autoMiningToggle) {
                    autoMiningToggle.textContent = window.gameState.autoMiningEnabled ? "关闭自动挖矿" : "开启自动挖矿";
                }
                
                // 更新树系统
                const treeLevelElement = document.getElementById("tree-level");
                const treeExpElement = document.getElementById("tree-exp");
                const treeExpNeededElement = document.getElementById("tree-exp-needed");
                const treeBoostElement = document.getElementById("tree-boost");
                const treeSystemElement = document.getElementById("tree-system");
                
                if (treeLevelElement) treeLevelElement.textContent = window.gameState.treeLevel || 1;
                if (treeExpElement) treeExpElement.textContent = window.gameState.treeExp || 0;
                if (treeExpNeededElement) treeExpNeededElement.textContent = 10 * (window.gameState.treeLevel || 1);
                
                // 检查是否拥有五行镐（第二阶段的标志）
                const hasFiveElementPickaxe = window.gameState.pickaxes && window.gameState.pickaxes["五行镐"] > 0;
                
                // 拥有五行镐才显示树系统和树增益
                if (treeSystemElement) {
                    treeSystemElement.style.display = hasFiveElementPickaxe ? "block" : "none";
                }
                
                if (treeBoostElement) {
                    if (hasFiveElementPickaxe) {
                        treeBoostElement.textContent = calculateTreeBoost().toFixed(2);
                        treeBoostElement.style.display = "block";
                    } else {
                        treeBoostElement.style.display = "none";
                    }
                }
                
                // 更新成就列表
                const achievementsList = document.getElementById("achievements-list");
                if (achievementsList) {
                    achievementsList.innerHTML = "";
                    
                    // 定义所有可能的成就
                    const allAchievements = [
                        { id: "初入游戏", name: "初入游戏", description: "开始你的挖矿之旅" },
                        { id: "获得奖杯", name: "获得奖杯", description: "第一次兑换奖杯" },
                        { id: "伤害一万", name: "伤害一万", description: "总伤害≥1e4" },
                        { id: "伤害一亿", name: "伤害一亿", description: "总伤害≥1e8" },
                        { id: "伤害一万亿", name: "伤害一万亿", description: "总伤害≥1e12" },
                        { id: "伤害一兆", name: "伤害一兆", description: "总伤害≥1e16" },
                        { id: "伤害一万兆", name: "伤害一万兆", description: "总伤害≥1e20" },
                        { id: "红蓝镐", name: "红蓝镐", description: "获得红蓝镐" },
                        { id: "只因你太美", name: "只因你太美", description: "获得坤坤" },
                        { id: "五行镐", name: "五行镐", description: "获得五行镐" },
                        { id: "炼药", name: "炼药", description: "开始炼药" },
                        { id: "浇树", name: "浇树", description: "第一次浇树" }
                    ];
                    
                    // 确保成就对象存在
                    if (!window.gameState.achievements) {
                        window.gameState.achievements = {};
                    }
                    
                    // 确保初入游戏成就始终是解锁状态
                    window.gameState.achievements["初入游戏"] = true;
                    
                    allAchievements.forEach(achievement => {
                        const isUnlocked = window.gameState.achievements[achievement.id] || false;
                        const achievementItem = document.createElement("div");
                        achievementItem.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                        achievementItem.innerHTML = `
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-description">${achievement.description}</div>
                            <div class="achievement-status">${isUnlocked ? '⭐ 已解锁' : '🔒 未解锁'}</div>
                        `;
                        achievementsList.appendChild(achievementItem);
                    });
                }
            }
            catch (updateUIError) {
                console.error('更新UI失败:', updateUIError);
            }
            
            // 更新炼药价值显示
            const alchemyValueAmountElement = document.getElementById("alchemy-value-amount");
            if (alchemyValueAmountElement) alchemyValueAmountElement.textContent = formatNumber(window.gameState.alchemyValue || 0);
            
            // 更新经验条
            const expBarElement = document.getElementById("exp-bar");
            if (expBarElement) {
                const expNeeded = getExpNeeded(window.gameState.level);
                const expPercent = Math.min(100, (window.gameState.exp / expNeeded) * 100);
                expBarElement.style.width = `${expPercent}%`;
            }
            
            // 更新当前方块信息
            try {
                const currentBlock = gameData.blocks[window.gameState.currentBlockCategory][window.gameState.currentBlockIndex];
                const currentHp = window.gameState.blockHp[window.gameState.currentBlockCategory]?.[window.gameState.currentBlockIndex];
                
                const blockNameElement = document.getElementById("block-name");
                const blockHpElement = document.getElementById("block-hp");
                const blockRewardsElement = document.getElementById("block-rewards");
                
                if (blockNameElement && currentBlock) blockNameElement.textContent = currentBlock.name;
                if (blockHpElement && currentBlock && currentHp) {
                    blockHpElement.textContent = `${formatNumber(currentHp)}/${formatNumber(currentBlock.hp)}`;
                }
                
                if (blockRewardsElement && currentBlock) {
                    let rewardsText = `基础奖励: ${currentBlock.baseGold}金币`;
                    if (currentBlock.special) {
                        rewardsText += `, ${(currentBlock.special.chance * 100)}%概率掉落${currentBlock.special.item}`;
                    }
                    blockRewardsElement.textContent = rewardsText;
                }
            } catch (e) {
                console.error('更新方块信息失败:', e);
            }
            
            // 更新当前镐子信息
            try {
                let currentPickaxeData = null;
                for (const shopCategory in gameData.pickaxes) {
                    currentPickaxeData = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                    if (currentPickaxeData) break;
                }
                
                const currentPickaxeElement = document.getElementById("current-pickaxe");
                const pickaxeBoostElement = document.getElementById("pickaxe-boost");
                const goldMultiplierElement = document.getElementById("gold-multiplier");
                const usageGainElement = document.getElementById("usage-gain");
                
                if (currentPickaxeElement) currentPickaxeElement.textContent = window.gameState.currentPickaxe;
                if (pickaxeBoostElement) pickaxeBoostElement.textContent = currentPickaxeData ? currentPickaxeData.boost : 1;
                if (goldMultiplierElement) goldMultiplierElement.textContent = currentPickaxeData ? currentPickaxeData.goldMultiplier : 1;
                if (usageGainElement) usageGainElement.textContent = currentPickaxeData ? currentPickaxeData.usageGain : 0.01;
            } catch (e) {
                console.error('更新镐子信息失败:', e);
            }
            
            // 更新增益显示
            const usageBoostElement = document.getElementById("usage-boost");
            const trophyBoostElement = document.getElementById("trophy-boost");
            const levelBoostElement = document.getElementById("level-boost");
            const alchemyBoostElement = document.getElementById("alchemy-boost");
            
            if (usageBoostElement) usageBoostElement.textContent = formatNumber(window.gameState.usageBoost);
            if (trophyBoostElement) trophyBoostElement.textContent = calculateTrophyBoost(window.gameState.trophies).toFixed(2);
            if (levelBoostElement) levelBoostElement.textContent = calculateLevelBoost(window.gameState.level).toFixed(2);
            if (alchemyBoostElement) alchemyBoostElement.textContent = formatNumber(window.gameState.alchemyBoost);
            
            // 更新兑换信息
            const convertInfoElement = document.getElementById("convert-info");
            if (convertInfoElement) {
                const trophiesFromGold = calculateTrophies(window.gameState.gold);
                convertInfoElement.textContent = `当前可兑换: ${formatNumber(trophiesFromGold)} 奖杯`;
            }
            
            // 更新增益列表
            try {
                updateBoostsList();
            } catch (e) {
                console.error('更新增益列表失败:', e);
            }
            
            // 更新资源列表
            try {
                updateResourcesList();
            } catch (e) {
                console.error('更新资源列表失败:', e);
            }
            
            // 更新商店
            try {
                updateShop();
            } catch (e) {
                console.error('更新商店失败:', e);
            }
        }

        // 更新增益列表
        function updateBoostsList() {
            const boostsList = document.getElementById("boosts-list");
            boostsList.innerHTML = "";
            
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            
            const boosts = [
                { name: "镐子增益", value: pickaxeBoost },
                { name: "使用增益", value: window.gameState.usageBoost },
                { name: "奖杯增益", value: calculateTrophyBoost(window.gameState.trophies).toFixed(2) },
                { name: "等级增益", value: calculateLevelBoost(window.gameState.level).toFixed(2) },
                { name: "炼药增益", value: window.gameState.alchemyBoost }
            ];
            
            boosts.forEach(boost => {
                const boostItem = document.createElement("div");
                boostItem.className = "boost-item";
                boostItem.innerHTML = `
                    <div>${boost.name}</div>
                    <div>${formatNumber(boost.value)}</div>
                `;
                boostsList.appendChild(boostItem);
            });
        }

        // 更新资源列表
        function updateResourcesList() {
            const resourcesList = document.getElementById("resources-list");
            resourcesList.innerHTML = "";
            
            Object.entries(window.gameState.resources).forEach(([resource, amount]) => {
                if (amount > 0) {
                    const resourceItem = document.createElement("div");
                    resourceItem.className = "resource-item";
                    resourceItem.innerHTML = `
                        <div>${resource}</div>
                        <div>${formatNumber(amount)}</div>
                    `;
                    resourcesList.appendChild(resourceItem);
                }
            });
        }

        // 更新商店
        function updateShop() {
            const shopItems = document.getElementById("shop-items");
            shopItems.innerHTML = "";
            
            const activeShop = document.querySelector(".shop-categories .category-btn.active").dataset.shop;
            const shopData = gameData.pickaxes[activeShop];
            
            if (shopData) {
                shopData.forEach(item => {
                    const shopItem = document.createElement("div");
                    shopItem.className = "shop-item";
                    
                    let costText = "";
                    let canBuy = true;
                    
                    if (item.cost.trophies) {
                        costText = `奖杯: ${item.cost.trophies}`;
                        if (window.gameState.trophies < item.cost.trophies) canBuy = false;
                    } else if (item.cost.fragments) {
                        costText = Object.entries(item.cost.fragments).map(([frag, amount]) => `${frag}: ${amount}`).join(", ");
                        if (item.cost.basePickaxe) {
                            costText += `, 需要: ${item.cost.basePickaxe}`;
                            if (window.gameState.pickaxes[item.cost.basePickaxe] < 1) canBuy = false;
                        } else if (item.cost.basePickaxes) {
                            costText += `, 需要: ${item.cost.basePickaxes.join(", ")}`;
                            for (const pick of item.cost.basePickaxes) {
                                if (window.gameState.pickaxes[pick] < 1) canBuy = false;
                            }
                        }
                        if (item.cost.usageBoost) {
                            costText += `, 使用增益: ${formatNumber(item.cost.usageBoost)}`;
                            if (window.gameState.usageBoost < item.cost.usageBoost) canBuy = false;
                        }
                        
                        for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                            if (frag.includes("镐")) {
                                // 如果是镐子，检查数量
                                if (window.gameState.pickaxes[frag] < amount) canBuy = false;
                            } else {
                                // 如果是资源，检查数量
                                if (window.gameState.resources[frag] < amount) canBuy = false;
                            }
                        }
                    }
                    
                    // 显示镐子数量
                    const pickaxeCount = item.boost ? `<span class="pickaxe-count">${window.gameState.pickaxes[item.name] || 0}</span>` : "";
                    const useButton = item.boost ? `<button class="pickaxe-use-btn ${window.gameState.currentPickaxe === item.name ? 'active' : ''}" data-pickaxe="${item.name}">${window.gameState.currentPickaxe === item.name ? '使用中' : '使用'}</button>` : "";
                    
                    shopItem.innerHTML = `
                        <div class="shop-item-header">
                            <div>${item.name} ${pickaxeCount} ${useButton}</div>
                            <div>${costText}</div>
                        </div>
                        ${item.boost ? `<div>增益: ${item.boost}, 金币倍率: ${item.goldMultiplier}, 使用增益增加: ${item.usageGain}</div>` : ""}
                        <button class="buy-btn" data-item="${item.name}" ${!canBuy ? 'disabled' : ''}>购买</button>
                    `;
                    
                    shopItems.appendChild(shopItem);
                });
            }
            
            // 添加购买按钮事件监听
            document.querySelectorAll(".buy-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const itemName = this.dataset.item;
                    buyItem(itemName);
                });
            });
            
            // 添加使用按钮事件监听
            document.querySelectorAll(".pickaxe-use-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const pickaxeName = this.dataset.pickaxe;
                    if (window.gameState.pickaxes[pickaxeName] >= 1) {
                          window.gameState.currentPickaxe = pickaxeName;
                        updateUI();
                    }
                });
            });
        }

        // 购买物品
        function buyItem(itemName) {
            try {
                // 优化查找逻辑，分别在不同商店中查找物品
                let item = null;
                for (const shopCategory in gameData.pickaxes) {
                    item = gameData.pickaxes[shopCategory].find(p => p.name === itemName);
                    if (item) break;
                }
                
                if (!item) return;
                
                // 检查是否满足购买条件
                let canBuy = true;
                
                if (item.cost.trophies) {
                    if (window.gameState.trophies < item.cost.trophies) canBuy = false;
                }
                
                if (item.cost.fragments) {
                    for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                        if (frag.includes("镐")) {
                            // 如果是镐子，检查数量
                            if (window.gameState.pickaxes[frag] < amount) canBuy = false;
                        } else {
                            // 如果是资源，检查数量
                            if (window.gameState.resources[frag] < amount) canBuy = false;
                        }
                    }
                    
                    if (item.cost.basePickaxe && window.gameState.pickaxes[item.cost.basePickaxe] < 1) canBuy = false;
                    
                    if (item.cost.basePickaxes) {
                        for (const pick of item.cost.basePickaxes) {
                            if (window.gameState.pickaxes[pick] < 1) canBuy = false;
                        }
                    }
                    
                    if (item.cost.usageBoost && window.gameState.usageBoost < item.cost.usageBoost) canBuy = false;
                }
                
                if (canBuy) {
                    // 扣除成本
                    if (item.cost.trophies) {
                        window.gameState.trophies -= item.cost.trophies;
                    }
                    
                    if (item.cost.fragments) {
                        for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                            if (frag.includes("镐")) {
                                // 如果是镐子，减少数量
                                window.gameState.pickaxes[frag] -= amount;
                            } else {
                                // 如果是资源，减少数量
                                window.gameState.resources[frag] -= amount;
                            }
                        }
                    }
                    
                    // 增加物品
                    if (item.boost) {
                        // 是镐子
                        window.gameState.pickaxes[item.name] = (window.gameState.pickaxes[item.name] || 0) + 1;
                    } else {
                        // 是物品
                        window.gameState.resources[item.name] = (window.gameState.resources[item.name] || 0) + 1;
                    }
                    
                    // 更新UI
                    updateUI();
                    // 保存游戏状态
                    saveGame();
                    // 显示成功提示
                    showSaveNotification();
                    
                    // 检查成就
                    try {
                        if (typeof checkAchievements === 'function') {
                            checkAchievements();
                            console.log('购买后成就检查已执行');
                        }
                    } catch (achievementError) {
                        console.error('检查成就失败:', achievementError);
                    }
                }
            } catch (e) {
                console.error('购买物品失败:', e);
                // 手动触发更新UI
                updateUI();
            }
        }

        // 浇树功能
        function waterTree() {
            try {
                // 检查是否在第二阶段
                if (window.gameState.gameStage < 2) {
                    alert("需要获得五行镐进入第二阶段才能浇树！");
                    return;
                }
                
                // 检查是否有水立方
                if ((window.gameState.resources && window.gameState.resources["水立方"] || 0) < 1) {
                    alert("水立方不足！");
                    return;
                }
                
                // 扣除水立方
                window.gameState.resources["水立方"] -= 1;
                
                // 增加树经验
                window.gameState.treeExp = (window.gameState.treeExp || 0) + 1;
                
                // 检查是否可以升级
                const expNeededForNextLevel = 10 * window.gameState.treeLevel;
                if (window.gameState.treeExp >= expNeededForNextLevel) {
                    window.gameState.treeLevel += 1;
                    window.gameState.treeExp -= expNeededForNextLevel;
                    
                    // 显示升级提示
                    if (document.body) {
                        const notification = document.createElement('div');
                        notification.textContent = `树升级! 等级 ${window.gameState.treeLevel}`;
                        notification.style.position = 'fixed';
                        notification.style.top = '50%';
                        notification.style.left = '50%';
                        notification.style.transform = 'translate(-50%, -50%)';
                        notification.style.backgroundColor = 'rgba(33, 150, 243, 0.8)';
                        notification.style.color = 'white';
                        notification.style.padding = '10px 20px';
                        notification.style.borderRadius = '5px';
                        notification.style.zIndex = '1000';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            try {
                                if (notification.parentNode === document.body) {
                                    document.body.removeChild(notification);
                                }
                            } catch (e) {}
                        }, 1500);
                    }
                }
                
                // 更新成就
                if (!window.gameState.achievements["浇树"]) {
                    window.gameState.achievements["浇树"] = true;
                    showAchievementNotification("浇树");
                }
                
                // 更新UI
                updateUI();
            } catch (e) {
                console.error('浇树失败:', e);
            }
        }
        
        // 显示成就通知
        function showAchievementNotification(achievementName) {
            try {
                if (document.body) {
                    const notification = document.createElement('div');
                    notification.textContent = `🎉 成就解锁: ${achievementName}`;
                    notification.style.position = 'fixed';
                    notification.style.top = '10%';
                    notification.style.right = '10%';
                    notification.style.backgroundColor = 'rgba(76, 175, 80, 0.9)';
                    notification.style.color = 'white';
                    notification.style.padding = '15px 20px';
                    notification.style.borderRadius = '8px';
                    notification.style.zIndex = '1000';
                    notification.style.fontSize = '16px';
                    notification.style.fontWeight = 'bold';
                    notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                    notification.style.animation = 'slideIn 0.5s ease-out';
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        try {
                            if (notification.parentNode === document.body) {
                                document.body.removeChild(notification);
                            }
                        } catch (e) {}
                    }, 3000);
                }
            } catch (e) {
                console.error('显示成就通知失败:', e);
            }
        }
        
        // 自动挖矿定时器
        let autoMiningInterval = null;
        
        // 切换自动挖矿
        function toggleAutoMining() {
            try {
                window.gameState.autoMiningEnabled = !window.gameState.autoMiningEnabled;
                
                // 更新按钮文本和样式
                const autoMiningToggle = document.getElementById("auto-mining-toggle");
                if (autoMiningToggle) {
                    autoMiningToggle.textContent = window.gameState.autoMiningEnabled ? "关闭自动挖矿" : "开启自动挖矿";
                    // 更新按钮样式
                    if (window.gameState.autoMiningEnabled) {
                        autoMiningToggle.style.backgroundColor = '#f44336'; // 红色表示开启状态
                    } else {
                        autoMiningToggle.style.backgroundColor = '#4CAF50'; // 绿色表示关闭状态
                    }
                }
                
                if (window.gameState.autoMiningEnabled) {
                    // 自动挖矿速度：(20*阶段)次每秒
                    const miningInterval = 1000 / (20 * (window.gameState.gameStage || 1));
                    autoMiningInterval = setInterval(() => {
                        mineBlock(true); // 传入参数表示自动挖矿
                    }, miningInterval);
                } else {
                    if (autoMiningInterval) {
                        clearInterval(autoMiningInterval);
                        autoMiningInterval = null;
                    }
                }
                
                updateUI();
            } catch (e) {
                console.error('切换自动挖矿失败:', e);
            }
        }
        
        // 检查并更新成就
        function checkAchievements() {
            try {
                const achievements = [
                    { id: "初入游戏", condition: true },
                    { id: "获得奖杯", condition: window.gameState.trophies > 0 },
                { id: "伤害一万", condition: window.gameState.totalDamage >= 1e4 && window.gameState.totalDamage < 1e8 },
                { id: "伤害一亿", condition: window.gameState.totalDamage >= 1e8 && window.gameState.totalDamage < 1e12 },
                { id: "伤害一万亿", condition: window.gameState.totalDamage >= 1e12 && window.gameState.totalDamage < 1e16 },
                { id: "伤害一兆", condition: window.gameState.totalDamage >= 1e16 && window.gameState.totalDamage < 1e20 },
                { id: "伤害一万兆", condition: window.gameState.totalDamage >= 1e20 },
                { id: "红蓝镐", condition: window.gameState.pickaxes && window.gameState.pickaxes["红蓝镐"] > 0 },
                { id: "只因你太美", condition: window.gameState.resources && window.gameState.resources["坤坤"] > 0 },
                { id: "五行镐", condition: window.gameState.pickaxes && window.gameState.pickaxes["五行镐"] > 0 },
                { id: "炼药", condition: window.gameState.alchemyBoost > 1 }
                ];
                
                achievements.forEach(ach => {
                    if (ach.condition && !window.gameState.achievements[ach.id]) {
                        window.gameState.achievements[ach.id] = true;
                        showAchievementNotification(ach.id);
                    }
                });
                
                // 检查是否获得五行镐，如果是则进入第二阶段
                if (window.gameState.pickaxes && window.gameState.pickaxes["五行镐"] > 0 && window.gameState.gameStage < 2) {
                    window.gameState.gameStage = 2;
                }
            } catch (e) {
                console.error('检查成就失败:', e);
            }
        }
        
        // 计算浇树增益
        function calculateTreeBoost() {
            return Math.pow(window.gameState.treeLevel || 1, 0.4);
        }
        
        // 计算总伤害（包含树增益）
        function calculateTotalDamage() {
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            const trophyBoost = calculateTrophyBoost(window.gameState.trophies);
            const levelBoost = calculateLevelBoost(window.gameState.level);
            
            // 基础伤害计算
            let totalDamage = pickaxeBoost * window.gameState.usageBoost * trophyBoost * levelBoost * window.gameState.alchemyBoost;
            
            // 第二阶段添加树增益
            if (window.gameState.gameStage >= 2) {
                totalDamage *= calculateTreeBoost();
            }
            
            return totalDamage;
        }
        
        // 挖掘方块
        function mineBlock(isAutoMining = false) {
            try {
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { 
                        gold: 0, 
                        trophies: 0, 
                        gameStage: 1, 
                        totalDamage: 0,
                        usageBoost: 0,
                        blockHp: {},
                        currentBlockCategory: 0,
                        currentBlockIndex: 0,
                        currentPickaxe: "木镐"
                    };
                }
                
                // 安全获取当前分类和索引
                const category = window.gameState.currentBlockCategory;
                const index = window.gameState.currentBlockIndex;
                
                // 验证数据结构
                if (!gameData || !gameData.blocks || !gameData.blocks[category] || !gameData.blocks[category][index]) {
                    console.error(`错误: 无效的方块数据 - 分类: ${category}, 索引: ${index}`);
                    return;
                }
                
                const currentBlock = gameData.blocks[category][index];
                
                // 初始化blockHp结构
                if (!window.gameState.blockHp) {
                    window.gameState.blockHp = {};
                }
                if (!window.gameState.blockHp[category]) {
                    window.gameState.blockHp[category] = [];
                }
                
                // 初始化当前方块血量
                if (window.gameState.blockHp[category][index] === undefined) {
                    window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                }
                
                // 优化镐子查找逻辑
                let currentPickaxeData = null;
                try {
                    if (gameData.pickaxes) {
                        for (const shopCategory in gameData.pickaxes) {
                            if (Array.isArray(gameData.pickaxes[shopCategory])) {
                                currentPickaxeData = gameData.pickaxes[shopCategory].find(p => p && p.name === window.gameState.currentPickaxe);
                                if (currentPickaxeData) break;
                            }
                        }
                    }
                } catch (pickaxeError) {
                    console.error('查找镐子失败:', pickaxeError);
                    // 使用默认镐子数据
                    currentPickaxeData = { boost: 1, goldMultiplier: 1, usageGain: 0.01 };
                }
                
                // 计算总伤害
                let totalDamage = 0;
                try {
                    totalDamage = calculateTotalDamage();
                    // 确保伤害至少为1
                    totalDamage = Math.max(1, totalDamage || 1);
                } catch (damageError) {
                    console.error('计算伤害失败:', damageError);
                    totalDamage = 1; // 默认最小伤害
                }
                
                // 累计总伤害
                window.gameState.totalDamage = (window.gameState.totalDamage || 0) + totalDamage;
                
                // 显示伤害数字（仅手动挖矿时显示）
                if (!isAutoMining) {
                    try {
                        showDamagePopup(totalDamage);
                    } catch (popupError) {
                        console.error('显示伤害弹窗失败:', popupError);
                    }
                }
                
                // 安全更新方块血量
                try {
                    window.gameState.blockHp[category][index] -= totalDamage;
                    // 确保血量不会低于0
                    window.gameState.blockHp[category][index] = Math.max(0, window.gameState.blockHp[category][index]);
                } catch (hpError) {
                    console.error('更新方块血量失败:', hpError);
                }
                
                // 检查方块是否被挖掉
                if (window.gameState.blockHp[category][index] <= 0) {
                    try {
                        // 计算获得的金币和经验
                        const baseGold = currentBlock.baseGold || 10;
                        const goldMultiplier = currentPickaxeData?.goldMultiplier || 1;
                        
                        const goldGained = baseGold * goldMultiplier;
                        const expGained = goldGained;
                        
                        // 更新游戏状态
                        window.gameState.gold = (window.gameState.gold || 0) + goldGained;
                        window.gameState.exp = (window.gameState.exp || 0) + expGained;
                        
                        // 检查特殊掉落
                        if (currentBlock.special && Math.random() < currentBlock.special.chance) {
                            // 初始化resources对象
                            if (!window.gameState.resources) {
                                window.gameState.resources = {};
                            }
                            const itemName = currentBlock.special.item;
                            if (itemName) {
                                window.gameState.resources[itemName] = (window.gameState.resources[itemName] || 0) + 1;
                            }
                        }
                        
                        // 重置方块血量
                        window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                        
                        // 检查升级
                        try {
                            checkLevelUp();
                        } catch (levelError) {
                            console.error('检查升级失败:', levelError);
                        }
                        
                        // 检查成就
                        try {
                            if (typeof checkAchievements === 'function') {
                                checkAchievements();
                                console.log('成就检查已执行');
                            }
                        } catch (achievementError) {
                            console.error('检查成就失败:', achievementError);
                        }
                        
                        // 保存游戏
                        try {
                            saveGame();
                        } catch (saveError) {
                            console.error('保存游戏失败:', saveError);
                        }
                    } catch (rewardError) {
                        console.error('处理奖励失败:', rewardError);
                        // 重置方块血量，确保游戏能继续进行
                        window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                    }
                }
                
                // 更新UI
                try {
                    updateUI();
                } catch (uiError) {
                    console.error('更新UI失败:', uiError);
                }
            } catch (e) {
                console.error('挖掘方块主函数失败:', e);
            }
        }

        // 显示伤害数字
        function showDamagePopup(damage) {
            try {
                const blockDisplay = document.getElementById("block-display");
                if (!blockDisplay) return;
                
                const popup = document.createElement("div");
                popup.className = "damage-popup";
                popup.textContent = `-${damage.toFixed(2)}`;
                popup.style.left = `${Math.random() * 60 + 20}%`;
                blockDisplay.appendChild(popup);
                
                setTimeout(() => {
                    try {
                        popup.remove();
                    } catch (e) {
                        console.error('移除伤害弹窗失败:', e);
                    }
                }, 1000);
            } catch (e) {
                console.error('显示伤害数字失败:', e);
            }
        }

        // 检查升级
        function checkLevelUp() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 安全获取当前经验和等级
                const currentExp = window.gameState.exp || 0;
                const currentLevel = window.gameState.level || 1;
                
                // 循环检查是否可以升级
                let updatedLevel = currentLevel;
                let remainingExp = currentExp;
                let leveledUp = false;
                
                // 防止无限循环，设置最大升级次数限制
                const maxLevelAttempts = 100;
                let attempts = 0;
                
                while (attempts < maxLevelAttempts) {
                    attempts++;
                    
                    try {
                        const expNeeded = getExpNeeded(updatedLevel);
                        
                        // 确保expNeeded是有效数字
                        if (typeof expNeeded !== 'number' || isNaN(expNeeded) || expNeeded <= 0) {
                            console.error('无效的经验需求值:', expNeeded);
                            break;
                        }
                        
                        if (remainingExp < expNeeded) {
                            break;
                        }
                        
                        // 足够升级
                        remainingExp -= expNeeded;
                        updatedLevel += 1;
                        leveledUp = true;
                    } catch (levelCalcError) {
                        console.error('计算升级经验需求失败:', levelCalcError);
                        break;
                    }
                }
                
                // 只有实际升级时才更新状态
                if (leveledUp) {
                    window.gameState.level = updatedLevel;
                    window.gameState.exp = remainingExp;
                    
                    // 检查成就
                    try {
                        if (typeof checkAchievements === 'function') {
                            checkAchievements();
                            console.log('升级后成就检查已执行');
                        }
                    } catch (achievementError) {
                        console.error('检查成就失败:', achievementError);
                    }
                    
                    // 尝试创建简单的升级提示（如果body存在）
                    try {
                        if (document.body) {
                            const notification = document.createElement('div');
                            notification.textContent = `升级! 等级 ${updatedLevel}`;
                            notification.style.position = 'fixed';
                            notification.style.top = '50%';
                            notification.style.left = '50%';
                            notification.style.transform = 'translate(-50%, -50%)';
                            notification.style.backgroundColor = 'rgba(0, 200, 0, 0.8)';
                            notification.style.color = 'white';
                            notification.style.padding = '10px 20px';
                            notification.style.borderRadius = '5px';
                            notification.style.zIndex = '1000';
                            
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                try {
                                    if (notification.parentNode === document.body) {
                                        document.body.removeChild(notification);
                                    }
                                } catch (removeError) {
                                    // 静默失败
                                }
                            }, 1500);
                        }
                    } catch (popupError) {
                        // 静默失败，不影响游戏逻辑
                    }
                }
            } catch (e) {
                console.error('检查升级失败:', e);
            }
        }

        // 更新游戏阶段显示 - 只显示数字
        function updateGameStageDisplay() {
            try {
                const stageElement = document.getElementById('game-stage');
                if (stageElement && window.gameState) {
                    const currentStage = window.gameState.gameStage || 1;
                    // 根据要求显示阶段
                    if (currentStage === 1) {
                        stageElement.textContent = '当前阶段：第一阶段';
                    } else if (currentStage === 2) {
                        stageElement.textContent = '当前阶段：第二阶段';
                    } else {
                        stageElement.textContent = `当前阶段：第${currentStage}阶段`;
                    }
                }
            } catch (e) {
                console.error('更新游戏阶段显示失败:', e);
            }
        }
        
        // 浇树功能 - 使用树系统的逻辑
        function waterTree() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 检查是否到达阶段2
                if (window.gameState.gameStage < 2) {
                    alert('需要到达第二阶段才能解锁浇树系统！');
                    return;
                }
                
                // 初始化resources对象
                if (!window.gameState.resources) {
                    window.gameState.resources = {};
                }
                
                // 检查水立方数量
                if ((window.gameState.resources["水立方"] || 0) < 1) {
                    alert('水立方不足！');
                    return;
                }
                
                // 消耗水立方
                window.gameState.resources["水立方"] -= 1;
                
                // 初始化树系统数据
                if (typeof window.gameState.treeLevel !== 'number') {
                    window.gameState.treeLevel = 1;
                }
                if (typeof window.gameState.treeExp !== 'number') {
                    window.gameState.treeExp = 0;
                }
                
                // 增加树经验
                window.gameState.treeExp += 5;
                
                // 检查升级
                const treeExpNeeded = window.gameState.treeLevel * 10;
                while (window.gameState.treeExp >= treeExpNeeded) {
                    window.gameState.treeExp -= treeExpNeeded;
                    window.gameState.treeLevel += 1;
                }
                
                // 保存游戏
                saveGame();
                
                // 更新UI
                updateCustomUI();
                
                // 检查成就
                try {
                    if (typeof checkAchievements === 'function') {
                        checkAchievements();
                        console.log('浇树后成就检查已执行');
                    }
                } catch (achievementError) {
                    console.error('检查成就失败:', achievementError);
                }
                
                // 显示浇树结果
                const resultsElement = document.getElementById('water-tree-results');
                if (resultsElement) {
                    const currentExpNeeded = window.gameState.treeLevel * 10;
                    resultsElement.textContent = `成功浇树！消耗1个水立方，树经验增加到${window.gameState.treeExp}/${currentExpNeeded}，树等级：${window.gameState.treeLevel}`;
                }
            } catch (e) {
                console.error('浇树失败:', e);
                alert('浇树失败，请重试');
            }
        }
        
        // 更新树木UI - 树系统版本
        function updateTreeUI() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 更新浇树区域的树系统UI
                const treeLevelElement = document.getElementById('tree-level');
                const treeExpElement = document.getElementById('tree-exp');
                const treeExpNeededElement = document.getElementById('tree-exp-needed');
                const treeExpBarElement = document.getElementById('tree-exp-bar');
                
                if (treeLevelElement && treeExpElement && treeExpNeededElement && treeExpBarElement) {
                    const treeLevel = window.gameState.treeLevel || 1;
                    const treeExp = window.gameState.treeExp || 0;
                    const treeExpNeeded = treeLevel * 10;
                    const expPercentage = (treeExp / treeExpNeeded) * 100;
                    
                    treeLevelElement.textContent = treeLevel;
                    treeExpElement.textContent = treeExp;
                    treeExpNeededElement.textContent = treeExpNeeded;
                    treeExpBarElement.style.width = `${expPercentage}%`;
                }
                
                // 更新浇树按钮状态
                const waterTreeBtn = document.getElementById('water-tree-btn');
                if (waterTreeBtn) {
                    if (!window.gameState || window.gameState.gameStage < 2) {
                        waterTreeBtn.disabled = true;
                        waterTreeBtn.textContent = '到达阶段2解锁浇树系统';
                    } else {
                        waterTreeBtn.disabled = false;
                        waterTreeBtn.textContent = '浇树 (消耗1个水立方)';
                    }
                }
            } catch (e) {
                console.error('更新树木UI失败:', e);
            }
        }
        
        // 自定义的UI更新函数，避免循环引用
        function updateCustomUI() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 更新游戏阶段显示
                updateGameStageDisplay();
                
                // 总是更新树木UI（即使没有treeData）
                updateTreeUI();
                
                // 更新兑换信息显示
                const convertInfoElement = document.getElementById('convert-info');
                if (convertInfoElement && window.gameState.gold !== undefined) {
                    const currentGold = window.gameState.gold;
                    let trophiesAvailable = 0;
                    if (currentGold >= 100) {
                        trophiesAvailable = calculateTrophies(currentGold);
                    }
                    convertInfoElement.textContent = `当前可兑换: ${trophiesAvailable} 奖杯`;
                }
            } catch (e) {
                console.error('更新自定义UI失败:', e);
            }
        }
        
        // 确保gameState存在
        if (!window.gameState) {
            window.gameState = {
                gold: 0,
                trophies: 0,
                gameStage: 1
            };
        }
        
        // 页面加载完成后初始化更新自定义UI
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟一点时间确保DOM完全加载
            setTimeout(updateCustomUI, 100);
        });
        
        // 兑换金币为奖杯 - 修复兑换逻辑
        function convertGoldToTrophies() {
            console.log('兑换函数开始执行');
            
            // 检查calculateTrophies函数是否存在
            if (typeof calculateTrophies !== 'function') {
                console.error('calculateTrophies函数未定义');
                alert('兑换功能异常，请刷新页面');
                return;
            }
            
            // 检查updateUI函数是否存在
            if (typeof updateUI !== 'function') {
                console.error('updateUI函数未定义');
                alert('兑换功能异常，请刷新页面');
                return;
            }
            
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    console.error('游戏状态异常，gameState不存在');
                    alert('游戏状态异常，请刷新页面');
                    return;
                }
                
                // 初始化必要的游戏状态属性
                if (typeof window.gameState.gold === 'undefined') {
                    window.gameState.gold = 0;
                    console.warn('金币属性不存在，已初始化');
                }
                
                if (typeof window.gameState.trophies === 'undefined') {
                    window.gameState.trophies = 0;
                    console.warn('奖杯属性不存在，已初始化');
                }
                
                // 确保金币为数字类型
                if (typeof window.gameState.gold !== 'number') {
                    window.gameState.gold = parseFloat(window.gameState.gold) || 0;
                    console.warn('金币类型异常，已转换为数字');
                }
                
                // 确保奖杯为数字类型
                if (typeof window.gameState.trophies !== 'number') {
                    window.gameState.trophies = parseFloat(window.gameState.trophies) || 0;
                    console.warn('奖杯类型异常，已转换为数字');
                }
                
                const currentGold = window.gameState.gold;
                console.log(`当前金币: ${currentGold} (类型: ${typeof currentGold})`);
                
                // 检查金币是否足够
                if (currentGold < 100) {
                    console.log('金币不足100，无法兑换奖杯');
                    alert('金币不足100，无法兑换奖杯');
                    return;
                }
                
                // 计算可兑换的奖杯数量
                const trophiesFromGold = calculateTrophies(currentGold);
                console.log(`兑换计算：${currentGold}金币可兑换${trophiesFromGold}奖杯`);
                
                if (trophiesFromGold > 0) {
                    // 记录兑换前状态
                    console.log(`兑换前 - 奖杯: ${window.gameState.trophies}, 金币: ${window.gameState.gold}`);
                    
                    // 执行兑换
                    window.gameState.trophies += trophiesFromGold;
                    window.gameState.gold = 0;
                    
                    // 记录兑换后状态
                    console.log(`兑换后 - 奖杯: ${window.gameState.trophies}, 金币: ${window.gameState.gold}`);
                    
                    // 检查成就
                    if (typeof checkAchievements === 'function') {
                        console.log('调用checkAchievements检查成就');
                        checkAchievements();
                    } else {
                        console.warn('checkAchievements函数未定义');
                    }
                    
                    // 强制更新UI
                    console.log('执行updateUI更新所有显示');
                    updateUI();
                    
                    // 更新自定义UI
                    if (typeof updateCustomUI === 'function') {
                        console.log('调用updateCustomUI');
                        updateCustomUI();
                    } else {
                        console.warn('updateCustomUI函数未定义');
                    }
                    
                    // 保存游戏状态
                    if (typeof saveGame === 'function') {
                        try {
                            console.log('调用saveGame保存状态');
                            saveGame();
                        } catch (saveError) {
                            console.warn('保存游戏失败:', saveError);
                        }
                    } else {
                        console.warn('saveGame函数未定义');
                    }
                    
                    console.log('兑换完成');
                    alert(`兑换成功！获得 ${trophiesFromGold} 奖杯`);
                } else {
                    console.log('计算结果为0奖杯，不执行兑换');
                    alert('无法兑换到奖杯，请确保金币足够');
                }
            } catch (e) {
                console.error('兑换过程中发生错误:', e);
                console.error('兑换金币为奖杯失败:', e.stack || e);
                alert(`兑换失败: ${e.message || '未知错误'}`);
            } finally {
                console.log('兑换函数执行完毕');
            }
        }

        // 一键换取炼药价值
        function convertToAlchemyValue() {
            try {
                let totalValue = 0;
                let convertedItems = [];
                
                // 安全检查游戏数据
                if (!gameData || !gameData.alchemyValues || typeof gameData.alchemyValues !== 'object') {
                    throw new Error('无效的炼药价值数据');
                }
                
                // 确保resources对象存在
                if (!gameState.resources) {
                    gameState.resources = {};
                }
                
                // 计算所有可转换物品的价值
                for (const [item, value] of Object.entries(gameData.alchemyValues)) {
                    try {
                        const itemCount = gameState.resources[item] || 0;
                        if (itemCount > 0) {
                            const numericValue = Number(value);
                            if (isNaN(numericValue) || numericValue <= 0) {
                                console.warn(`跳过无效价值物品: ${item}, 价值: ${value}`);
                                continue;
                            }
                            
                            const itemValue = itemCount * numericValue;
                            totalValue += itemValue;
                            convertedItems.push(`${item}: ${itemCount}个`);
                            gameState.resources[item] = 0;
                        }
                    } catch (itemError) {
                        console.error(`处理物品 ${item} 时出错:`, itemError);
                        // 跳过出错的物品，继续处理其他物品
                    }
                }
                
                if (totalValue > 0) {
                    // 安全更新炼药价值
                    gameState.alchemyValue = (gameState.alchemyValue || 0) + totalValue;
                    
                    // 尝试更新UI
                    try {
                        updateUI();
                    } catch (uiError) {
                        console.error('更新UI失败:', uiError);
                    }
                }
                
                // 显示转换结果
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    if (totalValue > 0) {
                        resultsElement.innerHTML = `
                            <div>成功转换以下物品:</div>
                            <div>${convertedItems.join(', ')}</div>
                            <div>共获得 ${formatNumber(totalValue)} 炼药价值</div>
                        `;
                    } else {
                        resultsElement.innerHTML = "没有可转换的物品";
                    }
                }
            } catch (e) {
                console.error('转换炼药价值失败:', e);
                // 安全显示错误信息
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = "转换过程中发生错误，请重试";
                }
            }
        }

        // 炼药
        function performAlchemy() {
            try {
                // 获取并验证输入参数
                const valueInputElement = document.getElementById("alchemy-value-input");
                const timesInputElement = document.getElementById("alchemy-times");
                
                if (!valueInputElement || !timesInputElement) {
                    throw new Error('缺少必要的输入元素');
                }
                
                // 安全解析输入值
                let valuePerTime = Math.max(1, Math.floor(Number(valueInputElement.value) || 1));
                let times = Math.max(1, Math.min(10000, Math.floor(Number(timesInputElement.value) || 1)));
                
                // 验证参数有效性
                if (valuePerTime < 1 || times < 1 || times > 10000) {
                    alert("请输入有效的炼药参数！单次价值和次数必须为1-10000的整数。");
                    return;
                }
                
                const currentAlchemyValue = gameState.alchemyValue || 0;
                const totalValueNeeded = valuePerTime * times;
                
                // 如果当前拥有的炼药价值小于单次价值，无法炼药
                if (currentAlchemyValue < valuePerTime) {
                    alert(`炼药价值不足！当前炼药价值: ${formatNumber(currentAlchemyValue)}, 单次炼药需要: ${formatNumber(valuePerTime)}`);
                    return;
                }
                
                // 如果炼药总价值不足，只调整次数
                let adjustedTotalValue = totalValueNeeded;
                if (currentAlchemyValue < totalValueNeeded) {
                    // 计算最大可炼药次数
                    times = Math.floor(currentAlchemyValue / valuePerTime);
                    timesInputElement.value = times;
                    // 更新需要的总价值
                    adjustedTotalValue = valuePerTime * times;
                }
                
                // 扣除炼药价值
                gameState.alchemyValue = (gameState.alchemyValue || 0) - adjustedTotalValue;
                
                // 初始化统计变量
                let exploded = 0;
                let gained1 = 0;
                let gained10 = 0;
                let gained100 = 0;
                let totalGained = 0;
                
                // 确保alchemyBoost存在且有效
                const currentAlchemyBoost = Math.max(1, gameState.alchemyBoost || 1);
                
                // 执行炼药逻辑
                for (let i = 0; i < times; i++) {
                    try {
                        // 计算概率，确保结果有效
                        let explodeChance = 0.5 / Math.pow(valuePerTime, 0.4);
                        explodeChance = Math.max(0.01, Math.min(0.99, explodeChance)); // 限制概率范围
                        
                        let gain1Chance = 0;
                        let gain10Chance = 0;
                        let gain100Chance = 0;
                        
                        if (valuePerTime < 100) {
                            gain1Chance = 0.4 * Math.pow(currentAlchemyBoost, 0.1);
                            gain10Chance = 1 - explodeChance - gain1Chance;
                        } else {
                            gain1Chance = 0.4 / Math.pow(currentAlchemyBoost, 0.6);
                            gain10Chance = 0.4 * Math.pow(valuePerTime / 100, 0.4);
                            gain10Chance = Math.min(0.5, gain10Chance);
                            gain100Chance = 1 - explodeChance - gain1Chance - gain10Chance;
                        }
                        
                        // 确保概率有效
                        gain1Chance = Math.max(0, Math.min(1 - explodeChance, gain1Chance));
                        gain10Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance, gain10Chance));
                        gain100Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance - gain10Chance, gain100Chance));
                        
                        // 归一化概率，确保总和为1
                        const totalProbability = explodeChance + gain1Chance + gain10Chance + gain100Chance;
                        if (totalProbability > 0) {
                            explodeChance /= totalProbability;
                            gain1Chance /= totalProbability;
                            gain10Chance /= totalProbability;
                            gain100Chance /= totalProbability;
                        }
                        
                        const rand = Math.random();
                        
                        if (rand < explodeChance) {
                            exploded++;
                        } else if (rand < explodeChance + gain1Chance) {
                            gained1++;
                            totalGained += 1;
                        } else if (rand < explodeChance + gain1Chance + gain10Chance) {
                            gained10++;
                            totalGained += 10;
                        } else {
                            gained100++;
                            totalGained += 100;
                        }
                    } catch (iterationError) {
                        console.error(`炼药第 ${i+1} 次出错:`, iterationError);
                        // 出错时视为炸锅
                        exploded++;
                    }
                }
                
                // 更新炼药增益
                gameState.alchemyBoost = currentAlchemyBoost + totalGained;
                
                // 计算平均值
                const avgPerTime = times > 0 ? totalGained / times : 0;
                const avgPerValue = totalValueNeeded > 0 ? totalGained / totalValueNeeded : 0;
                
                // 显示结果
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = `
                        <div>本次共消耗 ${formatNumber(totalValueNeeded)} 炼药价值，炼药 ${times} 次</div>
                        <div>炸锅 ${exploded} 次，获得1炼药增益 ${gained1} 次</div>
                        <div>获得10炼药增益 ${gained10} 次，获得100炼药增益 ${gained100} 次</div>
                        <div>共获得 ${formatNumber(totalGained)} 炼药增益</div>
                        <div>平均每次炼药获得 ${isFinite(avgPerTime) ? avgPerTime.toFixed(2) : '0.00'} 炼药增益</div>
                        <div>平均每炼药值获得 ${isFinite(avgPerValue) ? avgPerValue.toFixed(4) : '0.0000'} 炼药增益</div>
                    `;
                }
                
                // 尝试更新UI
                try {
                    updateUI();
                } catch (uiError) {
                    console.error('更新UI失败:', uiError);
                }
            } catch (e) {
                console.error('炼药失败:', e);
                // 安全显示错误信息
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = "炼药过程中发生错误，请重试";
                }
            }
        }

        // 初始化游戏状态到默认值
        function initGameState() {
            window.gameState = {
                level: 0,
                exp: 0,
                gold: 0,
                trophies: 0,
                currentBlockCategory: "main1",
                currentBlockIndex: 0,
                currentPickaxe: "木镐",
                usageBoost: 1,
                alchemyBoost: 1,
                alchemyValue: 0,
                // 新增：树系统
                treeLevel: 1,
                treeExp: 0,
                // 新增：自动挖矿
                autoMiningEnabled: false,
                // 新增：总伤害统计
                totalDamage: 0,
                // 新增：游戏阶段（1或2）
                gameStage: 1,
                // 新增：成就系统
                achievements: {
                    "初入游戏": true,
                    "获得奖杯": false,
                    "伤害一万": false,
                    "伤害一亿": false,
                    "伤害一万亿": false,
                    "伤害一兆": false,
                    "伤害一万兆": false,
                    "红蓝镐": false,
                    "只因你太美": false,
                    "五行镐": false,
                    "炼药": false,
                    "浇树": false
                },
                resources: {
                    "红曜石碎片": 0,
                    "蓝曜石碎片": 0,
                    "基岩碎片": 0,
                    "木核心": 0,
                    "土核心": 0,
                    "水立方": 0,
                    "火立方": 0,
                    "金立方": 0,
                    "紫水晶": 0,
                    "下界之星": 0,
                    "坤坤": 0,
                    "红曜石": 0,
                    "蓝曜石": 0,
                    "五行转换器": 0
                },
                pickaxes: {
                    "木镐": 1,
                    "石镐": 0,
                    "铁镐": 0,
                    "金镐": 0,
                    "钻石镐": 0,
                    "下届合金镐": 0,
                    "黑曜石镐": 0,
                    "红曜石镐": 0,
                    "蓝曜石镐": 0,
                    "红蓝镐": 0,
                    "基岩镐": 0,
                    "木核心镐": 0,
                    "土核心镐": 0,
                    "水立方镐": 0,
                    "火立方镐": 0,
                    "金立方镐": 0,
                    "五行镐": 0,
                    "紫水晶镐Ⅰ": 0,
                    "紫水晶镐Ⅱ": 0,
                    "紫水晶镐Ⅲ": 0,
                    "紫水晶镐Ⅳ": 0,
                    "紫水晶镐Ⅴ": 0
                },
                blockHp: {}
            };
        }
        
        // 初始化游戏
        function initGame() {
            // 加载保存的游戏状态，如果失败将使用默认状态
            loadGame();
            
            // 初始化方块血量（如果不存在）
            if (!gameState.blockHp) {
                gameState.blockHp = {};
            }
            initBlockHp();
            
            // 确保游戏状态中的所有必要属性都存在
            if (!window.gameState.alchemyValue) window.gameState.alchemyValue = 0;
            if (!window.gameState.alchemyBoost) window.gameState.alchemyBoost = 1;
            if (!window.gameState.resources) window.gameState.resources = {};
            if (!window.gameState.pickaxes) window.gameState.pickaxes = {};
            if (!window.gameState.usageBoost) window.gameState.usageBoost = 1;
            if (!window.gameState.treeLevel) window.gameState.treeLevel = 1;
            if (!window.gameState.treeExp) window.gameState.treeExp = 0;
            if (!window.gameState.autoMiningEnabled) window.gameState.autoMiningEnabled = false;
            if (!window.gameState.totalDamage) window.gameState.totalDamage = 0;
            if (!window.gameState.gameStage) window.gameState.gameStage = 1;
            
            // 确保成就系统存在且结构正确
            if (!window.gameState.achievements) {
                window.gameState.achievements = {
                    "初入游戏": true,
                    "获得奖杯": false,
                    "伤害一万": false,
                    "伤害一亿": false,
                    "伤害一万亿": false,
                    "伤害一兆": false,
                    "伤害一万兆": false,
                    "红蓝镐": false,
                    "只因你太美": false,
                    "五行镐": false,
                    "炼药": false,
                    "浇树": false
                };
            }
            
            // 确保初入游戏成就始终是解锁状态
            window.gameState.achievements["初入游戏"] = true;
            
            // 设置初始经验需求
            document.getElementById("exp-needed").textContent = getExpNeeded(0);
            
            // 添加事件监听器
            try {
                document.getElementById("block-display").addEventListener("click", mineBlock);
            } catch (e) {
                console.error('添加方块点击事件监听失败:', e);
            }
            
            try {
                document.getElementById("prev-block").addEventListener("click", function() {
                    try {
                        const blockCount = gameData.blocks[gameState.currentBlockCategory].length;
                        gameState.currentBlockIndex = (gameState.currentBlockIndex - 1 + blockCount) % blockCount;
                        updateUI();
                    } catch (e) {
                        console.error('切换到上一个方块失败:', e);
                    }
                });
                
                document.getElementById("next-block").addEventListener("click", function() {
                    try {
                        const blockCount = gameData.blocks[gameState.currentBlockCategory].length;
                        gameState.currentBlockIndex = (gameState.currentBlockIndex + 1) % blockCount;
                        updateUI();
                    } catch (e) {
                        console.error('切换到下一个方块失败:', e);
                    }
                });
            } catch (e) {
                console.error('添加方块切换事件监听失败:', e);
            }
            
            // 分类切换
            try {
                document.querySelectorAll(".block-category .category-btn").forEach(button => {
                    button.addEventListener("click", function() {
                        document.querySelectorAll(".block-category .category-btn").forEach(btn => btn.classList.remove("active"));
                        this.classList.add("active");
                        gameState.currentBlockCategory = this.dataset.category;
                        gameState.currentBlockIndex = 0;
                        updateUI();
                    });
                });
            } catch (e) {
                console.error('添加分类切换事件监听失败:', e);
            }
            
            // 标签切换
            try {
                document.querySelectorAll(".tab-btn").forEach(button => {
                    button.addEventListener("click", function() {
                        try {
                            document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
                            document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
                            
                            this.classList.add("active");
                            const tabContent = document.getElementById(`${this.dataset.tab}-tab`);
                            if (tabContent) {
                                tabContent.classList.add("active");
                            }
                        } catch (e) {
                            console.error('切换标签失败:', e);
                        }
                    });
                });
            } catch (e) {
                console.error('添加标签切换事件监听失败:', e);
            }
            
            // 商店分类切换
            try {
                document.querySelectorAll(".shop-categories .category-btn").forEach(button => {
                    button.addEventListener("click", function() {
                        document.querySelectorAll(".shop-categories .category-btn").forEach(btn => btn.classList.remove("active"));
                        this.classList.add("active");
                        updateShop();
                    });
                });
            } catch (e) {
                console.error('添加商店分类切换事件监听失败:', e);
            }
            
            // 添加自动挖矿切换按钮事件
            try {
                const autoMiningToggle = document.getElementById("auto-mining-toggle");
                if (autoMiningToggle) {
                    autoMiningToggle.addEventListener("click", toggleAutoMining);
                }
                
                // 添加浇树按钮事件
                const waterTreeBtn = document.getElementById("water-tree-btn");
                if (waterTreeBtn) {
                    waterTreeBtn.addEventListener("click", waterTree);
                }
            } catch (e) {
                console.error('添加按钮事件监听失败:', e);
            }
            
            // 检查是否进入第二阶段（拥有五行镐）
            if (window.gameState.pickaxes && window.gameState.pickaxes["五行镐"] && window.gameState.gameStage === 1) {
                window.gameState.gameStage = 2;
            }
            
            // 根据游戏阶段动态显示UI标签
            updateTabsVisibility();
            
            // 炼药按钮
            try {
                document.getElementById("alchemy-btn").addEventListener("click", performAlchemy);
            } catch (e) {
                console.error('添加炼药按钮事件监听失败:', e);
            }
            
            // 兑换按钮
            try {
                const convertBtn = document.getElementById("convert-btn");
                if (convertBtn) {
                    // 移除可能存在的旧事件监听器
                    convertBtn.removeEventListener("click", convertGoldToTrophies);
                    // 添加新的事件监听器
                    convertBtn.addEventListener("click", function() {
                        console.log('兑换按钮被点击');
                        convertGoldToTrophies();
                    });
                    console.log('兑换按钮事件监听添加成功');
                } else {
                    console.error('未找到兑换按钮元素');
                }
            } catch (e) {
                console.error('添加兑换按钮事件监听失败:', e.stack || e);
            }
            
            // 一键换取炼药价值按钮
            try {
                document.getElementById("convert-alchemy-btn").addEventListener("click", convertToAlchemyValue);
            } catch (e) {
                console.error('添加一键换取炼药价值按钮事件监听失败:', e);
            }
            
            // 初始UI更新
            updateUI();
            
            // 设置自动保存
            try {
                setInterval(saveGame, 5000);
            } catch (e) {
                console.error('设置自动保存失败:', e);
            }
        }
        
        // 根据游戏阶段更新标签可见性
        function updateTabsVisibility() {
            try {
                const tabsContainer = document.querySelector('.tabs');
                if (tabsContainer) {
                    const boostBtn = tabsContainer.querySelector('[data-tab="boosts"]');
                    const resourcesBtn = tabsContainer.querySelector('[data-tab="resources"]');
                    const shopBtn = tabsContainer.querySelector('[data-tab="shop"]');
                    const alchemyBtn = tabsContainer.querySelector('[data-tab="alchemy"]');
                    const achievementsBtn = tabsContainer.querySelector('[data-tab="achievements"]');
                    const waterTreeBtn = tabsContainer.querySelector('[data-tab="water-tree"]');
                    
                    // 确保所有必要的按钮都存在
                    if (boostBtn && resourcesBtn && shopBtn && alchemyBtn && achievementsBtn && waterTreeBtn) {
                        // 清空容器
                        tabsContainer.innerHTML = '';
                        
                        // 添加基础标签（阶段1和阶段2都显示）
                        tabsContainer.appendChild(boostBtn);
                        tabsContainer.appendChild(resourcesBtn);
                        tabsContainer.appendChild(shopBtn);
                        tabsContainer.appendChild(alchemyBtn);
                        tabsContainer.appendChild(achievementsBtn);
                        
                        // 只有在阶段2时才添加浇树标签
                        if (window.gameState && window.gameState.gameStage >= 2) {
                            tabsContainer.appendChild(waterTreeBtn);
                        }
                    }
                }
            } catch (e) {
                console.error('更新标签可见性失败:', e);
            }
            
            // 更新当前阶段显示
            updateGameStageDisplay();
            
            // 开始自动挖矿定时器（如果启用）
            if (window.gameState && window.gameState.autoMiningEnabled) {
                startAutoMining();
            }
        }

        // 启动游戏
        window.onload = initGame;
    </script>
</body>
</html>