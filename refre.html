<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爽玩</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
            * {
                font-family: 'Noto Sans SC', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
        </style>
    <style>
        :root {
            --primary: #ff6b6b;
            --primary-dark: #ee5a52;
            --primary-light: #ff9e9e;
            --secondary: #4ecdc4;
            --secondary-dark: #3db8af;
            --tertiary: #45b7d1;
            --background: #0f172a;
            --background-light: #1e293b;
            --background-lighter: #334155;
            --card-bg: rgba(30, 41, 59, 0.6);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-muted: #cbd5e1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.3);
            --glow: 0 0 15px rgba(255, 107, 107, 0.5);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-image: url('13676b7bd907e535624b089a1ba91b62.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            max-width: 1300px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
        }
        
        .game-area, .info-area {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }
        
        .game-area::before, .info-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--tertiary));
            border-radius: 20px 20px 0 0;
        }
        
        .info-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .game-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #ff9a9e, #fad0c4, #fbc2eb, #84fab0, #8fd3f4, #ffd83d, #a18cd1, #fbc2eb, #a6c1ee, #fecfef, #f5d300, #ff8042);
            background-size: 800% 800%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: gradient-animation 3s linear infinite;
            /* 确保浏览器兼容性 */
            -webkit-animation: gradient-animation 3s linear infinite;
            -moz-animation: gradient-animation 3s linear infinite;
            -o-animation: gradient-animation 3s linear infinite;
            display: inline-block; /* 确保渐变效果正确应用 */
        }
        
        .game-stage {
            font-size: 16px;
            color: #4ecdc4;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .water-tree-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }
        
        .tree-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }
        
        .tree-status div {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .water-tree-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #4ECDC4, #45B7D1);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }
        
        .water-tree-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(78, 205, 196, 0.4);
        }
        
        /* 浇树按钮横向排布 */
        .water-tree-buttons {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .water-tree-results {
            padding: 15px;
            background-color: var(--card-bg-dark);
            border-radius: 8px;
            min-height: 60px;
            font-size: 14px;
            color: var(--text-color-secondary);
            border: 1px dashed var(--card-border);
        }
        
        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        /* 浏览器兼容性 */
        @-webkit-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @-moz-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        @-o-keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }
        
        .stats {
            display: flex;
            gap: 15px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            min-width: 150px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-top: 5px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
        
        .block-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .block-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .block-category {
            display: flex;
            gap: 10px;
            background: var(--background-light);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .category-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .category-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-light);
        }
        
        .category-btn:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .block-display {
            width: 280px;
            height: 280px;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--card-border);
        }
        
        .block-display:hover {
            transform: scale(1.03);
            box-shadow: var(--glow), var(--shadow);
            border-color: var(--primary);
        }
        
        .block-display:active {
            transform: scale(0.98);
        }
        
        .block-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .block-hp {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .block-rewards {
            font-size: 16px;
            margin-top: 5px;
            text-align: center;
            color: var(--text-muted);
        }
        
        .block-nav-btn {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            border: none;
            color: var(--text);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
        }
        
        .block-nav-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            background: var(--background-light);
            border-radius: 12px;
            padding: 5px;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            font-weight: 600;
            position: relative;
        }
        
        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: var(--shadow-light);
        }
        
        .tab-btn:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab-content {
            display: none;
            height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .research-area {
            margin-top: 20px;
        }
        
        .section-subtitle {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            color: #333;
        }
        
        .research-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .research-info {
            flex: 1;
        }
        
        .research-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .research-cost {
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .research-description {
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .research-status {
            color: #90ee90;
        }
        
        .research-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .research-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #45a049, #3d8b40);
            transform: translateY(-2px);
        }
        
        .research-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .research-buttons {
            display: flex;
            gap: 10px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .boost-item, .resource-item, .shop-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: box-shadow 0.3s ease, background 0.3s ease;
        }
        
        .boost-item:hover, .resource-item:hover, .shop-item:hover {
            box-shadow: var(--shadow);
        }
        
        .shop-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .shop-item-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .shop-item button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-light);
            width: 100%;
        }
        
        .shop-item button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(233, 69, 96, 0.4);
        }
        
        .shop-item button:disabled {
            background: linear-gradient(135deg, #555 0%, #777 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .alchemy-area {
            margin-top: 20px;
        }
        
        .alchemy-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .alchemy-input input {
            flex: 1;
            padding: 12px;
            background: var(--background-lighter);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
        }
        
        .alchemy-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }
        
        .alchemy-btn, .convert-alchemy-btn, button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-light);
        }
        
        .alchemy-btn:hover, .convert-alchemy-btn:hover, button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .convert-alchemy-btn {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
            margin-top: 15px;
            width: 100%;
        }
        
        .convert-alchemy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        .alchemy-results {
            margin-top: 15px;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-light);
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--background-lighter);
            border-radius: 6px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        h2 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: inline-block;
        }
        
        .pickaxe-use-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
        }
        
        .pickaxe-use-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .pickaxe-use-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .level-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .level-icon {
            font-size: 24px;
            color: var(--primary);
        }
        
        .damage-popup {
            position: absolute;
            color: var(--primary);
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            z-index: 100;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; text-shadow: 0 0 10px rgba(255, 107, 107, 0.8); }
            70% { opacity: 1; }
            100% { transform: translateY(-70px); opacity: 0; text-shadow: none; }
        }
        
        /* 已在文件开头定义了带炫彩渐变的.game-title样式 */
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        .convert-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }
        
        .convert-info {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-muted);
            text-align: center;
        }
        
        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .auto-save-info {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
        }
        
        .pickaxe-count {
            background: rgba(255, 107, 107, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin-left: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .achievement-item {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .achievement-item.unlocked {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        
        .achievement-item.locked {
            opacity: 0.6;
            filter: grayscale(0.8);
        }
        
        .achievement-status {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
            font-weight: 500;
        }
        
        .achievement-item.unlocked .achievement-status {
            color: var(--text);
        }
        
        .achievement-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: slideInRight 0.5s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .shop-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: var(--background-light);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .shop-categories .category-btn {
            flex: 1;
            background: transparent;
            color: var(--text-muted);
        }
        
        .alchemy-value-display {
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-lighter) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }
        
        .alchemy-value-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .alchemy-value-amount {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
            margin-top: 5px;
        }
        
        /* 自定义滚动条 */
        .tab-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .tab-content::-webkit-scrollbar-track {
            background: var(--background-lighter);
            border-radius: 5px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .tab-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--secondary-dark));
        }
        
        /* 响应式调整 */
        @media (max-width: 1100px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .stat-item {
                min-width: 130px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .game-area, .info-area {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .block-navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .block-category {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 8px;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-item {
                width: 100%;
                min-width: auto;
            }
            
            .block-display {
                width: 240px;
                height: 240px;
            }
            
            .alchemy-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-area">
            <div class="header">
                <div>
                    <div class="game-title">重置v1.1.9178</div>
                    <div class="game-stage" id="game-stage">当前阶段: 第一阶段</div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div>总伤害</div>
                        <div class="stat-value" id="total-damage">1.00</div>
                    </div>
                    <div class="stat-item">
                        <div>金币</div>
                        <div class="stat-value" id="gold">0</div>
                    </div>
                    <div class="stat-item">
                        <div>奖杯</div>
                        <div class="stat-value" id="trophies">0</div>
                    </div>
                </div>
            </div>

            <div class="block-area">
                <div class="block-navigation">
                    <button class="block-nav-btn" id="prev-block"><i class="fas fa-chevron-left"></i></button>
                    <div class="block-category">
                        <button class="category-btn active" data-category="main1">主线1</button>
                        <button class="category-btn" data-category="side">支线</button>
        <button class="category-btn" data-category="main2">主线2</button>
        <button class="category-btn" data-category="side1" style="display: none;">支线1</button>
        <button class="category-btn" data-category="side1" style="display: none !important;">支线1</button>
        <button class="category-btn" data-category="side2" style="display: none !important;">支线2</button>
        <button class="category-btn" data-category="side3" style="display: none !important;">支线3</button>
                    </div>
                    <button class="block-nav-btn" id="next-block"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="block-display" id="block-display">
                    <div class="block-name" id="block-name">土块</div>
                    <div class="block-hp" id="block-hp">100/100</div>
                    <div class="block-rewards" id="block-rewards">基础奖励: 1金币</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="boosts"><i class="fas fa-chart-line"></i> 增益</button>
                <button class="tab-btn" data-tab="resources"><i class="fas fa-gem"></i> 资源</button>
                <button class="tab-btn" data-tab="shop"><i class="fas fa-shopping-cart"></i> 商店</button>
                <button class="tab-btn" data-tab="alchemy"><i class="fas fa-flask"></i> 炼药</button>
                <button class="tab-btn" data-tab="water-tree"><i class="fas fa-tint"></i> 浇树</button>
                <button class="tab-btn" data-tab="research" id="research-tab-btn" style="display: none;"><i class="fas fa-flask"></i> 研究所</button>
            </div>

            <div class="tab-content active" id="boosts-tab">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>增益效果</h2>
                </div>
                <div id="boosts-list">
                    <!-- 增益项将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="resources-tab">
                <div class="section-title">
                    <i class="fas fa-gem"></i>
                    <h2>资源</h2>
                </div>
                <div id="resources-list">
                    <!-- 资源项将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="shop-tab">
                <div class="section-title">
                    <i class="fas fa-shopping-cart"></i>
                    <h2>商店</h2>
                </div>
                <div class="shop-categories">
                    <button class="category-btn active" data-shop="main1">主线1商店</button>
                    <button class="category-btn" data-shop="side">支线商店</button>
        <button class="category-btn" data-shop="main2">主线2商店</button>
        <button class="category-btn" data-shop="main3">主线3商店</button>
        <button class="category-btn" data-shop="side1" style="display: none !important;">支线1商店</button>
        <button class="category-btn" data-shop="side2" style="display: none !important;">支线2商店</button>
        <button class="category-btn" data-shop="side3" style="display: none !important;">支线3商店</button>
                    <button class="category-btn" data-shop="items">物品商店</button>
            </div>
                <div id="shop-items">
                    <!-- 商店物品将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="tab-content" id="alchemy-tab">
                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    <h2>炼药系统</h2>
                </div>
                <div class="alchemy-area">
                    <div class="alchemy-value-display">
                        当前炼药价值: <span class="alchemy-value-amount" id="alchemy-value-amount">0</span>
                    </div>
                    <button 
                        class="convert-alchemy-btn" 
                        id="convert-alchemy-btn"
                        style="
                            padding: 16px 32px;
                            font-size: 20px;
                            font-weight: bold;
                            background: linear-gradient(145deg, #4CAF50, #45a049);
                            color: white;
                            border: 2px solid #4CAF50;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
                            margin-bottom: 20px;
                            width: 100%;
                            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            position: relative;
                            overflow: hidden;
                        "
                        onclick="newConvertToAlchemy()"
                    >
                        <i class="fas fa-flask mr-2" style="margin-right: 8px;"></i>
                        一键获取炼药价值
                        <div class="button-overlay" style="
                            position: absolute;
                            top: 0;
                            left: -100%;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                            transition: left 0.6s;
                        "></div>
                    </button>
                    <script>
                        // 添加按钮动画效果
                        document.getElementById('convert-alchemy-btn').addEventListener('mouseover', function() {
                            this.style.boxShadow = '0 12px 24px rgba(76, 175, 80, 0.4)';
                            this.style.transform = 'translateY(-3px) scale(1.02)';
                            this.style.borderColor = '#3d8b40';
                            this.querySelector('.button-overlay').style.left = '100%';
                        });
                        
                        document.getElementById('convert-alchemy-btn').addEventListener('mouseout', function() {
                            this.style.boxShadow = '0 8px 16px rgba(76, 175, 80, 0.3)';
                            this.style.transform = 'translateY(0) scale(1)';
                            this.style.borderColor = '#4CAF50';
                            this.querySelector('.button-overlay').style.left = '-100%';
                        });
                        
                        document.getElementById('convert-alchemy-btn').addEventListener('mousedown', function() {
                            this.style.transform = 'translateY(0) scale(0.98)';
                            this.style.boxShadow = '0 4px 8px rgba(76, 175, 80, 0.3)';
                        });
                        
                        document.getElementById('convert-alchemy-btn').addEventListener('mouseup', function() {
                            this.style.transform = 'translateY(-3px) scale(1.02)';
                            this.style.boxShadow = '0 12px 24px rgba(76, 175, 80, 0.4)';
                        });
                    </script>
                    <div class="alchemy-input">
                        <input type="number" id="alchemy-value-input" placeholder="单次炼药价值" min="1" value="1">
                        <input type="number" id="alchemy-times" placeholder="炼药次数" min="1" max="10000" value="1">
                        <button 
                            class="alchemy-btn" 
                            id="alchemy-btn"
                            style="
                                padding: 10px 20px;
                                font-size: 16px;
                                font-weight: bold;
                                background-color: #FF5722;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                transition: background-color 0.3s;
                            "
                            onclick="handleAlchemy()"
                        >
                            开始炼药
                        </button>
                    </div>
                    <div class="alchemy-results" id="alchemy-results">
                        炼药结果将显示在这里
                    </div>
                </div>
            </div>
            

            <div class="tab-content" id="water-tree-tab">
                <div class="section-title">
                    <i class="fas fa-tree"></i>
                    <h2>树系统</h2>
                </div>
                <div class="water-tree-area">
                    <div class="stat-item">
                        <div>
                            <div>树等级: <span id="tree-level">1</span></div>
                            <div>树经验: <span id="tree-exp">0</span>/<span id="tree-exp-needed">10</span></div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="tree-exp-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="water-tree-buttons">
                <button class="water-tree-btn" id="water-tree-cube-btn">到达阶段2解锁浇树系统</button>
                <button class="water-tree-btn" id="water-tree-crystal-btn">到达阶段2解锁浇树系统</button>
                <button class="water-tree-btn" id="water-tree-triple-btn">到达阶段2解锁浇树系统</button>
            </div>
                    <div class="water-tree-results" id="water-tree-results">
                        浇树结果将显示在这里
                    </div>
                </div>
            </div>
            <div class="tab-content" id="research-tab">
                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    <h2>研究所系统</h2>
                </div>
                
                <div class="research-area">
                    <div class="section-subtitle">能量转化器</div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">α能量转化器</div>
                            <div class="research-cost">解锁价格: <span id="alpha-converter-cost">10000 α</span></div>
                            <div class="research-description">每秒将1%的α转化为α能量</div>
                            <div class="research-status" id="alpha-energy-status">α能量: 0, 增益: 1.00</div>
                        </div>
                        <button class="research-btn" id="unlock-alpha-converter" onclick="unlockEnergyConverter('alpha')">解锁</button>
                    </div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">β能量转化器</div>
                            <div class="research-cost">解锁价格: <span id="beta-converter-cost">10000 β</span></div>
                            <div class="research-description">每秒将1%的β转化为β能量</div>
                            <div class="research-status" id="beta-energy-status">β能量: 0, 倍增: 1.00</div>
                        </div>
                        <button class="research-btn" id="unlock-beta-converter" onclick="unlockEnergyConverter('beta')">解锁</button>
                    </div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">γ能量转化器</div>
                            <div class="research-cost">解锁价格: <span id="gamma-converter-cost">10000 γ</span></div>
                            <div class="research-description">每秒将1%的γ转化为γ能量</div>
                            <div class="research-status" id="gamma-energy-status">γ能量: 0, 每秒经验: 0.00</div>
                        </div>
                        <button class="research-btn" id="unlock-gamma-converter" onclick="unlockEnergyConverter('gamma')">解锁</button>
                    </div>
                    
                    <div class="section-subtitle">量产器</div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">α量产器 (等级<span id="alpha-producer-level">0</span>)</div>
                            <div class="research-cost">解锁价格: <span id="alpha-producer-cost">10 量产核心</span></div>
                            <div class="research-description">每秒生产: <span id="alpha-producer-rate">0 α</span></div>
                        </div>
                        <div class="research-buttons">
                            <button class="research-btn" id="unlock-alpha-producer" onclick="unlockProducer('alpha')">解锁</button>
                            <button class="research-btn" id="upgrade-alpha-producer" onclick="upgradeProducer('alpha')" disabled style="display: none;">升级 (消耗: <span id="alpha-upgrade-cost">1200 量产核心</span>)</button>
                        </div>
                    </div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">β量产器 (等级<span id="beta-producer-level">0</span>)</div>
                            <div class="research-cost">解锁价格: <span id="beta-producer-cost">10 量产核心</span></div>
                            <div class="research-description">每秒生产: <span id="beta-producer-rate">0 β</span></div>
                        </div>
                        <div class="research-buttons">
                            <button class="research-btn" id="unlock-beta-producer" onclick="unlockProducer('beta')">解锁</button>
                            <button class="research-btn" id="upgrade-beta-producer" onclick="upgradeProducer('beta')" disabled style="display: none;">升级 (消耗: <span id="beta-upgrade-cost">1200 量产核心</span>)</button>
                        </div>
                    </div>
                    <div class="research-item">
                        <div class="research-info">
                            <div class="research-name">γ量产器 (等级<span id="gamma-producer-level">0</span>)</div>
                            <div class="research-cost">解锁价格: <span id="gamma-producer-cost">10 量产核心</span></div>
                            <div class="research-description">每秒生产: <span id="gamma-producer-rate">0 γ</span></div>
                        </div>
                        <div class="research-buttons">
                            <button class="research-btn" id="unlock-gamma-producer" onclick="unlockProducer('gamma')">解锁</button>
                            <button class="research-btn" id="upgrade-gamma-producer" onclick="upgradeProducer('gamma')" disabled style="display: none;">升级 (消耗: <span id="gamma-upgrade-cost">1200 量产核心</span>)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-area">
            <div class="section-title">
                <i class="fas fa-hard-hat"></i>
                <h2>当前镐子</h2>
            </div>
            <div class="boost-item">
                <div>
                    <div id="current-pickaxe">木镐</div>
                    <div>增益: <span id="pickaxe-boost">1</span></div>
                    <div>金币倍率: <span id="gold-multiplier">1</span></div>
                    <div>使用增益增加: <span id="usage-gain">0.01</span></div>
                </div>
            </div>

            <div class="level-area">
                <i class="fas fa-level-up-alt level-icon"></i>
                <div>
                    <div>等级: <span id="level">0</span></div>
                    <div>经验: <span id="exp">0</span>/<span id="exp-needed">0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="section-title">
                <i class="fas fa-calculator"></i>
                <h2>统计数据</h2>
            </div>
            <div class="stat-item">
                <div>
                    <div>使用增益: <span id="usage-boost">1</span></div>
                    <div>奖杯增益: <span id="trophy-boost">1</span></div>
                    <div>等级增益: <span id="level-boost">1</span></div>
                    <div>炼药增益: <span id="alchemy-boost">1</span></div>
                    <!-- 浇树增益将根据游戏阶段动态显示 -->
                    <div id="tree-boost" style="display: none; visibility: hidden; opacity: 0;">浇树增益: 1</div>
                    <!-- 能量增益将根据游戏阶段动态显示 -->
                    <div id="energy-boost" style="display: none; visibility: hidden; opacity: 0;">能量增益: 1</div>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fas fa-robot"></i>
                <h2>自动挖矿</h2>
            </div>
            <button class="alchemy-btn" id="auto-mining-toggle">开启自动挖矿</button>
            
            <!-- 树系统已移至浇树区域 -->

            <div class="section-title">
                <i class="fas fa-exchange-alt"></i>
                <h2>金币兑换</h2>
            </div>
            <!-- 全新的兑换按钮实现 -->
            <div id="convert-section" style="text-align: center; margin: 20px 0;">
                <button 
                    id="new-convert-btn" 
                    class="convert-btn"
                    style="
                        padding: 12px 24px;
                        font-size: 16px;
                        font-weight: bold;
                        background-color: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: background-color 0.3s;
                    "
                    onclick="handleConvertClick()"
                >
                    全部兑换为奖杯
                </button>
                <div 
                    id="new-convert-info" 
                    style="
                        margin-top: 10px;
                        font-size: 14px;
                        color: #666;
                    "
                >
                    当前可兑换: 0 奖杯
                </div>
            </div>
            <div class="auto-save-info">
                <i class="fas fa-save"></i> 每5秒自动保存
            </div>

            <div class="section-title">
                <i class="fas fa-info-circle"></i>
                <h2>游戏说明</h2>
            </div>
            <div style="margin-top: 10px; font-size: 14px; line-height: 1.6;">
                <p><i class="fas fa-mouse-pointer"></i> 点击方块进行挖掘</p>
                <p><i class="fas fa-coins"></i> 获得金币和经验值</p>
                <p><i class="fas fa-trophy"></i> 使用金币兑换奖杯</p>
                <p><i class="fas fa-level-up-alt"></i> 经验值满后自动升级</p>
                <p><i class="fas fa-shopping-cart"></i> 在商店购买更好的镐子</p>
                <p><i class="fas fa-flask"></i> 使用炼药系统提升炼药增益</p>
            </div>
        </div>
    </div>

    <div class="save-notification" id="save-notification">
        <i class="fas fa-check-circle"></i> 游戏已自动保存
    </div>
    <div class="achievement-notification" id="achievement-notification" style="display: none;">
        <i class="fas fa-trophy"></i> <span id="achievement-name">成就解锁！</span>
    </div>

    <script>
        // 游戏数据定义
        const gameData = {
            // 方块数据
            blocks: {
                main1: [
                    { name: "土块", hp: 100, baseGold: 1 },
                    { name: "草块", hp: 500, baseGold: 2 },
                    { name: "木块", hp: 2000, baseGold: 3 },
                    { name: "石块", hp: 10000, baseGold: 5 },
                    { name: "硬石块", hp: 50000, baseGold: 10 },
                    { name: "深板岩", hp: 300000, baseGold: 15 },
                    { name: "煤炭块", hp: 1780000, baseGold: 20 },
                    { name: "铜块", hp: 7800000, baseGold: 30 },
                    { name: "铁块", hp: 91000000, baseGold: 40 },
                    { name: "金块", hp: 260000000, baseGold: 50 },
                    { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                    { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                    { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                    { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                    { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                    { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                    { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                    { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                    { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                    { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                    { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                ],
                side: [
                    { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                    { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                    { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } },
                    { name: "红曜石", hp: 5e16, baseGold: 500, special: { type: "fragment", item: "红曜石", chance: 0.05 } },
                    { name: "蓝曜石", hp: 6e16, baseGold: 600, special: { type: "fragment", item: "蓝曜石", chance: 0.05 } },
                    { name: "金奖核心", hp: 1e21, baseGold: 2000, special: { type: "fragment", item: "金奖核心", chance: 0.1 } },
                    { name: "淼立方块", hp: 1e22, baseGold: 2500, special: { type: "fragment", item: "淼立方", chance: 0.05 } },
                    { name: "水晶晶簇", hp: 1e23, baseGold: 2500, special: { type: "pickaxe", item: "紫水晶镐Ⅲ", count: 1, chance: 0.1 } },
                    { name: "坤群", hp: 1e24, baseGold: 3000, special: { type: "fragment", item: "坤坤", count: 1000, chance: 0.01 } },
                    { name: "红曜方", hp: 5e25, baseGold: 4000, special: { type: "fragment", item: "红曜方", chance: 0.005 } },
                    { name: "蓝曜方", hp: 6e25, baseGold: 4000, special: { type: "fragment", item: "蓝曜方", chance: 0.005 } },
                    { name: "五行镐", hp: 7.8e31, baseGold: 18000, special: { type: "pickaxe", item: "五行镐", count: 1, chance: 0.01 } },
                    { name: "五行精华", hp: 9.1e31, baseGold: 18000, special: { type: "fragment", item: "五行精华", count: 1, chance: 0.001 } },
                    { name: "药叶", hp: 9.1e44, baseGold: 100000, special: { type: "fragment", item: "药叶", count: 1, chance: 0.03 } }
                ],
                main2: [
                    { name: "木结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "木结晶", chance: 0.05 } },
                    { name: "土结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "土结晶", chance: 0.05 } },
                    { name: "水结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "水结晶", chance: 0.05 } },
                    { name: "火结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "火结晶", chance: 0.05 } },
                    { name: "金结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "金结晶", chance: 0.05 } },
                    { name: "风结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "风结晶", chance: 0.05 } },
                    { name: "雷结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "雷结晶", chance: 0.05 } },
                    { name: "光结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "光结晶", chance: 0.05 } },
                    { name: "暗结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "暗结晶", chance: 0.05 } },
                    { name: "源结晶块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "源结晶", chance: 0.01 } }
                ],
  
                main3: [
                    { name: "α方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "α", count: 1, chance: 1 } },
                    { name: "β方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "β", count: 1, chance: 1 } },
                    { name: "γ方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "γ", count: 1, chance: 1 } },
                    { name: "元素晶片", hp: 1.91e31, baseGold: 15000, special: { type: "fragment", item: "元素晶片", count: 1, chance: 0.1 } },
                    { name: "量产核心", hp: 1.91e34, baseGold: 20000, special: { type: "fragment", item: "量产核心", count: 1, chance: 0.01 } }
                ],

            },
            
            // 镐子数据
            pickaxes: {
                main1: [
                    { name: "木镐", cost: { trophies: 1 }, boost: 1, goldMultiplier: 1, usageGain: 0.01 },
                    { name: "石镐", cost: { trophies: 2 }, boost: 2, goldMultiplier: 1, usageGain: 0.02 },
                    { name: "铁镐", cost: { trophies: 6 }, boost: 5, goldMultiplier: 1, usageGain: 0.05 },
                    { name: "金镐", cost: { trophies: 24 }, boost: 10, goldMultiplier: 1, usageGain: 0.1 },
                    { name: "钻石镐", cost: { trophies: 120 }, boost: 20, goldMultiplier: 1, usageGain: 0.2 },
                    { name: "下届合金镐", cost: { trophies: 600 }, boost: 50, goldMultiplier: 1, usageGain: 0.5 },
                    { name: "黑曜石镐", cost: { trophies: 3000 }, boost: 100, goldMultiplier: 1, usageGain: 1 },
                    { name: "红曜石镐", cost: { fragments: { "红曜石碎片": 10 }, basePickaxe: "黑曜石镐" }, boost: 150, goldMultiplier: 1, usageGain: 1.5 },
                    { name: "蓝曜石镐", cost: { fragments: { "蓝曜石碎片": 10 }, basePickaxe: "红曜石镐" }, boost: 200, goldMultiplier: 1, usageGain: 2 },
                    { name: "红蓝镐", cost: { fragments: { "下界之星": 10 }, basePickaxes: ["红曜石镐", "蓝曜石镐"] }, boost: 300, goldMultiplier: 1, usageGain: 3 },
                    { name: "基岩镐", cost: { fragments: { "基岩碎片": 10 }, basePickaxe: "红蓝镐" }, boost: 500, goldMultiplier: 1, usageGain: 4 },
                    { name: "木核心镐", cost: { fragments: { "木核心": 10 }, basePickaxe: "红蓝镐" }, boost: 800, goldMultiplier: 1.5, usageGain: 5 },
                    { name: "土核心镐", cost: { fragments: { "土核心": 10 }, basePickaxes: ["木核心镐", "基岩镐"] }, boost: 1200, goldMultiplier: 1.5, usageGain: 6 },
                    { name: "水立方镐", cost: { fragments: { "水立方": 5 }, usageBoost: 100000 }, boost: 2000, goldMultiplier: 1.5, usageGain: 7 },
                    { name: "火立方镐", cost: { fragments: { "火立方": 5 }, usageBoost: 100000 }, boost: 3000, goldMultiplier: 1.5, usageGain: 8 },
                    { name: "金立方镐", cost: { fragments: { "金立方": 5 }, usageBoost: 100000 }, boost: 5000, goldMultiplier: 1.5, usageGain: 9 },
                    { name: "五行镐", cost: { fragments: { "五行转换器": 1 }, basePickaxes: ["金立方镐", "木核心镐", "水立方镐", "火立方镐", "土核心镐"] }, boost: 15000, goldMultiplier: 2.5, usageGain: 15 }
                ],
                side: [
                    { name: "紫水晶镐Ⅰ", cost: { fragments: { "紫水晶": 10 } }, boost: 120, goldMultiplier: 1, usageGain: 2 },
                    { name: "紫水晶镐Ⅱ", cost: { fragments: { "紫水晶镐Ⅰ": 8 } }, boost: 240, goldMultiplier: 1, usageGain: 3 },
                    { name: "紫水晶镐Ⅲ", cost: { fragments: { "紫水晶镐Ⅱ": 6 } }, boost: 400, goldMultiplier: 1.5, usageGain: 5 },
                    { name: "紫水晶镐Ⅳ", cost: { fragments: { "紫水晶镐Ⅲ": 4 } }, boost: 800, goldMultiplier: 1.5, usageGain: 8 },
                    { name: "紫水晶镐Ⅴ", cost: { fragments: { "紫水晶镐Ⅳ": 2 } }, boost: 1500, goldMultiplier: 2, usageGain: 10 },
                    { name: "五行镐Ⅱ", cost: { fragments: { "五行镐": 10 } }, boost: 75000, goldMultiplier: 12.5, usageGain: 75 },
                    { name: "五行镐Ⅲ", cost: { fragments: { "五行镐Ⅱ": 10 } }, boost: 375000, goldMultiplier: 62.5, usageGain: 375 },
                    { name: "红蓝镐Ⅱ", cost: { fragments: { "红曜石": 100, "蓝曜石": 100, "红蓝镐": 10 } }, boost: 30000, goldMultiplier: 10, usageGain: 30 },
                    { name: "红蓝镐Ⅲ", cost: { fragments: { "红曜方": 100, "蓝曜方": 100, "源结晶": 10, "红蓝镐Ⅱ": 10 } }, boost: 900000, goldMultiplier: 40, usageGain: 120 },
                    { name: "坤镐", cost: { fragments: { "坤坤": 250000 } }, boost: 2500000, goldMultiplier: 25, usageGain: 250 },
                    { name: "五行镐Ⅳ", cost: { fragments: { "五行镐Ⅲ": 10, "五行驱动器": 1 } }, boost: 24000000, goldMultiplier: 1200, usageGain: 7200 },
                    { name: "奖杯镐", cost: { trophies: 1e9}, boost:2.5e8 , goldMultiplier: 25000, usageGain: 25000 },
                    { name: "使用镐", cost: { usageBoost: 1e12}, boost: 1e9, goldMultiplier: 2500, usageGain: 250000 }
                ],
                main2: [
                    { name: "五行镐·木", cost: { fragments: { "木结晶": 20 }, basePickaxe: "五行镐" }, boost: 24000, goldMultiplier: 4, usageGain: 24 },
                    { name: "五行镐·土", cost: { fragments: { "土结晶": 20 }, basePickaxe: "五行镐" }, boost: 15000, goldMultiplier: 2.5, usageGain: 60 },
                    { name: "五行镐·水", cost: { fragments: { "水结晶": 20 }, basePickaxe: "五行镐" }, boost: 15000, goldMultiplier: 5, usageGain: 30 },
                    { name: "五行镐·火", cost: { fragments: { "火结晶": 20 }, basePickaxe: "五行镐" }, boost: 60000, goldMultiplier: 2.5, usageGain: 15 },
                    { name: "五行镐·金", cost: { fragments: { "金结晶": 20 }, basePickaxe: "五行镐" }, boost: 15000, goldMultiplier: 10, usageGain: 15 },
                    { name: "五行镐·五行", cost: { fragments: { "五行结晶": 20 }, basePickaxes: ["五行镐·金", "五行镐·木", "五行镐·水", "五行镐·火", "五行镐·土"] }, boost: 60000, goldMultiplier: 10, usageGain: 60 },
                    { name: "五行镐·风", cost: { fragments: { "风结晶": 20 }, basePickaxe: "五行镐·五行" }, boost: 240000, goldMultiplier: 10, usageGain: 60 },
                    { name: "五行镐·雷", cost: { fragments: { "雷结晶": 20 }, basePickaxe: "五行镐·五行" }, boost: 60000, goldMultiplier: 20, usageGain: 120 },
                    { name: "七行镐", cost: { fragments: { "风雷结晶": 20 }, basePickaxes: ["五行镐·风", "五行镐·雷"] }, boost: 240000, goldMultiplier: 20, usageGain: 120 },
                    { name: "七行镐·光", cost: { fragments: { "光结晶": 20 }, basePickaxe: "七行镐" }, boost: 1000000, goldMultiplier: 20, usageGain: 120 },
                    { name: "七行镐·暗", cost: { fragments: { "暗结晶": 20 }, basePickaxe: "七行镐" }, boost: 240000, goldMultiplier: 40, usageGain: 240 },
                    { name: "九行镐", cost: { fragments: { "光暗结晶": 20 }, basePickaxes: ["七行镐·光", "七行镐·暗"] }, boost: 1000000, goldMultiplier: 40, usageGain: 240 },
                    { name: "源镐", cost: { fragments: { "源结晶": 1000 }, basePickaxes: ["九行镐", "红蓝镐Ⅲ"] }, boost: 3000000, goldMultiplier: 120, usageGain: 750 }
                
                ],
                main3: [
                    { name: "元素镐", cost: { fragments: { "元素晶片": 100 } }, boost: 5000000, goldMultiplier: 200, usageGain: 1200 },
                    { name: "元素镐2阶", cost: { fragments: { "元素镐": 1, "元素晶片": 9178 } }, boost: 1.2e7, goldMultiplier: 500, usageGain: 3000 },
                    { name: "元素镐3阶", cost: { fragments: { "元素镐2阶": 1, "五行镐Ⅳ": 1, "元素晶片": 27891 } }, boost: 6e7, goldMultiplier: 2200, usageGain: 14000 },
                    { name: "元素镐4阶", cost: { fragments: { "元素镐3阶": 1 }, alpha: 100000, beta: 100000, gamma: 100000 }, boost: 8e7, goldMultiplier: 2600, usageGain: 18000 },
                    { name: "元素镐5阶", cost: { fragments: { "元素镐4阶": 1 }, alpha: 400000, beta: 400000, gamma: 400000 }, boost: 1e8, goldMultiplier: 3000, usageGain: 22000 },
                    { name: "元素镐6阶", cost: { fragments: { "元素镐5阶": 1 }, alpha: 1000000, beta: 1000000, gamma: 1000000 }, boost: 1.4e8, goldMultiplier: 3600, usageGain: 28000 },
                    { name: "元素镐7阶", cost: { fragments: { "元素镐6阶": 1 }, alpha: 2400000, beta: 2400000, gamma: 2400000 }, boost: 2e8, goldMultiplier: 4400, usageGain: 36000 },
                    { name: "元素镐8阶", cost: { fragments: { "元素镐7阶": 1 }, alpha: 10000000, beta: 10000000, gamma: 10000000 }, boost: 3e8, goldMultiplier: 5400, usageGain: 48000 },
                    { name: "元素镐9阶", cost: { fragments: { "元素镐8阶": 1, "药叶": 25 } }, boost: 5e8, goldMultiplier: 6666, usageGain: 66666 },
                    { name: "元素镐10阶", cost: { fragments: { "元素镐9阶": 4, "药叶": 6400 } }, boost: 1e9, goldMultiplier: 10000, usageGain: 100000 }
                ],
                items: [
                    { name: "红曜石", cost: { fragments: { "红曜石碎片": 365 } } },
                    { name: "蓝曜石", cost: { fragments: { "蓝曜石碎片": 366 } } },
                    { name: "五行转换器", cost: { fragments: { "蓝曜石": 5, "红曜石": 5, "紫水晶镐Ⅴ": 1 } } },
                    { name: "金奖转化器", cost: { fragments: { "金奖核心": 10 } } },
                    { name: "五行结晶", cost: { fragments: { "金结晶": 1, "木结晶": 1, "水结晶": 1, "火结晶": 1, "土结晶": 1 } } },
                    { name: "风雷结晶", cost: { fragments: { "风结晶": 1, "雷结晶": 1 } } },
                    { name: "光暗结晶", cost: { fragments: { "光结晶": 1, "暗结晶": 1 } } },
                    { name: "红曜方", cost: { fragments: { "红曜石": 100 } } },
                    { name: "蓝曜方", cost: { fragments: { "蓝曜石": 100 } } },
                    { name: "五行驱动器", cost: { fragments: { "五行精华": 10 } } },
                    { name: "???", cost: { fragments: { "药叶": 10 } } }
                ]
            },
            
            // 炼药价值
            alchemyValues: {
                "下界之星": 1,
                "基岩碎片": 5,
                "坤坤": 25,
                "木核心": 50,
                "土核心": 80,
                "水立方": 120,
                "火立方": 160,
                "金立方": 200,
                "药叶": 1e5
            },
            
            // 万进制单位
            units: ['', '万', '亿', '万亿', '兆', '万兆', '亿兆', '万亿兆', '京', '万京', '亿京', '万亿京', '兆京', '万兆京', '亿兆京', '万亿兆京', '垓', '万垓', '亿垓', '万亿垓', '兆垓', '万兆垓', '亿兆垓', '万亿兆垓', '京垓', '万京垓', '亿京垓', '万亿京垓', '兆京垓', '万兆京垓', '亿兆京垓', '万亿兆京垓', '杼', '万杼', '亿杼', '万亿杼', '兆杼', '万兆杼', '亿兆杼', '万亿兆杼', '京杼', '万京杼', '亿京杼', '万亿京杼', '兆京杼', '万兆京杼', '亿兆京杼', '万亿兆京杼', '垓杼', '万垓杼', '亿垓杼', '万亿垓杼', '兆垓杼', '万兆垓杼', '亿兆垓杼', '万亿兆垓杼', '京垓杼', '万京垓杼', '亿京垓杼', '万亿京垓杼', '兆京垓杼', '万兆京垓杼', '亿兆京垓杼', '万亿兆京垓杼', '穰', '万穰', '亿穰', '万亿穰', '兆穰', '万兆穰', '亿兆穰', '万亿兆穰', '京穰', '万京穰', '亿京穰', '万亿京穰', '兆京穰']
        };

        // 游戏状态 - 使用window.gameState确保全局一致
        if (!window.gameState) {
            window.gameState = {
                level: 0,
                exp: 0,
                gold: 0,
                trophies: 0,
                currentBlockCategory: "main1",
                currentBlockIndex: 0,
                currentPickaxe: "木镐",
                usageBoost: 1,
                alchemyBoost: 1,
                alchemyValue: 0,
                gameStage: 1,
                resources: {
                    "红曜石碎片": 0,
                    "蓝曜石碎片": 0,
                    "基岩碎片": 0,
                    "木核心": 0,
                    "土核心": 0,
                    "水立方": 0,
                    "火立方": 0,
                    "金立方": 0,
                    "紫水晶": 0,
                    "下界之星": 0,
                    "坤坤": 0,
                    "红曜石": 0,
                    "蓝曜石": 0,
                    "五行转换器": 0,
                    "木结晶": 0,
                    "土结晶": 0,
                    "水结晶": 0,
                    "火结晶": 0,
                    "金结晶": 0,
                    "风结晶": 0,
                    "雷结晶": 0,
                    "光结晶": 0,
                    "暗结晶": 0,
                    "源结晶": 0,
                    "金奖核心": 0,
                    "淼立方": 0,
                    "红曜方": 0,
                    "蓝曜方": 0,
                    "五行结晶": 0,
                    "风雷结晶": 0,
                    "光暗结晶": 0,
                    "金奖转化器": 0,
                    "α": 0,
                    "β": 0,
                    "γ": 0,
                    "元素晶片": 0,
                    "量产核心": 0,
                    "五行镐": 0,
                    "五行精华": 0,
                    "五行驱动器": 0,
                    "???": 0
                },
                // 研究所相关状态
                energies: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                converters: {
                    alpha: false,
                    beta: false,
                    gamma: false
                },
                producers: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                pickaxes: {
                    "木镐": 1,
                    "石镐": 0,
                    "铁镐": 0,
                    "金镐": 0,
                    "钻石镐": 0,
                    "下届合金镐": 0,
                    "黑曜石镐": 0,
                    "红曜石镐": 0,
                    "蓝曜石镐": 0,
                    "红蓝镐": 0,
                    "基岩镐": 0,
                    "木核心镐": 0,
                    "土核心镐": 0,
                    "水立方镐": 0,
                    "火立方镐": 0,
                    "金立方镐": 0,
                    "五行镐": 0,
                    "紫水晶镐Ⅰ": 0,
                    "紫水晶镐Ⅱ": 0,
                    "紫水晶镐Ⅲ": 0,
                    "紫水晶镐Ⅳ": 0,
                    "紫水晶镐Ⅴ": 0,
                    "五行镐·木": 0,
                    "五行镐·土": 0,
                    "五行镐·水": 0,
                    "五行镐·火": 0,
                    "五行镐·金": 0,
                    "五行镐·五行": 0,
                    "五行镐·风": 0,
                    "五行镐·雷": 0,
                    "七行镐": 0,
                    "七行镐·光": 0,
                    "七行镐·暗": 0,
                    "九行镐": 0,
                    "源镐": 0,
                    "五行镐Ⅱ": 0,
                    "五行镐Ⅲ": 0,
                    "五行镐Ⅳ":0,
                    "红蓝镐Ⅱ": 0,
                    "红蓝镐Ⅲ": 0,
                    "坤镐": 0,
                    "元素镐": 0,
                    "元素镐2阶": 0,
                    "元素镐3阶": 0,
                    "元素镐4阶": 0,
                    "元素镐5阶": 0,
                    "元素镐6阶": 0,
                    "元素镐7阶": 0,
                    "元素镐8阶": 0,
                    "元素镐9阶": 0,
                    "元素镐10阶": 0,
                    "奖杯镐":0,
                    "使用镐":0
                },
                blockHp: {}
            };
        }
        
        // 初始化游戏状态函数
        function initGameState() {
            window.gameState = {
                level: 0,
                exp: 0,
                gold: 0,
                trophies: 0,
                currentBlockCategory: "main1",
                currentBlockIndex: 0,
                currentPickaxe: "木镐",
                usageBoost: 1,
                alchemyBoost: 1,
                alchemyValue: 0,
                gameStage: 1,
                resources: {
                    "红曜石碎片": 0,
                    "蓝曜石碎片": 0,
                    "基岩碎片": 0,
                    "木核心": 0,
                    "土核心": 0,
                    "水立方": 0,
                    "火立方": 0,
                    "金立方": 0,
                    "紫水晶": 0,
                    "下界之星": 0,
                    "坤坤": 0,
                    "红曜石": 0,
                    "蓝曜石": 0,
                    "五行转换器": 0,
                    "木结晶": 0,
                    "土结晶": 0,
                    "水结晶": 0,
                    "火结晶": 0,
                    "金结晶": 0,
                    "风结晶": 0,
                    "雷结晶": 0,
                    "光结晶": 0,
                    "暗结晶": 0,
                    "源结晶": 0,
                    "金奖核心": 0,
                    "淼立方": 0,
                    "红曜方": 0,
                    "蓝曜方": 0,
                    "五行结晶": 0,
                    "风雷结晶": 0,
                    "光暗结晶": 0,
                    "金奖转化器": 0,
                    "α": 0,
                    "β": 0,
                    "γ": 0,
                    "元素晶片": 0,
                    "量产核心": 0,
                    "五行镐": 0,
                    "五行精华": 0,
                    "五行驱动器": 0,
                    "???": 0
                },
                // 研究所相关状态
                energies: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                converters: {
                    alpha: false,
                    beta: false,
                    gamma: false
                },
                producers: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                pickaxes: {
                    "木镐": 1,
                    "石镐": 0,
                    "铁镐": 0,
                    "金镐": 0,
                    "钻石镐": 0,
                    "下届合金镐": 0,
                    "黑曜石镐": 0,
                    "红曜石镐": 0,
                    "蓝曜石镐": 0,
                    "红蓝镐": 0,
                    "基岩镐": 0,
                    "木核心镐": 0,
                    "土核心镐": 0,
                    "水立方镐": 0,
                    "火立方镐": 0,
                    "金立方镐": 0,
                    "五行镐": 0,
                    "紫水晶镐Ⅰ": 0,
                    "紫水晶镐Ⅱ": 0,
                    "紫水晶镐Ⅲ": 0,
                    "紫水晶镐Ⅳ": 0,
                    "紫水晶镐Ⅴ": 0,
                    "五行镐·木": 0,
                    "五行镐·土": 0,
                    "五行镐·水": 0,
                    "五行镐·火": 0,
                    "五行镐·金": 0,
                    "五行镐·五行": 0,
                    "五行镐·风": 0,
                    "五行镐·雷": 0,
                    "七行镐": 0,
                    "七行镐·光": 0,
                    "七行镐·暗": 0,
                    "九行镐": 0,
                    "源镐": 0,
                    "五行镐Ⅱ": 0,
                    "五行镐Ⅲ": 0,
                    "五行镐Ⅳ":0,
                    "红蓝镐Ⅱ": 0,
                    "红蓝镐Ⅲ": 0,
                    "坤镐": 0,
                    "元素镐": 0,
                    "元素镐2阶": 0,
                    "元素镐3阶": 0,
                    "元素镐4阶": 0,
                    "元素镐5阶": 0,
                    "元素镐6阶": 0,
                    "元素镐7阶": 0,
                    "元素镐8阶": 0,
                    "元素镐9阶": 0,
                    "元素镐10阶": 0,
                    "奖杯镐":0,
                    "使用镐":0
                },
                blockHp: {}
            };
        }

        // 初始化方块血量
        function initBlockHp() {
            try {
                // 验证必要的数据结构
                if (!gameData || typeof gameData !== 'object' || !gameData.blocks) {
                    console.error('初始化方块血量失败：游戏数据无效');
                    return;
                }
                
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 3, blockHp: {}, alphaEnergy: 100 };
                }
                
                // 确保alphaEnergy字段存在
                if (window.gameState.alphaEnergy === undefined) {
                    window.gameState.alphaEnergy = 100;
                }
                
                // 确保blockHp对象存在
                if (!window.gameState.blockHp) {
                    window.gameState.blockHp = {};
                }
                
                // 遍历所有方块分类
                for (const category in gameData.blocks) {
                    try {
                        // 确保分类数据有效
                        if (!gameData.blocks.hasOwnProperty(category) || !Array.isArray(gameData.blocks[category])) {
                            console.warn(`跳过无效的方块分类: ${category}`);
                            continue;
                        }
                        
                        // 初始化该分类的血量数组
                        window.gameState.blockHp[category] = [];
                        
                        // 遍历该分类下的所有方块
                        for (let i = 0; i < gameData.blocks[category].length; i++) {
                            try {
                                const block = gameData.blocks[category][i];
                                // 验证方块数据和血量
                                if (!block || typeof block.hp !== 'number' || isNaN(block.hp) || block.hp < 0) {
                                    // 使用默认血量值
                                    window.gameState.blockHp[category][i] = 100;
                                    console.warn(`方块 ${category}[${i}] 的血量无效，使用默认值 100`);
                                } else {
                                    window.gameState.blockHp[category][i] = Math.max(1, block.hp); // 确保血量至少为1
                                }
                            } catch (blockError) {
                                console.error(`初始化方块 ${category}[${i}] 血量失败:`, blockError);
                                // 出错时使用默认值
                                window.gameState.blockHp[category][i] = 100;
                            }
                        }
                    } catch (categoryError) {
                        console.error(`初始化方块分类 ${category} 失败:`, categoryError);
                        // 出错时初始化空数组
                        window.gameState.blockHp[category] = [];
                    }
                }
            } catch (e) {
                console.error('初始化方块血量失败:', e);
                // 确保blockHp至少是一个空对象
                window.gameState.blockHp = {};
            }
        }

        // 更新标题显示伤害数值 - 保留更完整的版本（在下方）
        
        // 格式化数字为万进制，保留两位小数（整数不保留）
        function formatNumber(num) {
            num = Number(num) || 0;
            
            // 确保gameData.units存在
            if (!gameData.units) {
                gameData.units = ['', '万', '亿', '万亿', '兆'];
            }
            
            if (num < 10000000) {
                // 对于小于千万的数字，如果是整数则不保留小数
                if (Number.isInteger(num)) {
                    return num.toLocaleString();
                } else {
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }
            }
            
            let unitIndex = 0;
            while (num >= 10000 && unitIndex < gameData.units.length - 1) {
                num /= 10000;
                unitIndex++;
            }
            
            // 对于大数字，保留两位小数，如果是整数则不保留
            if (Number.isInteger(num)) {
                return num.toString() + gameData.units[unitIndex];
            } else {
                return num.toFixed(2).replace(/\.?0+$/, '') + gameData.units[unitIndex];
            }
        }
        
        // 更新title标签显示当前伤害和在线时长
        function updateTitleDamage() {
            try {
                // 使用calculateTotalDamage()计算单次伤害，与游戏内显示保持一致
                const damageValue = calculateTotalDamage();
                // 确保伤害至少为1
                const finalDamage = Math.max(1, damageValue || 1);
                
                // 获取并格式化在线时长
                let playTimeText = '0秒';
                if (window.gameState && window.gameState.totalPlayTimeSeconds !== undefined) {
                    playTimeText = formatPlayTime(window.gameState.totalPlayTimeSeconds);
                }
                
                // 更新标题格式，移除括号
                document.title = `伤害：${formatNumber(finalDamage)}，总在线时长：${playTimeText}`;
            } catch (e) {
                console.error('更新标题失败:', e);
            }
        }

        // 计算所需经验
        function getExpNeeded(level) {
            // 修复经验计算公式，确保升级难度合理
            // 当等级大于100万时，经验恒定为91780
            if (level > 1000000) {
                return 91780;
            }
            // 当等级大于1000时，经验恒定为27891
            else if (level > 1000) {
                return 27891;
            }
            return Math.round(Math.pow(1.01, level) * 10) / 10;
        }

        // 计算奖杯数量
        function calculateTrophies(gold) {
            // 新公式：(金币/100)^0.8
            if (gold < 100) return 0;
            return Math.floor(Math.pow(gold / 100, 0.8));
        }

        // 计算奖杯增益
        function calculateTrophyBoost(trophies) {
            return 1 + Math.pow(trophies, 0.4);
        }

        // 计算等级增益
        function calculateLevelBoost(level) {
            return 1 + Math.pow(level, 0.5);
        }

        // 计算总伤害
        function calculateTotalDamage() {
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            const trophyBoost = calculateTrophyBoost(window.gameState.trophies);
             const levelBoost = calculateLevelBoost(window.gameState.level);
            
            return pickaxeBoost * window.gameState.usageBoost * trophyBoost * levelBoost * window.gameState.alchemyBoost;
        }

        // 保存游戏状态
        function saveGame() {
            try {
                // 验证gameState是否有效
                if (!window.gameState || typeof window.gameState !== 'object') {
                    console.error('保存失败：游戏状态无效');
                    return;
                }
                
                // 创建一个干净的游戏状态副本，避免保存循环引用或无效数据
                const cleanGameState = {
                    level: Math.max(0, Number(window.gameState.level) || 0),
                    exp: Math.max(0, Number(window.gameState.exp) || 0),
                    gold: Math.max(0, Number(window.gameState.gold) || 0),
                    trophies: Math.max(0, Number(window.gameState.trophies) || 0),
                    currentBlockCategory: String(window.gameState.currentBlockCategory || "main1"),
                    currentBlockIndex: Math.max(0, Number(window.gameState.currentBlockIndex) || 0),
                    currentPickaxe: String(window.gameState.currentPickaxe || "木镐"),
                    usageBoost: Math.max(1, Number(window.gameState.usageBoost) || 1),
                    alchemyBoost: Math.max(1, Number(window.gameState.alchemyBoost) || 1),
                    alchemyValue: Math.max(0, Number(window.gameState.alchemyValue) || 0),
                    // 新增状态保存
                    treeLevel: Math.max(1, Number(window.gameState.treeLevel) || 1),
                    treeExp: Math.max(0, Number(window.gameState.treeExp) || 0),
                    autoMiningEnabled: Boolean(window.gameState.autoMiningEnabled || false),
                    totalDamage: Math.max(0, Number(window.gameState.totalDamage) || 0),
                    gameStage: Math.max(1, Number(window.gameState.gameStage) || 1),
                    totalPlayTimeSeconds: Math.max(0, Number(window.gameState.totalPlayTimeSeconds) || 0),
                    achievements: { ...(window.gameState.achievements || {}) },
                    resources: { ...(window.gameState.resources || {}) },
                    pickaxes: { ...(window.gameState.pickaxes || {}) },
                    blockHp: { ...(window.gameState.blockHp || {}) },
                    // 保存量产器和转化器状态
                    converters: { ...(window.gameState.converters || {}) },
                    producers: { ...(window.gameState.producers || {}) },
                    energies: { ...(window.gameState.energies || {}) }
                };
                
                // 确保resources和pickaxes中的值都是有效的数字
                for (const [key, value] of Object.entries(cleanGameState.resources)) {
                    cleanGameState.resources[key] = Math.max(0, Number(value) || 0);
                }
                
                for (const [key, value] of Object.entries(cleanGameState.pickaxes)) {
                    cleanGameState.pickaxes[key] = Math.max(0, Number(value) || 0);
                }
                
                // 尝试保存到localStorage
                try {
                    const currentAccountId = getCurrentAccountId();
                    const storageKey = currentAccountId ? `miningGameState_${currentAccountId}` : 'miningGameState';
                    localStorage.setItem(storageKey, JSON.stringify(cleanGameState));
                    
                    // 显示保存通知
                    try {
                        showSaveNotification();
                    } catch (notificationError) {
                        console.warn('显示保存通知失败:', notificationError);
                    }
                    
                    return true;
                } catch (storageError) {
                    // 处理localStorage相关错误
                    if (storageError.name === 'QuotaExceededError') {
                        console.error('保存失败：存储空间不足');
                        // 尝试清理一些非关键数据后重试
                        try {
                            // 移除blockHp以减少数据大小
                            const minimalGameState = { ...cleanGameState };
                            delete minimalGameState.blockHp;
                            const currentAccountId = getCurrentAccountId();
                            const storageKey = currentAccountId ? `miningGameState_${currentAccountId}` : 'miningGameState';
                            localStorage.setItem(storageKey, JSON.stringify(minimalGameState));
                            return true;
                        } catch (retryError) {
                            console.error('精简数据后保存仍失败:', retryError);
                        }
                    } else {
                        console.error('保存到localStorage失败:', storageError);
                    }
                }
            } catch (e) {
                console.error('保存游戏失败:', e);
            }
            return false;
        }

        // ====== 账号管理系统 ======
        // 账号数据结构: { id: string, name: string, createdAt: timestamp }
        // 账号列表存储键: 'miningGameAccounts'
        // 当前账号ID存储键: 'miningGameCurrentAccountId'
        // 账号游戏数据存储键: 'miningGameState_{accountId}'
        
        // 初始化账号系统
        function initAccountSystem() {
            try {
                // 检查是否已有账号列表
                let accounts = localStorage.getItem('miningGameAccounts');
                let currentAccountId = localStorage.getItem('miningGameCurrentAccountId');
                
                // 如果没有账号列表或当前账号ID，创建默认账号
                if (!accounts || !currentAccountId) {
                    const defaultAccount = {
                        id: 'default_' + Date.now(),
                        name: '默认账号',
                        createdAt: Date.now()
                    };
                    
                    localStorage.setItem('miningGameAccounts', JSON.stringify([defaultAccount]));
                    localStorage.setItem('miningGameCurrentAccountId', defaultAccount.id);
                    
                    // 将现有游戏数据迁移到默认账号
                    const existingGameState = localStorage.getItem('miningGameState');
                    if (existingGameState) {
                        localStorage.setItem('miningGameState_' + defaultAccount.id, existingGameState);
                        // 保留原数据以兼容旧版本
                    }
                }
            } catch (e) {
                console.error('初始化账号系统失败:', e);
            }
        }
        
        // 获取账号列表
        function getAccounts() {
            try {
                const accountsJson = localStorage.getItem('miningGameAccounts');
                return accountsJson ? JSON.parse(accountsJson) : [];
            } catch (e) {
                console.error('获取账号列表失败:', e);
                return [];
            }
        }
        
        // 保存账号列表
        function saveAccounts(accounts) {
            try {
                localStorage.setItem('miningGameAccounts', JSON.stringify(accounts));
                return true;
            } catch (e) {
                console.error('保存账号列表失败:', e);
                return false;
            }
        }
        
        // 获取当前账号ID
        function getCurrentAccountId() {
            return localStorage.getItem('miningGameCurrentAccountId');
        }
        
        // 设置当前账号ID
        function setCurrentAccountId(accountId) {
            try {
                localStorage.setItem('miningGameCurrentAccountId', accountId);
                return true;
            } catch (e) {
                console.error('设置当前账号失败:', e);
                return false;
            }
        }
        
        // 创建新账号
        function createAccount(accountName) {
            try {
                const accounts = getAccounts();
                const newAccount = {
                    id: 'account_' + Date.now(),
                    name: accountName || '新账号',
                    createdAt: Date.now()
                };
                
                accounts.push(newAccount);
                if (saveAccounts(accounts)) {
                    return newAccount;
                }
                return null;
            } catch (e) {
                console.error('创建账号失败:', e);
                return null;
            }
        }
        
        // 切换账号
        function switchAccount(accountId) {
            try {
                const accounts = getAccounts();
                const accountExists = accounts.some(account => account.id === accountId);
                
                if (accountExists) {
                    // 先保存当前账号数据
                    saveGame();
                    
                    // 设置新的当前账号
                    setCurrentAccountId(accountId);
                    
                    // 重置游戏状态，确保不会有旧账号数据残留
                    window.gameState = null;
                    initGameState();
                    
                    // 重新加载游戏状态
                    loadGame();
                    
                    // 更新UI
                    updateUI();
                    
                    return true;
                }
                return false;
            } catch (e) {
                console.error('切换账号失败:', e);
                return false;
            }
        }
        
        // 重命名账号
        function renameAccount(accountId, newName) {
            try {
                const accounts = getAccounts();
                const accountIndex = accounts.findIndex(account => account.id === accountId);
                
                if (accountIndex !== -1) {
                    accounts[accountIndex].name = newName;
                    return saveAccounts(accounts);
                }
                return false;
            } catch (e) {
                console.error('重命名账号失败:', e);
                return false;
            }
        }
        
        // 删除账号（确保至少保留一个账号）
        function deleteAccount(accountId) {
            try {
                let accounts = getAccounts();
                
                // 确保至少保留一个账号
                if (accounts.length <= 1) {
                    return false;
                }
                
                // 过滤掉要删除的账号
                const newAccounts = accounts.filter(account => account.id !== accountId);
                
                // 如果删除的是当前账号，切换到第一个可用账号
                const currentAccountId = getCurrentAccountId();
                if (currentAccountId === accountId && newAccounts.length > 0) {
                    setCurrentAccountId(newAccounts[0].id);
                }
                
                // 保存更新后的账号列表
                if (saveAccounts(newAccounts)) {
                    // 删除该账号的游戏数据
                    localStorage.removeItem('miningGameState_' + accountId);
                    
                    // 如果删除的是当前账号，重新加载游戏状态
                    if (currentAccountId === accountId) {
                        loadGame();
                        updateUI();
                    }
                    
                    return true;
                }
                
                return false;
            } catch (e) {
                console.error('删除账号失败:', e);
                return false;
            }
        }
        
        // 获取当前账号信息
        function getCurrentAccount() {
            try {
                const accounts = getAccounts();
                const currentAccountId = getCurrentAccountId();
                return accounts.find(account => account.id === currentAccountId) || null;
            } catch (e) {
                console.error('获取当前账号信息失败:', e);
                return null;
            }
        }
        
        // ====== 修改后的游戏状态加载和保存 ======
        // 加载游戏状态
        function loadGame() {
            try {
                // 确保gameState已经初始化
                if (!window.gameState) {
                    initGameState();
                }
                
                // 清除当前游戏状态，确保完全加载新数据，不残留旧数据
                initGameState();
                
                // 尝试从localStorage加载，使用当前账号ID
                const currentAccountId = getCurrentAccountId();
                const storageKey = currentAccountId ? `miningGameState_${currentAccountId}` : 'miningGameState';
                let savedState = localStorage.getItem(storageKey);
                
                // 如果当前账号没有保存的数据，尝试从默认位置加载（首次迁移）
                if (!savedState && currentAccountId) {
                    const defaultState = localStorage.getItem('miningGameState');
                    if (defaultState) {
                        // 将默认位置的数据迁移到当前账号
                        savedState = defaultState;
                        localStorage.setItem(storageKey, savedState);
                    }
                }
                if (!savedState) {
                    console.log('没有找到保存的游戏数据');
                    return false;
                }
                
                // 解析保存的数据
                let parsedState;
                try {
                    parsedState = JSON.parse(savedState);
                } catch (parseError) {
                    console.error('解析保存数据失败:', parseError);
                    initGameState();
                    return false;
                }
                
                // 验证解析后的数据
                if (!parsedState || typeof parsedState !== 'object') {
                    console.error('无效的游戏数据格式');
                    initGameState();
                    return false;
                }
                
                // 安全地合并保存的状态，确保数据有效性
                window.gameState.level = Math.max(0, Number(parsedState.level) || 0);
                window.gameState.exp = Math.max(0, Number(parsedState.exp) || 0);
                // 加载新增的数据
                window.gameState.treeLevel = Math.max(1, Number(parsedState.treeLevel) || 1);
                window.gameState.treeExp = Math.max(0, Number(parsedState.treeExp) || 0);
                window.gameState.autoMiningEnabled = Boolean(parsedState.autoMiningEnabled || false);
                window.gameState.totalDamage = Math.max(0, Number(parsedState.totalDamage) || 0);
                window.gameState.gameStage = Math.max(1, Number(parsedState.gameStage) || 1);
                window.gameState.totalPlayTimeSeconds = Math.max(0, Number(parsedState.totalPlayTimeSeconds) || 0);
                window.gameState.achievements = { ...(parsedState.achievements || window.gameState.achievements) };
                window.gameState.gold = Math.max(0, Number(parsedState.gold) || 0);
                window.gameState.trophies = Math.max(0, Number(parsedState.trophies) || 0);
                window.gameState.currentBlockCategory = String(parsedState.currentBlockCategory || "main1");
                window.gameState.currentBlockIndex = Math.max(0, Number(parsedState.currentBlockIndex) || 0);
                window.gameState.currentPickaxe = String(parsedState.currentPickaxe || "木镐");
                window.gameState.usageBoost = Math.max(1, Number(parsedState.usageBoost) || 1);
                window.gameState.alchemyBoost = Math.max(1, Number(parsedState.alchemyBoost) || 1);
                window.gameState.alchemyValue = Math.max(0, Number(parsedState.alchemyValue) || 0);
                
                // 确保复杂对象存在且有效
                if (!window.gameState.resources) window.gameState.resources = {};
                if (parsedState.resources && typeof parsedState.resources === 'object') {
                    for (const [key, value] of Object.entries(parsedState.resources)) {
                        window.gameState.resources[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                if (!window.gameState.pickaxes) window.gameState.pickaxes = {};
                if (parsedState.pickaxes && typeof parsedState.pickaxes === 'object') {
                    for (const [key, value] of Object.entries(parsedState.pickaxes)) {
                        window.gameState.pickaxes[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                // 加载转化器状态
                if (!window.gameState.converters) window.gameState.converters = {};
                if (parsedState.converters && typeof parsedState.converters === 'object') {
                    for (const [key, value] of Object.entries(parsedState.converters)) {
                        window.gameState.converters[key] = Boolean(value);
                    }
                }
                
                // 加载量产器状态
                if (!window.gameState.producers) window.gameState.producers = {};
                if (parsedState.producers && typeof parsedState.producers === 'object') {
                    for (const [key, value] of Object.entries(parsedState.producers)) {
                        window.gameState.producers[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                // 加载能量状态
                if (!window.gameState.energies) window.gameState.energies = {};
                if (parsedState.energies && typeof parsedState.energies === 'object') {
                    for (const [key, value] of Object.entries(parsedState.energies)) {
                        window.gameState.energies[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                if (!window.gameState.blockHp) window.gameState.blockHp = {};
                if (parsedState.blockHp && typeof parsedState.blockHp === 'object') {
                    for (const [key, value] of Object.entries(parsedState.blockHp)) {
                        window.gameState.blockHp[key] = Math.max(0, Number(value) || 0);
                    }
                }
                
                // 确保至少有木镐
                if (!window.gameState.pickaxes["木镐"] || window.gameState.pickaxes["木镐"] < 1) {
                    window.gameState.pickaxes["木镐"] = 1;
                }
                
                console.log('游戏数据加载成功');
                return true;
            } catch (e) {
                console.error('加载游戏失败:', e);
                // 重置为初始状态
                try {
                    initGameState();
                } catch (initError) {
                    console.error('初始化游戏状态失败:', initError);
                }
                return false;
            }
        }

        // 显示保存通知
        function showSaveNotification() {
            try {
                // 查找通知元素
                const notification = document.getElementById('save-notification');
                
                // 检查元素是否存在
                if (!notification || !(notification instanceof HTMLElement)) {
                    console.warn('保存通知元素不存在');
                    // 如果通知元素不存在，可以创建一个临时通知
                    try {
                        const tempNotification = document.createElement('div');
                        tempNotification.textContent = '游戏已保存';
                        tempNotification.style.cssText = 
                            'position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: green; color: white; border-radius: 5px; z-index: 1000;';
                        document.body.appendChild(tempNotification);
                        
                        setTimeout(() => {
                            if (document.body.contains(tempNotification)) {
                                document.body.removeChild(tempNotification);
                            }
                        }, 2000);
                    } catch (createError) {
                        console.warn('创建临时保存通知失败:', createError);
                    }
                    return;
                }
                
                // 移除可能存在的旧的定时器，防止多个动画重叠
                if (notification._saveTimeout) {
                    clearTimeout(notification._saveTimeout);
                }
                
                // 显示通知
                notification.classList.add('show');
                
                // 设置定时器隐藏通知
                notification._saveTimeout = setTimeout(() => {
                    try {
                        if (notification && document.body.contains(notification)) {
                            notification.classList.remove('show');
                        }
                    } catch (hideError) {
                        console.warn('隐藏保存通知失败:', hideError);
                    }
                }, 2000);
            } catch (e) {
                console.error('显示保存通知失败:', e);
            }
        }

        // 更新UI
        // 创建账号管理UI
        function createAccountManagementUI() {
            try {
                // 检查是否已存在账号管理UI
                if (document.getElementById('account-management-ui')) return;
                
                // 创建账号管理按钮
                const accountButton = document.createElement('button');
                accountButton.id = 'account-management-btn';
                accountButton.textContent = '账号管理';
                accountButton.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    padding: 8px 16px;
                    background: rgba(135, 206, 250, 0.8);
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                    z-index: 1000;
                `;
                accountButton.addEventListener('click', showAccountManagementUI);
                document.body.appendChild(accountButton);
                
                // 创建账号管理弹窗
                const modal = document.createElement('div');
                modal.id = 'account-management-ui';
                modal.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                    justify-content: center;
                    align-items: center;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: rgba(135, 206, 250, 0.8);
                    border-radius: 8px;
                    padding: 20px;
                    width: 400px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                modalContent.innerHTML = `
                    <h2 style="margin-top: 0; color: #333;">账号管理</h2>
                    <div id="current-account-info" style="margin-bottom: 20px; padding: 10px; background: rgba(135, 206, 250, 0.8); border-radius: 4px;"></div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin-top: 0; margin-bottom: 10px; color: #555;">所有账号</h3>
                        <div id="accounts-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 5px;"></div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="new-account-name" placeholder="新账号名称" style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="create-account-btn" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">创建账号</button>
                    </div>
                    
                    <div style="text-align: right;">
                        <button id="close-account-ui" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // 绑定事件
                document.getElementById('close-account-ui').addEventListener('click', hideAccountManagementUI);
                document.getElementById('create-account-btn').addEventListener('click', handleCreateAccount);
                
            } catch (e) {
                console.error('创建账号管理UI失败:', e);
            }
        }
        
        // 显示账号管理UI
        function showAccountManagementUI() {
            const modal = document.getElementById('account-management-ui');
            if (modal) {
                modal.style.display = 'flex';
                updateAccountsList();
            }
        }
        
        // 隐藏账号管理UI
        function hideAccountManagementUI() {
            const modal = document.getElementById('account-management-ui');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 更新账号列表显示
        function updateAccountsList() {
            try {
                const accountsListElement = document.getElementById('accounts-list');
                const currentAccountInfoElement = document.getElementById('current-account-info');
                
                if (!accountsListElement || !currentAccountInfoElement) return;
                
                // 清空列表
                accountsListElement.innerHTML = '';
                
                const accounts = getAccounts();
                const currentAccountId = getCurrentAccountId();
                const currentAccount = getCurrentAccount();
                
                // 更新当前账号信息
                if (currentAccount) {
                    currentAccountInfoElement.textContent = `当前账号: ${currentAccount.name}`;
                } else {
                    currentAccountInfoElement.textContent = '未选择账号';
                }
                
                // 添加账号项
                accounts.forEach(account => {
                    const accountItem = document.createElement('div');
                    accountItem.style.cssText = `
                        padding: 8px;
                        margin-bottom: 5px;
                        border-radius: 4px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        ${account.id === currentAccountId ? 'background: rgba(135, 206, 250, 0.8);' : 'background: rgba(135, 206, 250, 0.6);'}
                    `;
                    
                    const accountInfo = document.createElement('span');
                    accountInfo.textContent = account.name;
                    if (account.id === currentAccountId) {
                        accountInfo.style.fontWeight = 'bold';
                    }
                    
                    const actions = document.createElement('div');
                    actions.style.display = 'flex';
                    actions.style.gap = '5px';
                    
                    // 切换按钮
                    if (account.id !== currentAccountId) {
                        const switchBtn = document.createElement('button');
                        switchBtn.textContent = '切换';
                        switchBtn.style.cssText = 'padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
                        switchBtn.addEventListener('click', () => handleSwitchAccount(account.id));
                        actions.appendChild(switchBtn);
                    }
                    
                    // 重命名按钮
                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = '重命名';
                    renameBtn.style.cssText = 'padding: 4px 8px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
                    renameBtn.addEventListener('click', () => handleRenameAccount(account.id, account.name));
                    actions.appendChild(renameBtn);
                    
                    // 删除按钮（至少保留一个账号）
                    if (accounts.length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '删除';
                        deleteBtn.style.cssText = 'padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
                        deleteBtn.addEventListener('click', () => handleDeleteAccount(account.id, account.name));
                        actions.appendChild(deleteBtn);
                    }
                    
                    accountItem.appendChild(accountInfo);
                    accountItem.appendChild(actions);
                    accountsListElement.appendChild(accountItem);
                });
                
            } catch (e) {
                console.error('更新账号列表失败:', e);
            }
        }
        
        // 处理创建账号
        function handleCreateAccount() {
            const nameInput = document.getElementById('new-account-name');
            const accountName = nameInput.value.trim() || '新账号';
            
            const newAccount = createAccount(accountName);
            if (newAccount) {
                nameInput.value = '';
                updateAccountsList();
                alert(`账号创建成功: ${newAccount.name}`);
            } else {
                alert('账号创建失败');
            }
        }
        
        // 处理切换账号
        function handleSwitchAccount(accountId) {
            if (confirm('确定要切换账号吗？当前账号进度将自动保存。')) {
                if (switchAccount(accountId)) {
                    updateAccountsList();
                    alert('账号切换成功');
                } else {
                    alert('账号切换失败');
                }
            }
        }
        
        // 处理重命名账号
        function handleRenameAccount(accountId, currentName) {
            const newName = prompt('请输入新的账号名称:', currentName);
            if (newName !== null) {
                const trimmedName = newName.trim();
                if (trimmedName) {
                    if (renameAccount(accountId, trimmedName)) {
                        updateAccountsList();
                        alert('账号重命名成功');
                    } else {
                        alert('账号重命名失败');
                    }
                } else {
                    alert('账号名称不能为空');
                }
            }
        }
        
        // 处理删除账号
        function handleDeleteAccount(accountId, accountName) {
            if (confirm(`确定要删除账号 "${accountName}" 吗？该操作不可恢复。`)) {
                if (deleteAccount(accountId)) {
                    updateAccountsList();
                    alert('账号删除成功');
                } else {
                    alert('账号删除失败或无法删除最后一个账号');
                }
            }
        }
        
        function updateUI() {
            try {
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { 
                        level: 1, 
                        exp: 0, 
                        gold: 0, 
                        trophies: 0, 
                        gameStage: 1, 
                        treeLevel: 1, 
                        treeExp: 0, 
                        autoMiningEnabled: false,
                        resources: {} // 初始化资源对象
                    };
                }
                
                // 确保resources对象存在
                if (!window.gameState.resources) {
                    window.gameState.resources = {};
                }
                
                // 更新基本状态
                const levelElement = document.getElementById("level");
                const expElement = document.getElementById("exp");
                const expNeededElement = document.getElementById("exp-needed");
                const goldElement = document.getElementById("gold");
                const trophiesElement = document.getElementById("trophies");
                const totalDamageElement = document.getElementById("total-damage");
                
                if (levelElement) levelElement.textContent = window.gameState.level;
                if (expElement) expElement.textContent = formatNumber(window.gameState.exp);
                if (expNeededElement) expNeededElement.textContent = formatNumber(getExpNeeded(window.gameState.level));
                if (goldElement) goldElement.textContent = formatNumber(window.gameState.gold);
                if (trophiesElement) trophiesElement.textContent = formatNumber(window.gameState.trophies);
                if (totalDamageElement) totalDamageElement.textContent = formatNumber(calculateTotalDamage());
                
                // 更新游戏阶段（使用updateGameStageDisplay函数）
                updateGameStageDisplay();
                
                // 根据游戏阶段更新标签可见性
                updateTabsVisibility();
                
                // 更新自动挖矿状态
                const autoMiningToggle = document.getElementById("auto-mining-toggle");
                if (autoMiningToggle) {
                    autoMiningToggle.textContent = window.gameState.autoMiningEnabled ? "关闭自动挖矿" : "开启自动挖矿";
                }
                
                // 更新树系统
                const treeLevelElement = document.getElementById("tree-level");
                const treeExpElement = document.getElementById("tree-exp");
                const treeExpNeededElement = document.getElementById("tree-exp-needed");
                const treeBoostElement = document.getElementById("tree-boost");
                const treeSystemElement = document.getElementById("tree-system");
                
                if (treeLevelElement) treeLevelElement.textContent = window.gameState.treeLevel || 1;
                if (treeExpElement) treeExpElement.textContent = window.gameState.treeExp || 0;
                if (treeExpNeededElement) treeExpNeededElement.textContent = 10 * (window.gameState.treeLevel || 1);
                
                // 第二阶段才显示树系统和树增益
                if (treeSystemElement) {
                    treeSystemElement.style.display = (window.gameState.main2Unlocked === 1) ? "block" : "none";
                }
                
                if (treeBoostElement) {
                    // 永久显示浇树增益
                    treeBoostElement.textContent = "浇树增益: " + calculateTreeBoost().toFixed(2);
                    treeBoostElement.style.display = "block";
                    // 确保可见性
                    treeBoostElement.style.visibility = "visible";
                    treeBoostElement.style.opacity = "1";
                }
                
                // 正常使用游戏阶段判断，不需要临时设置
                
                // 浇树增益显示逻辑 - 永久显示
                const treeBoostElementStats = document.getElementById('tree-boost');
                if (treeBoostElementStats) {
                    // 确保统计面板和增益面板使用相同的计算方法
                    const treeBoost = Math.pow(window.gameState.treeLevel || 1, 0.4);
                    treeBoostElementStats.textContent = "浇树增益: " + treeBoost.toFixed(2);
                    treeBoostElementStats.style.display = "block";
                    treeBoostElementStats.style.visibility = "visible";
                    treeBoostElementStats.style.opacity = "1";
                }
                
                // 能量增益显示逻辑 - 永久显示
                const energyBoostElement = document.getElementById('energy-boost');
                if (energyBoostElement) {
                    // 计算能量增益值（根据主线3第一阶段的要求：α能量转化器的能量增益=(α能量+1)^0.1）
                    const alphaEnergy = window.gameState.energies?.alpha || 0;
                    const energyBoost = Math.pow(alphaEnergy + 1, 0.1);
                    
                    // 更新内容并确保显示元素
                    energyBoostElement.textContent = "能量增益: " + energyBoost.toFixed(2);
                    energyBoostElement.style.display = "block";
                    energyBoostElement.style.visibility = "visible";
                    energyBoostElement.style.opacity = "1";
                }
                
                // 更新成就列表
                const achievementsList = document.getElementById("achievements-list");
                if (achievementsList) {
                    achievementsList.innerHTML = "";
                    
                    // 定义所有可能的成就
                    const allAchievements = [
                        { id: "初入游戏", name: "初入游戏", description: "开始你的挖矿之旅" },
                        { id: "获得奖杯", name: "获得奖杯", description: "第一次兑换奖杯" },
                        { id: "伤害一万", name: "伤害一万", description: "总伤害≥1e4" },
                        { id: "伤害一亿", name: "伤害一亿", description: "总伤害≥1e8" },
                        { id: "伤害一万亿", name: "伤害一万亿", description: "总伤害≥1e12" },
                        { id: "伤害一兆", name: "伤害一兆", description: "总伤害≥1e16" },
                        { id: "伤害一万兆", name: "伤害一万兆", description: "总伤害≥1e20" },
                        { id: "红蓝镐", name: "红蓝镐", description: "获得红蓝镐" },
                        { id: "只因你太美", name: "只因你太美", description: "获得坤坤" },
                        { id: "五行镐", name: "五行镐", description: "获得五行镐" },
                        { id: "炼药", name: "炼药", description: "开始炼药" },
                        { id: "浇树", name: "浇树", description: "第一次浇树" }
                    ];
                    
                    // 确保成就对象存在
                    if (!window.gameState.achievements) {
                        window.gameState.achievements = {};
                    }
                    
        

                }
            }
            catch (updateUIError) {
                console.error('更新UI失败:', updateUIError);
            }
            
            // 更新炼药价值显示
            const alchemyValueAmountElement = document.getElementById("alchemy-value-amount");
            if (alchemyValueAmountElement) alchemyValueAmountElement.textContent = formatNumber(window.gameState.alchemyValue || 0);
            
            // 更新经验条
            const expBarElement = document.getElementById("exp-bar");
            if (expBarElement) {
                const expNeeded = getExpNeeded(window.gameState.level);
                const expPercent = Math.min(100, (window.gameState.exp / expNeeded) * 100);
                expBarElement.style.width = `${expPercent}%`;
            }
            
            // 更新当前方块信息
            try {
                const currentBlock = gameData.blocks[window.gameState.currentBlockCategory][window.gameState.currentBlockIndex];
                const currentHp = window.gameState.blockHp[window.gameState.currentBlockCategory]?.[window.gameState.currentBlockIndex];
                
                const blockNameElement = document.getElementById("block-name");
                const blockHpElement = document.getElementById("block-hp");
                const blockRewardsElement = document.getElementById("block-rewards");
                
                if (blockNameElement && currentBlock) blockNameElement.textContent = currentBlock.name;
                if (blockHpElement && currentBlock && currentHp) {
                    blockHpElement.textContent = `${formatNumber(currentHp)}/${formatNumber(currentBlock.hp)}`;
                }
                
                if (blockRewardsElement && currentBlock) {
                    let rewardsText = `基础奖励: ${currentBlock.baseGold}金币`;
                    if (currentBlock.special) {
                        // 限制概率显示不超过100%
                        const specialChance = Math.min(100, currentBlock.special.chance * 10 * 100);
                        rewardsText += `, ${specialChance}%概率掉落${currentBlock.special.item}`;
                    }
                    // 添加普通掉落概率显示，并确保显示×10后的概率且不超过100%
                    if (currentBlock.dropChance && currentBlock.dropItem) {
                        // 限制概率显示不超过100%
                        const displayChance = Math.min(100, currentBlock.dropChance * 10 * 100);
                        rewardsText += `, ${displayChance}%概率掉落${currentBlock.dropItem}`;
                    }
                    blockRewardsElement.textContent = rewardsText;
                }
            } catch (e) {
                console.error('更新方块信息失败:', e);
            }
            
            // 更新当前镐子信息
            try {
                let currentPickaxeData = null;
                for (const shopCategory in gameData.pickaxes) {
                    currentPickaxeData = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                    if (currentPickaxeData) break;
                }
                
                const currentPickaxeElement = document.getElementById("current-pickaxe");
                const pickaxeBoostElement = document.getElementById("pickaxe-boost");
                const goldMultiplierElement = document.getElementById("gold-multiplier");
                const usageGainElement = document.getElementById("usage-gain");
                
                if (currentPickaxeElement) currentPickaxeElement.textContent = window.gameState.currentPickaxe;
                if (pickaxeBoostElement) pickaxeBoostElement.textContent = currentPickaxeData ? currentPickaxeData.boost : 1;
                if (goldMultiplierElement) goldMultiplierElement.textContent = currentPickaxeData ? currentPickaxeData.goldMultiplier : 1;
                if (usageGainElement) usageGainElement.textContent = currentPickaxeData ? currentPickaxeData.usageGain : 0.01;
            } catch (e) {
                console.error('更新镐子信息失败:', e);
            }
            
            // 更新增益显示
            const usageBoostElement = document.getElementById("usage-boost");
            const trophyBoostElement = document.getElementById("trophy-boost");
            const levelBoostElement = document.getElementById("level-boost");
            const alchemyBoostElement = document.getElementById("alchemy-boost");
            
            if (usageBoostElement) usageBoostElement.textContent = formatNumber(window.gameState.usageBoost);
            if (trophyBoostElement) trophyBoostElement.textContent = calculateTrophyBoost(window.gameState.trophies).toFixed(2);
            if (levelBoostElement) levelBoostElement.textContent = calculateLevelBoost(window.gameState.level).toFixed(2);
            if (alchemyBoostElement) alchemyBoostElement.textContent = formatNumber(window.gameState.alchemyBoost);
            
            // 更新兑换信息
            const convertInfoElement = document.getElementById("convert-info");
            if (convertInfoElement) {
                const trophiesFromGold = calculateTrophies(window.gameState.gold);
                convertInfoElement.textContent = `当前可兑换: ${formatNumber(trophiesFromGold)} 奖杯`;
            }
            
            // 更新增益列表
            try {
                updateBoostsList();
            } catch (e) {
                console.error('更新增益列表失败:', e);
            }
            
            // 更新资源列表
            try {
                updateResourcesList();
            } catch (e) {
                console.error('更新资源列表失败:', e);
            }
            
            // 更新商店
            try {
                updateShop();
            } catch (e) {
                console.error('更新商店失败:', e);
            }
        }

        // 更新增益列表
        function updateBoostsList() {
            const boostsList = document.getElementById("boosts-list");
            boostsList.innerHTML = "";
            
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            
            const boosts = [
                { name: "镐子增益", value: pickaxeBoost },
                { name: "使用增益", value: window.gameState.usageBoost },
                { name: "奖杯增益", value: calculateTrophyBoost(window.gameState.trophies).toFixed(2) },
                { name: "等级增益", value: calculateLevelBoost(window.gameState.level).toFixed(2) },
                { name: "炼药增益", value: window.gameState.alchemyBoost } // 所有阶段都显示炼药增益
            ];
            
            // 第二阶段及以上才添加浇树增益
            if (window.gameState && window.gameState.main2Unlocked === 1) {
                boosts.push({ name: "浇树增益", value: calculateTreeBoost().toFixed(2) });
                
                // 游戏阶段≥第三阶段第一部分时，在浇树增益下方添加能量增益
                if (window.gameState.gameStage >= 3 || window.gameState.gameStage === 3.1 || window.gameState.gameStage === 3.01) {
                    // 计算能量增益值（根据主线3第一阶段的要求：α能量转化器的能量增益=(α能量+1)^0.1）
                    const alphaEnergy = window.gameState.energies?.alpha || 0;
                    const energyBoost = Math.pow(alphaEnergy + 1, 0.1);
                    boosts.push({ name: "能量增益", value: energyBoost.toFixed(2) });
                }
            }
            
            // 第三阶段及以上添加研究所相关增益
            if (window.gameState && window.gameState.gameStage >= 3) {
                // 能量增益已在上面的条件分支中添加，避免重复显示
                // 可以在这里添加其他研究所相关增益
            }
            
            boosts.forEach(boost => {
                const boostItem = document.createElement("div");
                boostItem.className = "boost-item";
                boostItem.innerHTML = `
                    <div>${boost.name}</div>
                    <div>${formatNumber(boost.value)}</div>
                `;
                boostsList.appendChild(boostItem);
            });
        }

        // 更新资源列表
        function updateResourcesList() {
            const resourcesList = document.getElementById("resources-list");
            resourcesList.innerHTML = "";
            
            Object.entries(window.gameState.resources).forEach(([resource, amount]) => {
                if (amount > 0) {
                    const resourceItem = document.createElement("div");
                    resourceItem.className = "resource-item";
                    resourceItem.innerHTML = `
                        <div>${resource}</div>
                        <div>${formatNumber(amount)}</div>
                    `;
                    resourcesList.appendChild(resourceItem);
                }
            });
        }

        // 更新商店
        function updateShop() {
            const shopItems = document.getElementById("shop-items");
            shopItems.innerHTML = "";
            
            const activeShop = document.querySelector(".shop-categories .category-btn.active").dataset.shop;
            if (!gameData.pickaxes.side) {
                gameData.pickaxes.side = [];
                for (var i = 0; i < gameData.pickaxes.main1.length; i++) {
                    gameData.pickaxes.side.push(gameData.pickaxes.main1[i]);
                }
            }
            const shopData = gameData.pickaxes[activeShop];
            
            if (shopData) {
                shopData.forEach(item => {
                    const shopItem = document.createElement("div");
                    shopItem.className = "shop-item";
                    
                    let costText = "";
                    let canBuy = true;
                    
                    if (item.cost.trophies) {
                        costText = `奖杯: ${item.cost.trophies}`;
                        if (window.gameState.trophies < item.cost.trophies) canBuy = false;
                    } else if (item.cost.fragments) {
                        costText = Object.entries(item.cost.fragments).map(([frag, amount]) => `${frag}: ${amount}`).join(", ");
                        if (item.cost.basePickaxe) {
                            costText += `, 需要: ${item.cost.basePickaxe}`;
                            if (window.gameState.pickaxes[item.cost.basePickaxe] < 1) canBuy = false;
                        } else if (item.cost.basePickaxes) {
                            costText += `, 需要: ${item.cost.basePickaxes.join(", ")}`;
                            for (const pick of item.cost.basePickaxes) {
                                if (window.gameState.pickaxes[pick] < 1) canBuy = false;
                            }
                        }
                        if (item.cost.usageBoost) {
                            costText += `, 使用增益: ${formatNumber(item.cost.usageBoost)}`;
                            // 对于"使用镐"，需要使用增益大于1e12才能购买
                            if (item.name === "使用镐" && window.gameState.usageBoost <= 1e12) {
                                canBuy = false;
                                // 添加一个特殊标记，用于后续样式处理
                                isPickaxeDisabled = true;
                            }
                            // 其他使用usageBoost的物品保持原逻辑
                            else if (window.gameState.usageBoost < item.cost.usageBoost) {
                                canBuy = false;
                            }
                        }
                        
                        // 添加α/β/γ能量的显示和检查
                        if (item.cost.alpha) {
                            costText += `, α能量: ${formatNumber(item.cost.alpha)}`;
                            if ((window.gameState.energies?.alpha || 0) < item.cost.alpha) canBuy = false;
                        }
                        if (item.cost.beta) {
                            costText += `, β能量: ${formatNumber(item.cost.beta)}`;
                            if ((window.gameState.energies?.beta || 0) < item.cost.beta) canBuy = false;
                        }
                        if (item.cost.gamma) {
                            costText += `, γ能量: ${formatNumber(item.cost.gamma)}`;
                            if ((window.gameState.energies?.gamma || 0) < item.cost.gamma) canBuy = false;
                        }
                        // 添加普通能量的显示和检查
                        if (item.cost.energy) {
                            costText += `, 能量: ${formatNumber(item.cost.energy)}`;
                            if ((window.gameState.resources?.energy || 0) < item.cost.energy) canBuy = false;
                        }
                        // 添加使用增益的显示（在前面的usageBoost条件之外再添加一次显示，确保始终显示）
                        if (item.cost.usage && !costText.includes("使用增益")) {
                            costText += `, 使用增益: ${formatNumber(item.cost.usage)}`;
                            if (window.gameState.usageBoost < item.cost.usage) canBuy = false;
                        }
                        
                        for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                            if (frag.includes("镐")) {
                                // 如果是镐子，检查数量
                                if (window.gameState.pickaxes[frag] < amount) canBuy = false;
                            } else if (frag === "药叶") {
                                // 特殊处理药叶资源
                                if ((window.gameState.resources[frag] || 0) < amount) canBuy = false;
                            } else {
                                // 如果是其他资源，检查数量
                                if (window.gameState.resources[frag] < amount) canBuy = false;
                            }
                        }
                    }
                    
                    // 显示镐子数量
                    const pickaxeCount = item.boost ? `<span class="pickaxe-count">${window.gameState.pickaxes[item.name] || 0}</span>` : "";
                    const useButton = item.boost ? `<button class="pickaxe-use-btn ${window.gameState.currentPickaxe === item.name ? 'active' : ''}" data-pickaxe="${item.name}">${window.gameState.currentPickaxe === item.name ? '使用中' : '使用'}</button>` : "";
                    
                    // 金奖转化器开关按钮 - 只有当玩家已拥有时才显示
                    const trophyConverterToggle = item.name === "金奖转化器" && window.gameState.resources && (window.gameState.resources["金奖转化器"] || 0) >= 1 ? 
                        `<button class="trophy-converter-toggle ${window.gameState.trophyConverterEnabled ? 'active' : ''}" onclick="toggleTrophyConverter()">
                            ${window.gameState.trophyConverterEnabled ? '已开启' : '已关闭'}
                        </button>` : "";
                    
                    shopItem.innerHTML = `
                        <div class="shop-item-header">
                            <div>${item.name} ${pickaxeCount} ${useButton} ${trophyConverterToggle}</div>
                            <div>${costText}</div>
                        </div>
                        ${item.boost ? `<div>增益: ${item.boost}, 金币倍率: ${item.goldMultiplier}, 使用增益增加: ${item.usageGain}</div>` : ""}
                        ${item.name === "金奖转化器" ? '<div style="font-size: 12px; color: #666; margin: 5px 0;">每秒自动将金币转化为奖杯</div>' : ""}
                        <button class="buy-btn" data-item="${item.name}" ${!canBuy || (item.name === "使用镐" && window.gameState.usageBoost <= 1e12) ? 'disabled' : ''} style="${item.name === "使用镐" && window.gameState.usageBoost <= 1e12 ? 'background-color: #666 !important; color: #fff !important; cursor: not-allowed !important; opacity: 0.7 !important;' : ''}">购买</button>
                    `;
                    
                    shopItems.appendChild(shopItem);
                });
            }
            
            // 添加购买按钮事件监听
            document.querySelectorAll(".buy-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const itemName = this.dataset.item;
                    buyItem(itemName);
                });
            });
            
            // 添加使用按钮事件监听
            document.querySelectorAll(".pickaxe-use-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const pickaxeName = this.dataset.pickaxe;
                    if (window.gameState.pickaxes[pickaxeName] >= 1) {
                          window.gameState.currentPickaxe = pickaxeName;
                        updateUI();
                    }
                });
            });
        }
        
        // 添加金奖转化器开关按钮的样式和禁用购买按钮的样式
        (function() {
            const style = document.createElement('style');
            style.textContent = `
                /* 基础购买按钮样式 */
                .buy-btn {
                    background-color: var(--primary);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                }
                
                .buy-btn:hover:not(:disabled) {
                    background-color: var(--primary-dark);
                    transform: translateY(-2px);
                }
                
                /* 禁用状态样式 */
                .buy-btn:disabled {
                    background-color: #666 !important;
                    color: #fff !important;
                    cursor: not-allowed !important;
                    opacity: 0.7 !important;
                    transform: none !important;
                    box-shadow: none !important;
                }
                
                /* 使用镐特殊禁用样式 - 强制覆盖所有其他样式 */
                .buy-btn[data-item="使用镐"] {
                    background-color: #666 !important;
                    color: #fff !important;
                    cursor: not-allowed !important;
                    opacity: 0.7 !important;
                    transform: none !important;
                    box-shadow: none !important;
                }
                
                .trophy-converter-toggle {
                    padding: 4px 8px;
                    margin-left: 8px;
                    font-size: 12px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .trophy-converter-toggle.active {
                    background-color: #4CAF50;
                    color: white;
                }
                
                .trophy-converter-toggle:not(.active) {
                    background-color: #f44336;
                    color: white;
                }
                
                .trophy-converter-toggle:hover {
                    opacity: 0.8;
                }
            `;
            document.head.appendChild(style);
        })();

        // 购买物品
        function buyItem(itemName) {
            try {
                // 优化查找逻辑，分别在不同商店中查找物品
                let item = null;
                for (const shopCategory in gameData.pickaxes) {
                    item = gameData.pickaxes[shopCategory].find(p => p.name === itemName);
                    if (item) break;
                }
                
                if (!item) return;
                
                // 检查是否满足购买条件
                let canBuy = true;
                
                if (item.cost.trophies) {
                    if (window.gameState.trophies < item.cost.trophies) canBuy = false;
                }
                
                if (item.cost.fragments) {
                    for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                        if (frag.includes("镐")) {
                            // 如果是镐子，检查数量
                            if (window.gameState.pickaxes[frag] < amount) canBuy = false;
                        } else if (frag === "药叶") {
                            // 特殊处理药叶资源
                            if ((window.gameState.resources[frag] || 0) < amount) canBuy = false;
                        } else {
                            // 如果是其他资源，检查数量
                            if (window.gameState.resources[frag] < amount) canBuy = false;
                        }
                    }
                    
                    if (item.cost.basePickaxe && window.gameState.pickaxes[item.cost.basePickaxe] < 1) canBuy = false;
                    
                    if (item.cost.basePickaxes) {
                        for (const pick of item.cost.basePickaxes) {
                            if (window.gameState.pickaxes[pick] < 1) canBuy = false;
                        }
                    }
                    
                    // 检查α/β/γ能量是否足够
                    if (item.cost.alpha && (window.gameState.energies?.alpha || 0) < item.cost.alpha) canBuy = false;
                    if (item.cost.beta && (window.gameState.energies?.beta || 0) < item.cost.beta) canBuy = false;
                    if (item.cost.gamma && (window.gameState.energies?.gamma || 0) < item.cost.gamma) canBuy = false;
                }
                
                // 无论是否有fragments成本，都需要检查usageBoost条件
                // 对于"使用镐"，需要使用增益大于1e12才能购买
                if (item.name === "使用镐" && window.gameState.usageBoost <= 1e12) canBuy = false;
                // 其他使用usageBoost的物品保持原逻辑
                else if (item.cost.usageBoost && window.gameState.usageBoost < item.cost.usageBoost && item.name !== "使用镐") canBuy = false;
                
                if (canBuy) {
                    // 扣除成本
                    if (item.cost.trophies) {
                        window.gameState.trophies -= item.cost.trophies;
                    }
                    
                    if (item.cost.fragments) {
                        for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                            if (frag.includes("镐")) {
                                // 如果是镐子，减少数量
                                window.gameState.pickaxes[frag] = Math.max(0, (window.gameState.pickaxes[frag] || 0) - amount);
                            } else {
                                // 如果是资源，减少数量
                                window.gameState.resources[frag] = Math.max(0, (window.gameState.resources[frag] || 0) - amount);
                            }
                        }
                    }
                    
                    // 扣除basePickaxe（单个基础镐子）
                    if (item.cost.basePickaxe) {
                        window.gameState.pickaxes[item.cost.basePickaxe] = Math.max(0, (window.gameState.pickaxes[item.cost.basePickaxe] || 0) - 1);
                    }
                    
                    // 扣除basePickaxes（多个基础镐子）
                    if (item.cost.basePickaxes) {
                        for (const pick of item.cost.basePickaxes) {
                            window.gameState.pickaxes[pick] = Math.max(0, (window.gameState.pickaxes[pick] || 0) - 1);
                        }
                    }
                    
                    // 扣除使用增益
                    if (item.cost.usageBoost) {
                        window.gameState.usageBoost -= item.cost.usageBoost;
                        // 确保使用增益不会低于1
                        window.gameState.usageBoost = Math.max(1, window.gameState.usageBoost);
                    }
                    
                    // 扣除α/β/γ能量
                    if (item.cost.alpha) {
                        if (!window.gameState.energies) window.gameState.energies = {};
                        window.gameState.energies.alpha = Math.max(0, (window.gameState.energies.alpha || 0) - item.cost.alpha);
                    }
                    if (item.cost.beta) {
                        if (!window.gameState.energies) window.gameState.energies = {};
                        window.gameState.energies.beta = Math.max(0, (window.gameState.energies.beta || 0) - item.cost.beta);
                    }
                    if (item.cost.gamma) {
                        if (!window.gameState.energies) window.gameState.energies = {};
                        window.gameState.energies.gamma = Math.max(0, (window.gameState.energies.gamma || 0) - item.cost.gamma);
                    }
                    
                    // 修复：确保从fragments中扣除镐子
                    if (item.cost.fragments) {
                        for (const [frag, amount] of Object.entries(item.cost.fragments)) {
                            if (frag.includes("镐")) {
                                // 确保扣除镐子
                                window.gameState.pickaxes[frag] = Math.max(0, (window.gameState.pickaxes[frag] || 0) - amount);
                                console.log(`已扣除${amount}个${frag}`);
                            }
                        }
                    }
                    
                    // 增加物品
                    if (item.boost) {
                        // 是镐子
                        window.gameState.pickaxes[item.name] = (window.gameState.pickaxes[item.name] || 0) + 1;
                    } else {
                        // 是物品
                        window.gameState.resources[item.name] = (window.gameState.resources[item.name] || 0) + 1;
                    }
                    
                    // 更新UI
                    updateUI();
                    // 保存游戏状态
                    saveGame();
                    // 显示成功提示
                    showSaveNotification();
                    
                    // 检查成就
                    try {
                        if (typeof checkAchievements === 'function') {
                    
                            console.log('购买后成就检查已执行');
                        }
                    } catch (achievementError) {
                        console.error('检查成就失败:', achievementError);
                    }
                }
            } catch (e) {
                console.error('购买物品失败:', e);
                // 手动触发更新UI
                updateUI();
            }
        }

        // 浇树功能 - 使用水立方
        function waterTreeWithCube() {
            try {
                // 移除阶段限制，允许随时浇树
                // 原阶段限制代码已删除
                
                // 检查是否有水立方
                if ((window.gameState.resources && window.gameState.resources["水立方"] || 0) < 1) {
                    alert("水立方不足！");
                    return;
                }
                
                // 扣除水立方
                window.gameState.resources["水立方"] -= 1;
                
                // 增加树经验
                const expGain = 5;
                window.gameState.treeExp = (window.gameState.treeExp || 0) + expGain;
                
                // 检查是否可以升级，使用while循环确保经验足够时自动连续升级
                let expNeededForNextLevel;
                while (true) {
                    expNeededForNextLevel = 10 * window.gameState.treeLevel;
                    if (window.gameState.treeExp >= expNeededForNextLevel) {
                        window.gameState.treeLevel += 1;
                        window.gameState.treeExp -= expNeededForNextLevel;
                    } else {
                        break;
                    }
                }
                
                // 更新UI
                updateUI();
                
                // 显示结果
                const resultsElement = document.getElementById('water-tree-results');
                if (resultsElement) {
                    const currentExpNeeded = 10 * window.gameState.treeLevel;
                    resultsElement.textContent = `成功浇树！消耗1个水立方，树经验增加到${window.gameState.treeExp}/${currentExpNeeded}，树等级：${window.gameState.treeLevel}`;
                }
            } catch (e) {
                console.error('浇树失败:', e);
            }
        }
        


        
        // 自动挖矿定时器
        let autoMiningInterval = null;
        
        // 切换自动挖矿
        function toggleAutoMining() {
            try {
                window.gameState.autoMiningEnabled = !window.gameState.autoMiningEnabled;
                
                // 更新按钮文本和样式
                const autoMiningToggle = document.getElementById("auto-mining-toggle");
                if (autoMiningToggle) {
                    autoMiningToggle.textContent = window.gameState.autoMiningEnabled ? "关闭自动挖矿" : "开启自动挖矿";
                    // 更新按钮样式
                    if (window.gameState.autoMiningEnabled) {
                        autoMiningToggle.style.backgroundColor = '#f44336'; // 红色表示开启状态
                    } else {
                        autoMiningToggle.style.backgroundColor = '#4CAF50'; // 绿色表示关闭状态
                    }
                }
                
                if (window.gameState.autoMiningEnabled) {
                    // 自动挖矿间隔永久为0
                    const miningInterval = 0;
                    autoMiningInterval = setInterval(() => {
                        // 每次自动点击执行78次或91次挖矿（随机选择）
                        const clickCount = Math.random() > 0.5 ? 78 : 91;
                        for (let i = 0; i < clickCount; i++) {
                            mineBlock(true); // 传入参数表示自动挖矿
                        }
                    }, miningInterval);
                } else {
                    if (autoMiningInterval) {
                        clearInterval(autoMiningInterval);
                        autoMiningInterval = null;
                    }
                }
                
                updateUI();
            } catch (e) {
                console.error('切换自动挖矿失败:', e);
            }
        }
        
        // 检查游戏阶段
        function checkGameStage() {
            try {
                // 确保window.gameState对象正确初始化
                if (!window.gameState) {
                    window.gameState = { gameStage: 1, pickaxes: {}, main2Unlocked: 0, main3Unlocked: 0 };
                    return;
                }
                
                // 确保游戏阶段和必要变量正确初始化
                if (!window.gameState.gameStage) {
                    window.gameState.gameStage = 1;
                }
                if (window.gameState.main2Unlocked === undefined) {
                    window.gameState.main2Unlocked = 0;
                }
                if (window.gameState.main3Unlocked === undefined) {
                    window.gameState.main3Unlocked = 0;
                }
                
                // 确保pickaxes对象正确初始化
                if (!window.gameState.pickaxes) {
                    window.gameState.pickaxes = {};
                    return;
                }
                
                const pickaxes = window.gameState.pickaxes;
                
                // 根据用户要求更新主线解锁状态
                // 只要到过主线2，就将main2Unlocked设为1
                if (pickaxes["五行镐"] > 0 && window.gameState.main2Unlocked === 0) {
                    window.gameState.main2Unlocked = 1;
                }
                
                // 只要到过主线3，就将main3Unlocked设为1
                if (pickaxes["源镐"] > 0 && window.gameState.main3Unlocked === 0) {
                    window.gameState.main3Unlocked = 1;
                }
                
                // 按优先级检查游戏阶段条件
                // 第三阶段第二部分："???"数量≥0
                if (window.gameState.resources && window.gameState.resources["???"] >= 0) {
                    window.gameState.gameStage = 3.1; // 使用3.1表示第三阶段第二部分
                    updateTabsVisibility();
                    updateBoostsList();
                }
                // 第三阶段第一部分：main3Unlocked为1
                else if (window.gameState.main3Unlocked === 1) {
                    window.gameState.gameStage = 3;
                    updateTabsVisibility();
                    updateBoostsList();
                }
                // 第二阶段：main2Unlocked为1
                else if (window.gameState.main2Unlocked === 1) {
                    window.gameState.gameStage = 2;
                    updateTabsVisibility();
                    updateBoostsList();
                }
            } catch (e) {
                console.error('检查游戏阶段失败:', e);
            }
        }
        
        // 计算浇树增益
        function calculateTreeBoost() {
            return Math.pow(window.gameState.treeLevel || 1, 0.4);
        }
        
        // 计算转化器增益
        function calculateConverterBoost() {
            if (!window.gameState.energies || !window.gameState.converters) return 1;
            
            let boost = 1;
            const { energies, converters } = window.gameState;
            
            // 每个活跃的转化器根据其对应的能量提供增益
            if (converters.alpha && energies.alpha > 0) {
                boost *= Math.pow(energies.alpha + 1, 0.1); // α能量增益=(α能量+1)^0.1
            }
            if (converters.beta && energies.beta > 0) {
                boost *= 1 + (energies.beta * 0.02); // 每点β能量提供2%增益
            }
            if (converters.gamma && energies.gamma > 0) {
                boost *= 1 + (energies.gamma * 0.03); // 每点γ能量提供3%增益
            }
            
            return boost;
        }
        
        // 计算量产器增益
        function calculateProducerBoost() {
            if (!window.gameState.producers) return 1;
            
            let boost = 1;
            const { producers } = window.gameState;
            
            // 每个量产器提供基础增益，并根据数量累加
            if (producers.alpha > 0) {
                boost *= 1 + (producers.alpha * 0.2); // 每个α量产器提供20%增益
            }
            if (producers.beta > 0) {
                boost *= 1 + (producers.beta * 0.3); // 每个β量产器提供30%增益
            }
            if (producers.gamma > 0) {
                boost *= 1 + (producers.gamma * 0.5); // 每个γ量产器提供50%增益
            }
            
            return boost;
        }
        
        // 计算总伤害（包含树增益）
        function calculateTotalDamage() {
            // 优化镐子查找逻辑
            let pickaxeBoost = 1;
            for (const shopCategory in gameData.pickaxes) {
                const pickaxe = gameData.pickaxes[shopCategory].find(p => p.name === window.gameState.currentPickaxe);
                if (pickaxe) {
                    pickaxeBoost = pickaxe.boost;
                    break;
                }
            }
            const trophyBoost = calculateTrophyBoost(window.gameState.trophies);
            const levelBoost = calculateLevelBoost(window.gameState.level);
            
            // 基础伤害计算
            let totalDamage = pickaxeBoost * window.gameState.usageBoost * trophyBoost * levelBoost * window.gameState.alchemyBoost;
            
            // 第二阶段添加树增益
            if (window.gameState.gameStage >= 2) {
                totalDamage *= calculateTreeBoost();
            }
            
            // 第三阶段添加研究所增益
            if (window.gameState.gameStage >= 3) {
                // 根据主线三第一阶段要求，只使用能量增益
                const alphaEnergy = window.gameState.energies?.alpha || 0;
                const energyBoost = Math.pow(alphaEnergy + 1, 0.1);
                totalDamage *= energyBoost;
            }
            
            // 保留两位小数
            return parseFloat(totalDamage.toFixed(2));
        }
        
        // 显示通知
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.padding = '10px 20px';
            notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            notification.style.color = 'white';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '10000';
            notification.style.fontSize = '16px';
            notification.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.3)';
            notification.style.opacity = '0';
            
            // 添加到文档
            document.body.appendChild(notification);
            
            // 淡入效果
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s ease';
                notification.style.opacity = '1';
            }, 10);
            
            // 2秒后淡出并移除
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // 挖掘方块
        function mineBlock(isAutoMining = false) {
            try {
                // 确保window.gameState存在
                if (!window.gameState) {
                    window.gameState = { 
                        gold: 0, 
                        trophies: 0, 
                        gameStage: 1, 
                        totalDamage: 0,
                        usageBoost: 0,
                        blockHp: {},
                        currentBlockCategory: "main1",
                        currentBlockIndex: 0,
                        currentPickaxe: "木镐"
                    };
                }
                
                // 确保currentBlockCategory是字符串而不是数字
                if (typeof window.gameState.currentBlockCategory === 'number') {
                    window.gameState.currentBlockCategory = "main1";
                }
                
                // 安全获取当前分类和索引
                const category = window.gameState.currentBlockCategory;
                const index = window.gameState.currentBlockIndex;
                
                // 验证数据结构
                if (!gameData || !gameData.blocks || !gameData.blocks[category] || !gameData.blocks[category][index]) {
                    console.error(`错误: 无效的方块数据 - 分类: ${category}, 索引: ${index}`);
                    return;
                }
                
                const currentBlock = gameData.blocks[category][index];
                
                // 初始化blockHp结构
                if (!window.gameState.blockHp) {
                    window.gameState.blockHp = {};
                }
                if (!window.gameState.blockHp[category]) {
                    window.gameState.blockHp[category] = [];
                }
                
                // 初始化当前方块血量
                if (window.gameState.blockHp[category][index] === undefined) {
                    window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                }
                
                // 优化镐子查找逻辑
                let currentPickaxeData = null;
                try {
                    if (gameData.pickaxes) {
                        for (const shopCategory in gameData.pickaxes) {
                            if (Array.isArray(gameData.pickaxes[shopCategory])) {
                                currentPickaxeData = gameData.pickaxes[shopCategory].find(p => p && p.name === window.gameState.currentPickaxe);
                                if (currentPickaxeData) break;
                            }
                        }
                    }
                } catch (pickaxeError) {
                    console.error('查找镐子失败:', pickaxeError);
                    // 使用默认镐子数据
                    currentPickaxeData = { boost: 1, goldMultiplier: 1, usageGain: 0.01 };
                }
                
                // 计算总伤害
                let totalDamage = 0;
                try {
                    totalDamage = calculateTotalDamage();
                    // 确保伤害至少为1
                    totalDamage = Math.max(1, totalDamage || 1);
                } catch (damageError) {
                    console.error('计算伤害失败:', damageError);
                    totalDamage = 1; // 默认最小伤害
                }
                
                // 累计总伤害
                window.gameState.totalDamage = (window.gameState.totalDamage || 0) + totalDamage;
                
                // 更新标题显示伤害数值
                updateTitleDamage();
                
                // 增加使用增益 - 根据当前使用的镐子的usageGain属性
                try {
                    // 确保usageBoost存在
                    if (window.gameState.usageBoost === undefined) {
                        window.gameState.usageBoost = 1;
                    }
                    
                    // 获取当前镐子的usageGain值
                    const usageGain = currentPickaxeData?.usageGain || 0.01; // 默认0.01
                    
                    // 计算β能量使用增益倍增效果
                    let betaUsageBoostMultiplier = 1;
                    const { converters, energies } = window.gameState;
                    if (converters?.beta && energies?.beta > 0) {
                        // β能量使用增益倍增 = (β能量+1)^0.4
                        betaUsageBoostMultiplier = Math.pow(energies.beta + 1, 0.4);
                    }
                    
                    // 计算最终使用增益：镐子自带使用增益 * β能量使用增益倍增
                    const finalUsageGain = usageGain * betaUsageBoostMultiplier;
                    
                    // 增加使用增益
                    window.gameState.usageBoost += finalUsageGain;
                } catch (usageBoostError) {
                    console.error('增加使用增益失败:', usageBoostError);
                }
                
                // 显示伤害数字（仅手动挖矿时显示）
                if (!isAutoMining) {
                    try {
                        showDamagePopup(totalDamage);
                    } catch (popupError) {
                        console.error('显示伤害弹窗失败:', popupError);
                    }
                }
                
                // 安全更新方块血量
                try {
                    window.gameState.blockHp[category][index] -= totalDamage;
                    // 确保血量不会低于0
                    window.gameState.blockHp[category][index] = Math.max(0, window.gameState.blockHp[category][index]);
                } catch (hpError) {
                    console.error('更新方块血量失败:', hpError);
                }
                
                // 检查方块是否被挖掉
                if (window.gameState.blockHp[category][index] <= 0) {
                    try {
                        // 计算获得的金币和经验
                        const baseGold = currentBlock.baseGold || 10;
                        const goldMultiplier = currentPickaxeData?.goldMultiplier || 1;
                        
                        const goldGained = baseGold * goldMultiplier;
                        const expGained = goldGained;
                        
                        // 更新游戏状态
                        window.gameState.gold = (window.gameState.gold || 0) + goldGained;
                        window.gameState.exp = (window.gameState.exp || 0) + expGained;
                        
                        // 处理特殊掉落(special.chance)
                        if (currentBlock.special && currentBlock.special.chance) {
                            // 所有方块爆率×10，超过100%则设为100%
                            const enhancedDropChance = Math.min(currentBlock.special.chance * 10, 1.0);
                            if (Math.random() < enhancedDropChance) {
                            const itemName = currentBlock.special.item;
                            if (itemName) {
                                // 计算掉落数量：向上取整(原爆率×10 × 原掉落数量)
                                const originalChance = currentBlock.special.chance;
                                const originalCount = currentBlock.special.count || 1;
                                const dropCount = Math.ceil(originalChance * 10 * originalCount);
                                
                                // 根据掉落类型进行不同处理
                                if (currentBlock.special.type === 'pickaxe') {
                                    // 处理镐子掉落
                                    if (!window.gameState.pickaxes) {
                                        window.gameState.pickaxes = {};
                                    }
                                    window.gameState.pickaxes[itemName] = (window.gameState.pickaxes[itemName] || 0) + dropCount;
                                    // 显示获得镐子的通知
                                    showNotification(`获得了 ${dropCount} 把${itemName}！`);
                                } else {
                                    // 处理普通资源掉落
                                    if (!window.gameState.resources) {
                                        window.gameState.resources = {};
                                    }
                                    window.gameState.resources[itemName] = (window.gameState.resources[itemName] || 0) + dropCount;
                                    // 显示获得资源的通知
                                    showNotification(`获得了 ${dropCount} 个${itemName}！`);
                                }
                            }
                        }
                        }
                        
                        // 处理普通掉落(dropChance)
                        if (currentBlock.dropChance && currentBlock.dropItem) {
                            // 所有方块爆率×10，超过100%则设为100%
                            const enhancedDropChance = Math.min(currentBlock.dropChance * 10, 1.0);
                            if (Math.random() < enhancedDropChance) {
                                // 计算掉落数量
                                const actualDropAmount = currentBlock.dropChance >= 1.0 ? 
                                    (currentBlock.dropAmount || 1) * 10 : 
                                    (currentBlock.dropAmount || 1);
                                
                                // 处理不同类型的掉落物品
                                if (currentBlock.dropItem === 'iridium') {
                                    window.gameState.iridiumIngots = (window.gameState.iridiumIngots || 0) + actualDropAmount;
                                    showNotification(`获得了 ${actualDropAmount} 个铱锭！`);
                                } else if (currentBlock.dropItem === 'hassium') {
                                    window.gameState.hassiumIngots = (window.gameState.hassiumIngots || 0) + actualDropAmount;
                                    showNotification(`获得了 ${actualDropAmount} 个𬭶锭！`);
                                } else if (currentBlock.dropItem === 'singularity') {
                                    window.gameState.singularity = (window.gameState.singularity || 0) + actualDropAmount;
                                    showNotification(`获得了 ${actualDropAmount} 个奇点！`);
                                } else if (currentBlock.dropItem === 'endCore') {
                                    window.gameState.endCore = (window.gameState.endCore || 0) + actualDropAmount;
                                    showNotification(`获得了 ${actualDropAmount} 个终焉核心！`);
                                } else {
                                    // 处理其他可能的掉落物品
                                    if (!window.gameState.resources) {
                                        window.gameState.resources = {};
                                    }
                                    window.gameState.resources[currentBlock.dropItem] = 
                                        (window.gameState.resources[currentBlock.dropItem] || 0) + actualDropAmount;
                                    showNotification(`获得了 ${actualDropAmount} 个${currentBlock.dropItem}！`);
                                }
                            }
                        }
                        
                        // 重置方块血量
                        window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                        
                        // 检查升级
                        try {
                            checkLevelUp();
                        } catch (levelError) {
                            console.error('检查升级失败:', levelError);
                        }
                        
                        // 检查成就
                        try {
                            if (typeof checkAchievements === 'function') {
                
                                console.log('成就检查已执行');
                            }
                        } catch (achievementError) {
                            console.error('检查成就失败:', achievementError);
                        }
                        
                        // 保存游戏
                        try {
                            saveGame();
                        } catch (saveError) {
                            console.error('保存游戏失败:', saveError);
                        }
                    } catch (rewardError) {
                        console.error('处理奖励失败:', rewardError);
                        // 重置方块血量，确保游戏能继续进行
                        window.gameState.blockHp[category][index] = currentBlock.hp || 100;
                    }
                }
                
                // 更新UI
                try {
                    updateUI();
                } catch (uiError) {
                    console.error('更新UI失败:', uiError);
                }
            } catch (e) {
                console.error('挖掘方块主函数失败:', e);
            }
        }

        // 显示伤害数字
        function showDamagePopup(damage) {
            try {
                const blockDisplay = document.getElementById("block-display");
                if (!blockDisplay) return;
                
                const popup = document.createElement("div");
                popup.className = "damage-popup";
                popup.textContent = `-${damage.toFixed(2)}`;
                popup.style.left = `${Math.random() * 60 + 20}%`;
                popup.style.top = `${Math.random() * 20 + 40}%`;
                
                // 初始化样式，确保动画正常工作
                popup.style.opacity = '0';
                popup.style.transition = 'all 0.4s ease-out';
                popup.style.transform = 'translateY(0)';
                
                blockDisplay.appendChild(popup);
                
                // 强制重绘后开始动画
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // 渐显动画
                        popup.style.opacity = '1';
                        popup.style.transform = 'translateY(-20px)';
                    });
                });
                
                // 缩短的动画周期，立即开始渐消效果
                setTimeout(() => {
                    try {
                        if (blockDisplay && blockDisplay.contains(popup)) {
                            // 平滑淡出效果
                            popup.style.opacity = '0';
                            popup.style.transform = 'translateY(-40px)';
                            
                            setTimeout(() => {
                                if (blockDisplay && blockDisplay.contains(popup)) {
                                    blockDisplay.removeChild(popup);
                                }
                            }, 400);
                        }
                    } catch (e) {
                        console.error('移除伤害弹窗失败:', e);
                    }
                }, 1500); // 调整动画时间
            } catch (e) {
                console.error('显示伤害数字失败:', e);
            }
        }

        // 检查升级
        function checkLevelUp() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 安全获取当前经验和等级
                const currentExp = window.gameState.exp || 0;
                const currentLevel = window.gameState.level || 1;
                
                // 循环检查是否可以升级
                let updatedLevel = currentLevel;
                let remainingExp = currentExp;
                let leveledUp = false;
                
                // 防止无限循环，设置最大升级次数限制
                const maxLevelAttempts = 100;
                let attempts = 0;
                
                while (attempts < maxLevelAttempts) {
                    attempts++;
                    
                    try {
                        const expNeeded = getExpNeeded(updatedLevel);
                        
                        // 确保expNeeded是有效数字
                        if (typeof expNeeded !== 'number' || isNaN(expNeeded) || expNeeded <= 0) {
                            console.error('无效的经验需求值:', expNeeded);
                            break;
                        }
                        
                        if (remainingExp < expNeeded) {
                            break;
                        }
                        
                        // 足够升级
                        remainingExp -= expNeeded;
                        updatedLevel += 1;
                        leveledUp = true;
                    } catch (levelCalcError) {
                        console.error('计算升级经验需求失败:', levelCalcError);
                        break;
                    }
                }
                
                // 只有实际升级时才更新状态
                if (leveledUp) {
                    window.gameState.level = updatedLevel;
                    window.gameState.exp = remainingExp;
                    
                    // 检查成就
                    try {
                        if (typeof checkAchievements === 'function') {
        
                            console.log('升级后成就检查已执行');
                        }
                    } catch (achievementError) {
                        console.error('检查成就失败:', achievementError);
                    }
                    
                    // 尝试创建简单的升级提示（如果body存在）
                    try {
                        if (document.body) {
                            const notification = document.createElement('div');
                            notification.textContent = `升级! 等级 ${updatedLevel}`;
                            notification.style.position = 'fixed';
                            notification.style.top = '50%';
                            notification.style.left = '50%';
                            notification.style.transform = 'translate(-50%, -50%)';
                            notification.style.backgroundColor = 'rgba(0, 200, 0, 0.8)';
                            notification.style.color = 'white';
                            notification.style.padding = '10px 20px';
                            notification.style.borderRadius = '5px';
                            notification.style.zIndex = '1000';
                            
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                try {
                                    if (notification.parentNode === document.body) {
                                        document.body.removeChild(notification);
                                    }
                                } catch (removeError) {
                                    // 静默失败
                                }
                            }, 1500);
                        }
                    } catch (popupError) {
                        // 静默失败，不影响游戏逻辑
                    }
                }
            } catch (e) {
                console.error('检查升级失败:', e);
            }
        }

        // 更新游戏阶段显示 - 在游戏标题下方显示游戏阶段
        function updateGameStageDisplay() {
            try {
                const stageElement = document.getElementById('game-stage');
                if (!stageElement) return;
                
                // 确保window.gameState正确初始化
                if (!window.gameState) {
                    window.gameState = { 
                        main2Unlocked: 0, 
                        main3Unlocked: 0, 
                        resources: { "???": 0 }
                    };
                }
                
                // 获取游戏状态变量
                const main2Unlocked = window.gameState.main2Unlocked || 0;
                const main3Unlocked = window.gameState.main3Unlocked || 0;
                const questionMarksCount = (window.gameState.resources && window.gameState.resources["???"]) || 0;
                
                // 根据解锁状态和资源数量显示相应的阶段文本
                if (main3Unlocked === 1 && questionMarksCount >= 0) {
                    stageElement.textContent = '当前阶段：第三阶段第二部分';
                } else if (main3Unlocked === 1) {
                    stageElement.textContent = '当前阶段：第三阶段第一部分';
                } else if (main2Unlocked === 1) {
                    stageElement.textContent = '当前阶段：第二阶段';
                } else {
                    stageElement.textContent = '当前阶段：第一阶段';
                }
            } catch (e) {
                console.error('更新游戏阶段显示失败:', e);
            }
        }
        
        // 浇树功能 - 使用树系统的逻辑
        function waterTree() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, main2Unlocked: 0 };
                }
                
                // 检查是否到达阶段2（使用main2Unlocked变量）
                if (window.gameState.main2Unlocked !== 1) {
                    alert('需要到达第二阶段才能解锁浇树系统！');
                    return;
                }
            } catch (e) {
                console.error('浇树功能错误:', e);
            }
        }

        // 浇树功能 - 使用水结晶
        function waterTreeWithCrystal() {
            try {
                // 移除阶段限制，允许随时浇树
                // 原阶段限制代码已删除
                
                // 检查是否有水结晶
                if ((window.gameState.resources && window.gameState.resources["水结晶"] || 0) < 1) {
                    alert("水结晶不足！");
                    return;
                }
                
                // 扣除水结晶
                window.gameState.resources["水结晶"] -= 1;
                
                // 增加树经验
                const expGain = 100;
                window.gameState.treeExp = (window.gameState.treeExp || 0) + expGain;
                
                // 检查是否可以升级，使用while循环确保经验足够时自动连续升级
                let expNeededForNextLevel;
                while (true) {
                    expNeededForNextLevel = 10 * window.gameState.treeLevel;
                    if (window.gameState.treeExp >= expNeededForNextLevel) {
                        window.gameState.treeLevel += 1;
                        window.gameState.treeExp -= expNeededForNextLevel;
                    } else {
                        break;
                    }
                }
                
                // 更新UI
                updateUI();
                
                // 显示结果
                const resultsElement = document.getElementById('water-tree-results');
                if (resultsElement) {
                    const currentExpNeeded = 10 * window.gameState.treeLevel;
                    resultsElement.textContent = `成功浇树！消耗1个水结晶，树经验增加到${window.gameState.treeExp}/${currentExpNeeded}，树等级：${window.gameState.treeLevel}`;
                }
            } catch (e) {
                console.error('浇树过程出错:', e);
            }
        }
        
        // 浇树功能 - 使用淼立方
        function waterTreeWithTripleCube() {
            try {
                // 移除阶段限制，允许随时浇树
                // 原阶段限制代码已删除
                
                // 检查是否有淼立方
                if ((window.gameState.resources && window.gameState.resources["淼立方"] || 0) < 1) {
                    alert("淼立方不足！");
                    return;
                }
                
                // 扣除淼立方
                window.gameState.resources["淼立方"] -= 1;
                
                // 增加树经验
                const expGain = 500;
                window.gameState.treeExp = (window.gameState.treeExp || 0) + expGain;
                
                // 检查是否可以升级，使用while循环确保经验足够时自动连续升级
                let expNeededForNextLevel;
                while (true) {
                    expNeededForNextLevel = 10 * window.gameState.treeLevel;
                    if (window.gameState.treeExp >= expNeededForNextLevel) {
                        window.gameState.treeLevel += 1;
                        window.gameState.treeExp -= expNeededForNextLevel;
                    } else {
                        break;
                    }
                }
                
                // 更新UI
                updateUI();
                
                // 显示结果
                const resultsElement = document.getElementById('water-tree-results');
                if (resultsElement) {
                    const currentExpNeeded = 10 * window.gameState.treeLevel;
                    resultsElement.textContent = `成功浇树！消耗1个淼立方，树经验增加到${window.gameState.treeExp}/${currentExpNeeded}，树等级：${window.gameState.treeLevel}`;
                }
            } catch (e) {
                console.error('浇树过程出错:', e);
            }
        }
        
        // 更新树木UI - 树系统版本
        function updateTreeUI() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, main2Unlocked: 0 };
                }
                
                // 更新浇树区域的树系统UI
                const treeLevelElement = document.getElementById('tree-level');
                const treeExpElement = document.getElementById('tree-exp');
                const treeExpNeededElement = document.getElementById('tree-exp-needed');
                const treeExpBarElement = document.getElementById('tree-exp-bar');
                
                if (treeLevelElement && treeExpElement && treeExpNeededElement && treeExpBarElement) {
                    const treeLevel = window.gameState.treeLevel || 1;
                    const treeExp = window.gameState.treeExp || 0;
                    const treeExpNeeded = treeLevel * 10;
                    const expPercentage = (treeExp / treeExpNeeded) * 100;
                    
                    treeLevelElement.textContent = treeLevel;
                    treeExpElement.textContent = treeExp;
                    treeExpNeededElement.textContent = treeExpNeeded;
                    treeExpBarElement.style.width = `${expPercentage}%`;
                }
                
                // 更新浇树按钮状态
                const waterTreeCubeBtn = document.getElementById('water-tree-cube-btn');
                const waterTreeCrystalBtn = document.getElementById('water-tree-crystal-btn');
                const waterTreeTripleBtn = document.getElementById('water-tree-triple-btn');
                
                const isStage2 = window.gameState && window.gameState.main2Unlocked === 1;
                
                if (waterTreeCubeBtn) {
                    waterTreeCubeBtn.disabled = !isStage2;
                    waterTreeCubeBtn.textContent = '浇树 (消耗1个水立方)'; // 一直显示实际文本
                }
                if (waterTreeCrystalBtn) {
                    waterTreeCrystalBtn.disabled = !isStage2;
                    waterTreeCrystalBtn.textContent = '浇树 (消耗1个水结晶)'; // 一直显示实际文本
                }
                if (waterTreeTripleBtn) {
                    waterTreeTripleBtn.disabled = !isStage2;
                    waterTreeTripleBtn.textContent = '浇树 (消耗1个淼立方)'; // 一直显示实际文本
                }
            } catch (e) {
                console.error('更新树木UI失败:', e);
            }
        }
        
        // 自定义的UI更新函数，避免循环引用
        function updateCustomUI() {
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0, gameStage: 1 };
                }
                
                // 更新游戏阶段显示
                updateGameStageDisplay();
                
                // 总是更新树木UI（即使没有treeData）
                updateTreeUI();
                
                // 更新兑换信息显示
                const convertInfoElement = document.getElementById('convert-info');
                if (convertInfoElement && window.gameState.gold !== undefined) {
                    const currentGold = window.gameState.gold;
                    let trophiesAvailable = 0;
                    if (currentGold >= 100) {
                        trophiesAvailable = calculateTrophies(currentGold);
                    }
                    convertInfoElement.textContent = `当前可兑换: ${trophiesAvailable} 奖杯`;
                }
            } catch (e) {
                console.error('更新自定义UI失败:', e);
            }
        }
        
        // 确保gameState存在
        if (!window.gameState) {
            window.gameState = {
                gold: 0,
                trophies: 0,
                gameStage: 1
            };
        }
        

        
        // 页面加载完成后初始化更新自定义UI和成就列表
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟一点时间确保DOM完全加载
            setTimeout(() => {
                updateCustomUI();
                // 注释掉未定义的函数调用
                // initAchievementsList();
            }, 100);
        });
        
        // 实时更新兑换信息显示
        function updateConvertInfo() {
            try {
                if (!window.gameState) return;
                
                const currentGold = parseFloat(window.gameState.gold || 0);
                let trophiesAvailable = 0;
                
                if (currentGold >= 100) {
                    trophiesAvailable = Math.floor(Math.pow(currentGold / 100, 0.8));
                }
                
                const convertInfoElement = document.getElementById('convert-info');
                if (convertInfoElement) {
                    convertInfoElement.textContent = `当前可兑换: ${formatNumber(trophiesAvailable)} 奖杯`;
                }
            } catch (error) {
                console.error('更新兑换信息失败:', error);
            }
        }
        
        // 全新的兑换金币为奖杯函数
        function convertGoldToTrophies() {
            console.log('兑换函数开始执行');
            
            try {
                // 确保gameState存在且有必要的属性
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0 };
                    console.warn('创建了新的gameState');
                }
                
                // 初始化属性
                window.gameState.gold = parseFloat(window.gameState.gold || 0);
                window.gameState.trophies = parseFloat(window.gameState.trophies || 0);
                
                const currentGold = window.gameState.gold;
                console.log(`当前金币: ${currentGold}`);
                
                // 检查金币是否足够
                if (currentGold < 100) {
                    alert('金币不足100，无法兑换奖杯');
                    return;
                }
                
                // 计算可兑换的奖杯数量
                const trophiesFromGold = Math.floor(Math.pow(currentGold / 100, 0.8));
                console.log(`兑换计算：${currentGold}金币可兑换${trophiesFromGold}奖杯`);
                
                if (trophiesFromGold <= 0) {
                    alert('计算错误，无法兑换奖杯');
                    return;
                }
                
                // 执行兑换
                window.gameState.trophies += trophiesFromGold;
                window.gameState.gold = 0;
                
                // 直接更新UI
                const goldElement = document.getElementById('gold');
                if (goldElement) goldElement.textContent = formatNumber(window.gameState.gold);
                
                const trophiesElement = document.getElementById('trophies');
                if (trophiesElement) trophiesElement.textContent = formatNumber(window.gameState.trophies);
                
                const convertInfoElement = document.getElementById('convert-info');
                if (convertInfoElement) convertInfoElement.textContent = '当前可兑换: 0 奖杯';
                
                // 更新奖杯增益
                const trophyBoostElement = document.getElementById('trophy-boost');
                if (trophyBoostElement) {
                    const boost = 1 + Math.pow(window.gameState.trophies, 0.4);
                    trophyBoostElement.textContent = boost.toFixed(2);
                }
                
                // 保存游戏状态
                try {
                    localStorage.setItem('miningGameState', JSON.stringify(window.gameState));
                    console.log('游戏状态已保存');
                } catch (e) {
                    console.error('保存失败:', e);
                }
                
                alert(`兑换成功！获得 ${trophiesFromGold} 奖杯`);
                console.log('兑换成功完成');
            } catch (error) {
                console.error('兑换过程出错:', error);
                alert('兑换失败，请刷新页面后重试');
            }
        }
        
        // 全新的一键获取炼药价值函数 - 基于特定物品计算
        window.newConvertToAlchemy = function() {
            try {
                console.log('[特定物品转换] 开始一键获取炼药价值...');
                
                // 按钮点击时的视觉反馈
                const button = document.getElementById('convert-alchemy-btn');
                if (button) {
                    button.style.backgroundColor = '#3d8b40';
                    button.style.borderColor = '#2e7d32';
                }
                
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { resources: {} };
                    console.warn('创建了新的gameState');
                }
                
                // 确保resources对象存在
                if (!window.gameState.resources) {
                    window.gameState.resources = {};
                }
                
                // 定义需要转换的物品及其系数
                const itemsToConvert = [
                    { name: '下界之星', coefficient: 1 },
                    { name: '基岩碎片', coefficient: 5 },
                    { name: '坤坤', coefficient: 25 },
                    { name: '木核心', coefficient: 50 },
                    { name: '土核心', coefficient: 80 },
                    { name: '水立方', coefficient: 120 },
                    { name: '火立方', coefficient: 160 },
                    { name: '金立方', coefficient: 200 }
                ];
                
                let totalValue = 0;
                let hasConvertedItems = false;
                
                // 计算炼药价值并清空物品
                itemsToConvert.forEach(itemData => {
                    const itemCount = window.gameState.resources[itemData.name] || 0;
                    if (itemCount > 0) {
                        const itemValue = itemCount * itemData.coefficient;
                        totalValue += itemValue;
                        // 清空物品数量
                        window.gameState.resources[itemData.name] = 0;
                        hasConvertedItems = true;
                        console.log(`转换 ${itemData.name}: ${itemCount}个 × ${itemData.coefficient} = ${itemValue}`);
                    }
                });
                
                // 如果有转换的物品，更新炼药价值
                if (hasConvertedItems) {
                    // 更新炼药价值
                    window.gameState.alchemyValue = (window.gameState.alchemyValue || 0) + totalValue;
                    
                    // 直接更新UI
                    const alchemyValueElement = document.getElementById("alchemy-value-amount");
                    if (alchemyValueElement) {
                        if (typeof formatNumber === 'function') {
                            alchemyValueElement.textContent = formatNumber(window.gameState.alchemyValue);
                        } else {
                            alchemyValueElement.textContent = window.gameState.alchemyValue.toString();
                        }
                        
                        // 添加数值增长动画效果
                        alchemyValueElement.style.transition = 'color 0.3s ease';
                        alchemyValueElement.style.color = '#4CAF50';
                        setTimeout(() => {
                            alchemyValueElement.style.color = '';
                        }, 1000);
                    }
                    
                    // 保存游戏状态到localStorage
                    try {
                        const gameStateStr = JSON.stringify(window.gameState);
                        localStorage.setItem('miningGameState', gameStateStr);
                        console.log('游戏状态保存成功');
                    } catch (saveError) {
                        console.error('保存游戏状态失败:', saveError);
                    }
                    
                    // 更新资源列表显示
                    if (typeof updateResourcesList === 'function') {
                        try {
                            updateResourcesList();
                        } catch (updateError) {
                            console.error('更新资源列表失败:', updateError);
                        }
                    }
                    
                    console.log(`成功转换物品，获得 ${totalValue} 炼药价值`);
                } else {
                    // 没有可转换的物品，显示提示
                    const resultsElement = document.getElementById("alchemy-results") || 
                                          (function() {
                                              const div = document.createElement('div');
                                              div.id = 'alchemy-results';
                                              div.style.marginTop = '10px';
                                              div.style.padding = '15px';
                                              div.style.borderRadius = '8px';
                                              div.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                                              if (button) {
                                                  button.after(div);
                                              }
                                              return div;
                                          })();
                    
                    // 显示"暂无可转换物品"提示
                    resultsElement.innerHTML = `
                        <div style="color: #FF9800; font-weight: bold; text-align: center; padding: 15px;">
                            暂无可转换物品
                        </div>
                        <div style="text-align: center; color: #666;">
                            当前需要以下物品才能转换：下界之星、基岩碎片、坤坤、木核心、土核心、水立方、火立方、金立方
                        </div>
                    `;
                    console.log('没有指定的可转换物品');
                }
                
                // 恢复按钮状态
                if (button) {
                    setTimeout(() => {
                        button.style.backgroundColor = '';
                        button.style.borderColor = '#4CAF50';
                    }, 300);
                }
                
            } catch (error) {
                console.error('一键获取炼药价值失败:', error);
                
                // 恢复按钮状态
                const button = document.getElementById('convert-alchemy-btn');
                if (button) {
                    setTimeout(() => {
                        button.style.backgroundColor = '';
                        button.style.borderColor = '#4CAF50';
                    }, 300);
                }
            }
        };
        
        // 保留原有函数作为备份
        window.convertAllToAlchemy = function() {
            try {
                console.log('[全新] 开始一键换取炼药价值...');
                
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { resources: {} };
                    console.warn('创建了新的gameState');
                }
                
                // 确保resources对象存在
                if (!window.gameState.resources) {
                    window.gameState.resources = {};
                }
                
                let totalValue = 0;
                let convertedItems = [];
                
                // 先清空结果显示区
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = '<div style="color: #9C27B0;">正在转换物品...</div>';
                }
                
                // 检查炼药价值数据
                if (!window.gameData || !window.gameData.alchemyValues || typeof window.gameData.alchemyValues !== 'object') {
                    console.error('炼药价值数据缺失');
                    if (resultsElement) {
                        resultsElement.innerHTML = '<div style="color: red;">炼药系统数据未加载，请刷新页面</div>';
                    }
                    return;
                }
                
                // 转换所有可转换的物品
                for (const [item, value] of Object.entries(window.gameData.alchemyValues)) {
                    try {
                        const itemCount = window.gameState.resources[item] || 0;
                        if (itemCount > 0) {
                            const numericValue = Number(value);
                            if (!isNaN(numericValue) && numericValue > 0) {
                                const itemValue = Math.floor(itemCount * numericValue);
                                totalValue += itemValue;
                                convertedItems.push(`${item}: ${itemCount}个`);
                                window.gameState.resources[item] = 0; // 清空已转换物品
                            }
                        }
                    } catch (itemError) {
                        console.error(`处理物品 ${item} 时出错:`, itemError);
                        // 跳过出错的物品，继续处理其他物品
                    }
                }
                
                // 执行转换
                if (totalValue > 0) {
                    // 更新炼药价值
                    window.gameState.alchemyValue = (window.gameState.alchemyValue || 0) + totalValue;
                    
                    // 直接更新UI
                    const alchemyValueElement = document.getElementById("alchemy-value-amount");
                    if (alchemyValueElement) {
                        if (typeof formatNumber === 'function') {
                            alchemyValueElement.textContent = formatNumber(window.gameState.alchemyValue);
                        } else {
                            alchemyValueElement.textContent = window.gameState.alchemyValue.toString();
                        }
                    }
                    
                    // 保存游戏状态到localStorage
                    try {
                        const gameStateStr = JSON.stringify(window.gameState);
                        localStorage.setItem('miningGameState', gameStateStr);
                        console.log('游戏状态保存成功');
                        
                        // 显示保存成功通知
                        showSaveNotification();
                    } catch (saveError) {
                        console.error('保存游戏状态失败:', saveError);
                    }
                    
                    // 更新资源列表显示
                    if (typeof updateResourcesList === 'function') {
                        try {
                            updateResourcesList();
                        } catch (updateError) {
                            console.error('更新资源列表失败:', updateError);
                        }
                    }
                    
                    // 显示成功结果
                    if (resultsElement) {
                        resultsElement.innerHTML = `
                            <div style="color: green; font-weight: bold;">转换成功！</div>
                            <div>成功转换以下物品:</div>
                            <div style="margin: 5px 0; font-family: monospace;">${convertedItems.join('<br>')}</div>
                            <div style="color: #9C27B0; font-weight: bold;">共获得 ${typeof formatNumber === 'function' ? formatNumber(totalValue) : totalValue} 炼药价值</div>
                        `;
                    }
                    
                    // 触发成就
                    if (window.gameState.achievements) {
                        window.gameState.achievements['炼药'] = true;
                    }
                    
                    // 记录日志
                    console.log(`成功转换 ${convertedItems.length} 种物品，获得 ${totalValue} 炼药价值`);
                } else {
                    // 没有可转换的物品
                    if (resultsElement) {
                        resultsElement.innerHTML = '<div style="color: orange;">没有可转换的物品</div>';
                    }
                    console.log('没有可转换的物品');
                }
                
            } catch (error) {
                console.error('一键换取炼药价值失败:', error);
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = `<div style="color: red;">转换过程中发生错误: ${error.message || '未知错误'}</div><div>请刷新页面后重试</div>`;
                }
            }
        };
        
        // 重写的炼药函数
        window.handleAlchemy = function() {
            try {
                console.log('开始炼药...');
                
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = {};
                }
                
                // 获取输入值
                const valueInputElement = document.getElementById("alchemy-value-input");
                const timesInputElement = document.getElementById("alchemy-times");
                
                if (!valueInputElement || !timesInputElement) {
                    alert('缺少必要的输入元素');
                    return;
                }
                
                // 验证并获取参数
                let valuePerTime = Math.max(1, Math.floor(Number(valueInputElement.value) || 1));
                let times = Math.max(1, Math.min(10000, Math.floor(Number(timesInputElement.value) || 1)));
                
                const currentAlchemyValue = window.gameState.alchemyValue || 0;
                const totalValueNeeded = valuePerTime * times;
                
                // 检查炼药价值是否足够
                if (currentAlchemyValue < valuePerTime) {
                    alert(`炼药价值不足！当前: ${formatNumber(currentAlchemyValue)}, 需要: ${formatNumber(valuePerTime)}`);
                    return;
                }
                
                // 调整次数
                if (currentAlchemyValue < totalValueNeeded) {
                    times = Math.floor(currentAlchemyValue / valuePerTime);
                    timesInputElement.value = times;
                }
                
                const adjustedTotalValue = valuePerTime * times;
                
                // 扣除炼药价值
                window.gameState.alchemyValue = currentAlchemyValue - adjustedTotalValue;
                
                // 初始化统计
                let exploded = 0;
                let gained1 = 0;
                let gained10 = 0;
                let gained100 = 0;
                let totalGained = 0;
                
                const currentAlchemyBoost = Math.max(1, window.gameState.alchemyBoost || 1);
                
                // 执行炼药
                for (let i = 0; i < times; i++) {
                    let explodeChance = 0.5 / Math.pow(valuePerTime, 0.4);
                    explodeChance = Math.max(0.01, Math.min(0.99, explodeChance));
                    
                    let gain1Chance = 0;
                    let gain10Chance = 0;
                    let gain100Chance = 0;
                    
                    if (valuePerTime < 100) {
                        gain1Chance = 0.4 * Math.pow(currentAlchemyBoost, 0.1);
                        gain10Chance = 1 - explodeChance - gain1Chance;
                    } else {
                        gain1Chance = 0.4 / Math.pow(currentAlchemyBoost, 0.6);
                        gain10Chance = 0.4 * Math.pow(valuePerTime / 100, 0.4);
                        gain10Chance = Math.min(0.5, gain10Chance);
                        gain100Chance = 1 - explodeChance - gain1Chance - gain10Chance;
                    }
                    
                    // 确保概率有效
                    gain1Chance = Math.max(0, Math.min(1 - explodeChance, gain1Chance));
                    gain10Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance, gain10Chance));
                    gain100Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance - gain10Chance, gain100Chance));
                    
                    const rand = Math.random();
                    
                    if (rand < explodeChance) {
                        exploded++;
                    } else if (rand < explodeChance + gain1Chance) {
                        gained1++;
                        totalGained += 1;
                    } else if (rand < explodeChance + gain1Chance + gain10Chance) {
                        gained10++;
                        totalGained += 10;
                    } else {
                        gained100++;
                        totalGained += 100;
                    }
                }
                
                // 更新炼药增益
                window.gameState.alchemyBoost = currentAlchemyBoost + totalGained;
                
                // 更新UI
                const alchemyValueElement = document.getElementById("alchemy-value-amount");
                if (alchemyValueElement && typeof formatNumber === 'function') {
                    alchemyValueElement.textContent = formatNumber(window.gameState.alchemyValue);
                }
                
                // 保存游戏状态
                try {
                    localStorage.setItem('miningGameState', JSON.stringify(window.gameState));
                    console.log('游戏状态保存成功');
                } catch (e) {
                    console.error('保存失败:', e);
                }
                
                // 显示结果
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    const avgPerTime = times > 0 ? totalGained / times : 0;
                    const avgPerValue = adjustedTotalValue > 0 ? totalGained / adjustedTotalValue : 0;
                    
                    resultsElement.innerHTML = `
                        <div>本次共消耗 ${formatNumber(adjustedTotalValue)} 炼药价值，炼药 ${times} 次</div>
                        <div>炸锅 ${exploded} 次，获得1炼药增益 ${gained1} 次</div>
                        <div>获得10炼药增益 ${gained10} 次，获得100炼药增益 ${gained100} 次</div>
                        <div>共获得 ${formatNumber(totalGained)} 炼药增益</div>
                        <div>平均每次炼药获得 ${avgPerTime.toFixed(2)} 炼药增益</div>
                        <div>平均每炼药值获得 ${avgPerValue.toFixed(4)} 炼药增益</div>
                    `;
                }
                
                console.log('炼药完成');
            } catch (e) {
                console.error('炼药失败:', e);
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = "炼药过程中发生错误，请重试";
                }
            }
        };

        // 一键换取炼药价值
        function convertToAlchemyValue() {
            try {
                let totalValue = 0;
                let convertedItems = [];
                
                // 安全检查游戏数据
                if (!gameData || !gameData.alchemyValues || typeof gameData.alchemyValues !== 'object') {
                    throw new Error('无效的炼药价值数据');
                }
                
                // 确保resources对象存在
                if (!gameState.resources) {
                    gameState.resources = {};
                }
                
                // 计算所有可转换物品的价值
                for (const [item, value] of Object.entries(gameData.alchemyValues)) {
                    try {
                        const itemCount = gameState.resources[item] || 0;
                        if (itemCount > 0) {
                            const numericValue = Number(value);
                            if (isNaN(numericValue) || numericValue <= 0) {
                                console.warn(`跳过无效价值物品: ${item}, 价值: ${value}`);
                                continue;
                            }
                            
                            const itemValue = itemCount * numericValue;
                            totalValue += itemValue;
                            convertedItems.push(`${item}: ${itemCount}个`);
                            gameState.resources[item] = 0;
                        }
                    } catch (itemError) {
                        console.error(`处理物品 ${item} 时出错:`, itemError);
                        // 跳过出错的物品，继续处理其他物品
                    }
                }
                
                if (totalValue > 0) {
                    // 安全更新炼药价值
                    gameState.alchemyValue = (gameState.alchemyValue || 0) + totalValue;
                    
                    // 尝试更新UI
                    try {
                        updateUI();
                    } catch (uiError) {
                        console.error('更新UI失败:', uiError);
                    }
                }
                
                // 显示转换结果
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    if (totalValue > 0) {
                        resultsElement.innerHTML = `
                            <div>成功转换以下物品:</div>
                            <div>${convertedItems.join(', ')}</div>
                            <div>共获得 ${formatNumber(totalValue)} 炼药价值</div>
                        `;
                    } else {
                        resultsElement.innerHTML = "没有可转换的物品";
                    }
                }
            } catch (e) {
                console.error('转换炼药价值失败:', e);
                // 安全显示错误信息
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = "转换过程中发生错误，请重试";
                }
            }
        }

        // 炼药
        function performAlchemy() {
            try {
                // 获取并验证输入参数
                const valueInputElement = document.getElementById("alchemy-value-input");
                const timesInputElement = document.getElementById("alchemy-times");
                
                if (!valueInputElement || !timesInputElement) {
                    throw new Error('缺少必要的输入元素');
                }
                
                // 安全解析输入值
                let valuePerTime = Math.max(1, Math.floor(Number(valueInputElement.value) || 1));
                let times = Math.max(1, Math.min(10000, Math.floor(Number(timesInputElement.value) || 1)));
                
                // 验证参数有效性
                if (valuePerTime < 1 || times < 1 || times > 10000) {
                    alert("请输入有效的炼药参数！单次价值和次数必须为1-10000的整数。");
                    return;
                }
                
                const currentAlchemyValue = gameState.alchemyValue || 0;
                const totalValueNeeded = valuePerTime * times;
                
                // 如果当前拥有的炼药价值小于单次价值，无法炼药
                if (currentAlchemyValue < valuePerTime) {
                    alert(`炼药价值不足！当前炼药价值: ${formatNumber(currentAlchemyValue)}, 单次炼药需要: ${formatNumber(valuePerTime)}`);
                    return;
                }
                
                // 如果炼药总价值不足，只调整次数
                let adjustedTotalValue = totalValueNeeded;
                if (currentAlchemyValue < totalValueNeeded) {
                    // 计算最大可炼药次数
                    times = Math.floor(currentAlchemyValue / valuePerTime);
                    timesInputElement.value = times;
                    // 更新需要的总价值
                    adjustedTotalValue = valuePerTime * times;
                }
                
                // 扣除炼药价值
                gameState.alchemyValue = (gameState.alchemyValue || 0) - adjustedTotalValue;
                
                // 初始化统计变量
                let exploded = 0;
                let gained1 = 0;
                let gained10 = 0;
                let gained100 = 0;
                let totalGained = 0;
                
                // 确保alchemyBoost存在且有效
                const currentAlchemyBoost = Math.max(1, gameState.alchemyBoost || 1);
                
                // 执行炼药逻辑
                for (let i = 0; i < times; i++) {
                    try {
                        // 计算概率，确保结果有效
                        let explodeChance = 0.5 / Math.pow(valuePerTime, 0.4);
                        explodeChance = Math.max(0.01, Math.min(0.99, explodeChance)); // 限制概率范围
                        
                        let gain1Chance = 0;
                        let gain10Chance = 0;
                        let gain100Chance = 0;
                        
                        if (valuePerTime < 100) {
                            gain1Chance = 0.4 * Math.pow(currentAlchemyBoost, 0.1);
                            gain10Chance = 1 - explodeChance - gain1Chance;
                        } else {
                            gain1Chance = 0.4 / Math.pow(currentAlchemyBoost, 0.6);
                            gain10Chance = 0.4 * Math.pow(valuePerTime / 100, 0.4);
                            gain10Chance = Math.min(0.5, gain10Chance);
                            gain100Chance = 1 - explodeChance - gain1Chance - gain10Chance;
                        }
                        
                        // 确保概率有效
                        gain1Chance = Math.max(0, Math.min(1 - explodeChance, gain1Chance));
                        gain10Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance, gain10Chance));
                        gain100Chance = Math.max(0, Math.min(1 - explodeChance - gain1Chance - gain10Chance, gain100Chance));
                        
                        // 归一化概率，确保总和为1
                        const totalProbability = explodeChance + gain1Chance + gain10Chance + gain100Chance;
                        if (totalProbability > 0) {
                            explodeChance /= totalProbability;
                            gain1Chance /= totalProbability;
                            gain10Chance /= totalProbability;
                            gain100Chance /= totalProbability;
                        }
                        
                        const rand = Math.random();
                        
                        if (rand < explodeChance) {
                            exploded++;
                        } else if (rand < explodeChance + gain1Chance) {
                            gained1++;
                            totalGained += 1;
                        } else if (rand < explodeChance + gain1Chance + gain10Chance) {
                            gained10++;
                            totalGained += 10;
                        } else {
                            gained100++;
                            totalGained += 100;
                        }
                    } catch (iterationError) {
                        console.error(`炼药第 ${i+1} 次出错:`, iterationError);
                        // 出错时视为炸锅
                        exploded++;
                    }
                }
                
                // 更新炼药增益
                gameState.alchemyBoost = currentAlchemyBoost + totalGained;
                
                // 计算平均值
                const avgPerTime = times > 0 ? totalGained / times : 0;
                const avgPerValue = totalValueNeeded > 0 ? totalGained / totalValueNeeded : 0;
                
                // 显示结果
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = `
                        <div>本次共消耗 ${formatNumber(totalValueNeeded)} 炼药价值，炼药 ${times} 次</div>
                        <div>炸锅 ${exploded} 次，获得1炼药增益 ${gained1} 次</div>
                        <div>获得10炼药增益 ${gained10} 次，获得100炼药增益 ${gained100} 次</div>
                        <div>共获得 ${formatNumber(totalGained)} 炼药增益</div>
                        <div>平均每次炼药获得 ${isFinite(avgPerTime) ? avgPerTime.toFixed(2) : '0.00'} 炼药增益</div>
                        <div>平均每炼药值获得 ${isFinite(avgPerValue) ? avgPerValue.toFixed(4) : '0.0000'} 炼药增益</div>
                    `;
                }
                
                // 尝试更新UI
                try {
                    updateUI();
                } catch (uiError) {
                    console.error('更新UI失败:', uiError);
                }
            } catch (e) {
                console.error('炼药失败:', e);
                // 安全显示错误信息
                const resultsElement = document.getElementById("alchemy-results");
                if (resultsElement) {
                    resultsElement.innerHTML = "炼药过程中发生错误，请重试";
                }
            }
        }

        if (!window.gameState) {
            window.gameState = {
                level: 0,
                exp: 0,
                gold: 0,
                trophies: 0,
                currentBlockCategory: "main1",
                currentBlockIndex: 0,
                currentPickaxe: "木镐",
                usageBoost: 1,
                alchemyBoost: 1,
                alchemyValue: 0,
                gameStage: 1,
                resources: {
                    "红曜石碎片": 0,
                    "蓝曜石碎片": 0,
                    "基岩碎片": 0,
                    "木核心": 0,
                    "土核心": 0,
                    "水立方": 0,
                    "火立方": 0,
                    "金立方": 0,
                    "紫水晶": 0,
                    "下界之星": 0,
                    "坤坤": 0,
                    "红曜石": 0,
                    "蓝曜石": 0,
                    "五行转换器": 0,
                    "木结晶": 0,
                    "土结晶": 0,
                    "水结晶": 0,
                    "火结晶": 0,
                    "金结晶": 0,
                    "风结晶": 0,
                    "雷结晶": 0,
                    "光结晶": 0,
                    "暗结晶": 0,
                    "源结晶": 0,
                    "金奖核心": 0,
                    "淼立方": 0,
                    "红曜方": 0,
                    "蓝曜方": 0,
                    "五行结晶": 0,
                    "风雷结晶": 0,
                    "光暗结晶": 0,
                    "金奖转化器": 0,
                    "α": 0,
                    "β": 0,
                    "γ": 0,
                    "元素晶片": 0,
                    "量产核心": 0,
                    "五行镐": 0,
                    "五行精华": 0,
                    "五行驱动器": 0,
                    "???": 0
                },
                // 研究所相关状态
                energies: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                converters: {
                    alpha: false,
                    beta: false,
                    gamma: false
                },
                producers: {
                    alpha: 0,
                    beta: 0,
                    gamma: 0
                },
                pickaxes: {
                    "木镐": 1,
                    "石镐": 0,
                    "铁镐": 0,
                    "金镐": 0,
                    "钻石镐": 0,
                    "下届合金镐": 0,
                    "黑曜石镐": 0,
                    "红曜石镐": 0,
                    "蓝曜石镐": 0,
                    "红蓝镐": 0,
                    "基岩镐": 0,
                    "木核心镐": 0,
                    "土核心镐": 0,
                    "水立方镐": 0,
                    "火立方镐": 0,
                    "金立方镐": 0,
                    "五行镐": 0,
                    "紫水晶镐Ⅰ": 0,
                    "紫水晶镐Ⅱ": 0,
                    "紫水晶镐Ⅲ": 0,
                    "紫水晶镐Ⅳ": 0,
                    "紫水晶镐Ⅴ": 0,
                    "五行镐·木": 0,
                    "五行镐·土": 0,
                    "五行镐·水": 0,
                    "五行镐·火": 0,
                    "五行镐·金": 0,
                    "五行镐·五行": 0,
                    "五行镐·风": 0,
                    "五行镐·雷": 0,
                    "七行镐": 0,
                    "七行镐·光": 0,
                    "七行镐·暗": 0,
                    "九行镐": 0,
                    "源镐": 0,
                    "五行镐Ⅱ": 0,
                    "五行镐Ⅲ": 0,
                    "五行镐Ⅳ":0,
                    "红蓝镐Ⅱ": 0,
                    "红蓝镐Ⅲ": 0,
                    "坤镐": 0,
                    "元素镐": 0,
                    "元素镐2阶": 0,
                    "元素镐3阶": 0,
                    "元素镐4阶": 0,
                    "元素镐5阶": 0,
                    "元素镐6阶": 0,
                    "元素镐7阶": 0,
                    "元素镐8阶": 0,
                    "元素镐9阶": 0,
                    "元素镐10阶": 0,
                    "奖杯镐":0,
                    "使用镐":0
                },
                blockHp: {}
            };
        }
        // 格式化在线时长（秒）为友好的显示格式
        function formatPlayTime(seconds) {
            const days = Math.floor(seconds / (24 * 3600));
            const hours = Math.floor((seconds % (24 * 3600)) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (days > 0) {
                return `${days}天，${hours}时，${minutes}分，${remainingSeconds}秒`;
            } else if (hours > 0) {
                return `${hours}时，${minutes}分，${remainingSeconds}秒`;
            } else if (minutes > 0) {
                return `${minutes}分，${remainingSeconds}秒`;
            } else {
                return `${remainingSeconds}秒`;
            }
        }
        
        // 更新在线时长显示
        function updatePlayTimeDisplay() {
            const playTimeElement = document.getElementById('total-play-time');
            if (playTimeElement && window.gameState && window.gameState.totalPlayTimeSeconds !== undefined) {
                playTimeElement.textContent = formatPlayTime(window.gameState.totalPlayTimeSeconds);
            }
        }
        
        // 初始化游戏 - 增强版
        function initGame() {
            console.log('开始游戏初始化...');
            
            // 确保gameState存在
            if (!window.gameState) {
                console.log('gameState不存在，初始化默认状态');
                initGameState();
            }
            
            // 加载保存的游戏状态，如果失败将使用默认状态
            try {
                loadGame();
                console.log('游戏状态加载完成');
            } catch (loadError) {
                console.error('加载游戏状态失败，使用默认状态:', loadError);
                if (!window.gameState) {
                    initGameState();
                }
            }
            
            // 初始化方块血量（如果不存在）
            if (!gameState.blockHp) {
                gameState.blockHp = {};
            }
            try {
                initBlockHp();
                console.log('方块血量初始化完成');
            } catch (hpError) {
                console.error('初始化方块血量失败:', hpError);
            }
            
            // 确保游戏状态中的所有必要属性都存在
            if (!window.gameState.alchemyValue) window.gameState.alchemyValue = 0;
            if (!window.gameState.alchemyBoost) window.gameState.alchemyBoost = 1;
            if (!window.gameState.resources) window.gameState.resources = {};
            if (!window.gameState.pickaxes) window.gameState.pickaxes = {};
            if (!window.gameState.usageBoost) window.gameState.usageBoost = 1;
            if (!window.gameState.treeLevel) window.gameState.treeLevel = 1;
            if (!window.gameState.treeExp) window.gameState.treeExp = 0;
            if (!window.gameState.autoMiningEnabled) window.gameState.autoMiningEnabled = false;
            if (!window.gameState.totalDamage) window.gameState.totalDamage = 0;
            if (!window.gameState.gameStage) window.gameState.gameStage = 1;
            
            // 检查游戏阶段，确保满足条件时自动进入相应阶段
            checkGameStage();
            if (!window.gameState.totalPlayTimeSeconds) window.gameState.totalPlayTimeSeconds = 0;
            // 确保achievements对象存在
            if (!window.gameState.achievements) window.gameState.achievements = {"初入游戏": true};
            
            // 创建在线时长显示元素
            if (!document.getElementById('play-time-display')) {
                const statsContainer = document.querySelector('#stats-container .stats');
                if (statsContainer) {
                    const playTimeElement = document.createElement('div');
                    playTimeElement.id = 'play-time-display';
                    playTimeElement.className = 'stat-item';
                    playTimeElement.innerHTML = '<span class="stat-label">在线时长：</span><span class="stat-value" id="total-play-time">0秒</span>';
                    statsContainer.appendChild(playTimeElement);
                }
            }
            
            // 确保gameData存在并初始化完整的方块数据
            if (!window.gameData) {
                console.log('初始化游戏数据...');
                // 初始化游戏数据，但不设置blocks（会在后面使用完整的blocks数据）
                window.gameData = {};
            } else if (!window.gameData.blocks) {
                // 如果gameData存在但blocks不存在，初始化blocks
                window.gameData.blocks = {
                    main1: [
                        { name: "土块", hp: 100, baseGold: 1 },
                        { name: "草块", hp: 500, baseGold: 2 },
                        { name: "木块", hp: 2000, baseGold: 3 },
                        { name: "石块", hp: 10000, baseGold: 5 },
                        { name: "硬石块", hp: 50000, baseGold: 10 },
                        { name: "深板岩", hp: 300000, baseGold: 15 },
                        { name: "煤炭块", hp: 1780000, baseGold: 20 },
                        { name: "铜块", hp: 7800000, baseGold: 30 },
                        { name: "铁块", hp: 91000000, baseGold: 40 },
                        { name: "金块", hp: 260000000, baseGold: 50 },
                        { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                        { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                        { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                        { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                        { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                        { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                        { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                        { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                        { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                        { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                        { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                    ],
                    // 合并side1、side2、side3为普通支线
                    side: [
                        // side1内容
                        { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                        { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                        { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } },
                        // side2内容
                        { name: "红曜石", hp: 5e16, baseGold: 500, special: { type: "fragment", item: "红曜石", chance: 0.05 } },
                        { name: "蓝曜石", hp: 6e16, baseGold: 600, special: { type: "fragment", item: "蓝曜石", chance: 0.05 } },
                        { name: "金奖核心", hp: 1e21, baseGold: 2000, special: { type: "fragment", item: "金奖核心", chance: 0.1 } },
                        { name: "淼立方块", hp: 1e22, baseGold: 2500, special: { type: "fragment", item: "淼立方", chance: 0.05 } },
                        { name: "水晶晶簇", hp: 1e23, baseGold: 2500, special: { type: "pickaxe", item: "紫水晶镐Ⅲ", count: 1, chance: 0.1 } },
                        { name: "坤群", hp: 1e24, baseGold: 3000, special: { type: "fragment", item: "坤坤", count: 1000, chance: 0.01 } },
                        { name: "红曜方", hp: 5e25, baseGold: 4000, special: { type: "fragment", item: "红曜方", chance: 0.005 } },
                        { name: "蓝曜方", hp: 6e25, baseGold: 4000, special: { type: "fragment", item: "蓝曜方", chance: 0.005 } },
                        // side3内容
                        { name: "五行镐", hp: 7.8e31, baseGold: 18000, special: { type: "pickaxe", item: "五行镐", count: 1, chance: 0.01 } },
                        { name: "五行精华", hp: 9.1e31, baseGold: 18000, special: { type: "fragment", item: "五行精华", count: 1, chance: 0.001 } },
                        { name: "药叶", hp: 9.1e44, baseGold: 100000, special: { type: "fragment", item: "药叶", count: 1, chance: 0.03 } }
                    ],
                    main2: [
                        { name: "木结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "木结晶", chance: 0.05 } },
                        { name: "土结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "土结晶", chance: 0.05 } },
                        { name: "水结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "水结晶", chance: 0.05 } },
                        { name: "火结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "火结晶", chance: 0.05 } },
                        { name: "金结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "金结晶", chance: 0.05 } },
                        { name: "风结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "风结晶", chance: 0.05 } },
                        { name: "雷结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "雷结晶", chance: 0.05 } },
                        { name: "光结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "光结晶", chance: 0.05 } },
                        { name: "暗结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "暗结晶", chance: 0.05 } },
                        { name: "源结晶块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "源结晶", chance: 0.01 } }
                    ],
                    main3: [
                        { name: "α方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "α", count: 1, chance: 1 } },
                        { name: "β方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "β", count: 1, chance: 1 } },
                        { name: "γ方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "γ", count: 1, chance: 1 } },
                        { name: "元素晶片", hp: 1.91e31, baseGold: 15000, special: { type: "fragment", item: "元素晶片", count: 1, chance: 0.1 } },
                        { name: "量产核心", hp: 1.91e34, baseGold: 20000, special: { type: "fragment", item: "量产核心", count: 1, chance: 0.01 } }
                    ]
                };
            }
            

   
            
            // 确保初入游戏成就始终是解锁状态
            if (window.gameState.achievements) {
                window.gameState.achievements["初入游戏"] = true;
            }
            
            // 移除统计数据中的游戏阶段显示
            try {
                const statsElement = document.querySelector('#stats-container .stats');
                if (statsElement) {
                    // 找到并移除游戏阶段相关的统计数据
                    const stageStatsElements = statsElement.querySelectorAll('.stat-item:has(#game-stage)');
                    stageStatsElements.forEach(el => el.remove());
                }
            } catch (e) {
                console.error('移除统计数据中的游戏阶段失败:', e);
            }
            
            // 设置初始经验需求
            try {
                const expNeededElement = document.getElementById("exp-needed");
                if (expNeededElement) {
                    expNeededElement.textContent = typeof getExpNeeded === 'function' ? getExpNeeded(0) : '100';
                }
            } catch (e) {
                console.error('设置初始经验需求失败:', e);
            }
            
            // 添加事件监听器 - 优化版本，避免重复绑定
            function bindBlockClickListener() {
                const blockDisplay = document.getElementById("block-display");
                if (!blockDisplay) {
                    console.error('未找到方块显示元素，尝试稍后重新绑定');
                    return;
                }
                
                console.log('找到方块显示元素，开始绑定点击事件（避免重复绑定）');
                
                // 确保全局保存blockClickHandler函数，以便正确移除
                if (window._blockClickHandler) {
                    try {
                        // 移除之前可能添加的监听器
                        blockDisplay.removeEventListener("click", window._blockClickHandler);
                        console.log('移除了之前的监听器');
                    } catch (e) {
                        console.warn('移除监听器时出现错误:', e);
                    }
                }
                
                // 创建新的点击处理函数并保存到全局，每次点击触发10次挖矿
                window._blockClickHandler = function() {
                    if (typeof mineBlock === 'function') {
                        try {
                            // 每次点击触发10次挖矿
                            for (let i = 0; i < 10; i++) {
                                mineBlock();
                            }
                        } catch (e) {
                            console.error('挖矿函数执行失败:', e);
                        }
                    }
                };
                
                // 只使用一种方法绑定事件，避免重复执行
                try {
                    // 重置onclick
                    blockDisplay.onclick = null;
                    // 使用addEventListener并保存引用
                    blockDisplay.addEventListener("click", window._blockClickHandler);
                    console.log('成功绑定单个点击事件监听器');
                } catch (e) {
                    // 降级使用onclick作为备用方案
                    console.warn('使用addEventListener失败，降级到onclick:', e);
                    blockDisplay.onclick = window._blockClickHandler;
                }
            }
            
            // 只绑定一次事件监听器
            bindBlockClickListener();
            
            try {
                // 重写方块切换按钮事件绑定，修复方块顺序错乱问题
                function bindBlockNavigation() {
                    const prevBlock = document.getElementById("prev-block");
                    const nextBlock = document.getElementById("next-block");
                    
                    // 确保gameState存在
                    if (!window.gameState) {
                        window.gameState = {
                            currentBlockCategory: "main1",
                            currentBlockIndex: 0,
                            gameStage: 1
                        };
                    }
                    
                    // 确保window.gameData和blocks数据正确初始化
                    if (!window.gameData) {
                        window.gameData = {};
                    }
                    if (!window.gameData.blocks) {
                        console.log('强制初始化完整的blocks数据');
                 window.gameData.blocks = {
                    main1: [
                        { name: "土块", hp: 100, baseGold: 1 },
                        { name: "草块", hp: 500, baseGold: 2 },
                        { name: "木块", hp: 2000, baseGold: 3 },
                        { name: "石块", hp: 10000, baseGold: 5 },
                        { name: "硬石块", hp: 50000, baseGold: 10 },
                        { name: "深板岩", hp: 300000, baseGold: 15 },
                        { name: "煤炭块", hp: 1780000, baseGold: 20 },
                        { name: "铜块", hp: 7800000, baseGold: 30 },
                        { name: "铁块", hp: 91000000, baseGold: 40 },
                        { name: "金块", hp: 260000000, baseGold: 50 },
                        { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                        { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                        { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                        { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                        { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                        { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                        { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                        { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                        { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                        { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                        { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                    ],
                    // 合并side1、side2、side3为普通支线
                    side: [
                        // side1内容
                        { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                        { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                        { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } },
                        // side2内容
                        { name: "红曜石", hp: 5e16, baseGold: 500, special: { type: "fragment", item: "红曜石", chance: 0.05 } },
                        { name: "蓝曜石", hp: 6e16, baseGold: 600, special: { type: "fragment", item: "蓝曜石", chance: 0.05 } },
                        { name: "金奖核心", hp: 1e21, baseGold: 2000, special: { type: "fragment", item: "金奖核心", chance: 0.1 } },
                        { name: "淼立方块", hp: 1e22, baseGold: 2500, special: { type: "fragment", item: "淼立方", chance: 0.05 } },
                        { name: "水晶晶簇", hp: 1e23, baseGold: 2500, special: { type: "pickaxe", item: "紫水晶镐Ⅲ", count: 1, chance: 0.1 } },
                        { name: "坤群", hp: 1e24, baseGold: 3000, special: { type: "fragment", item: "坤坤", count: 1000, chance: 0.01 } },
                        { name: "红曜方", hp: 5e25, baseGold: 4000, special: { type: "fragment", item: "红曜方", chance: 0.005 } },
                        { name: "蓝曜方", hp: 6e25, baseGold: 4000, special: { type: "fragment", item: "蓝曜方", chance: 0.005 } },
                        // side3内容
                        { name: "五行镐", hp: 7.8e31, baseGold: 18000, special: { type: "pickaxe", item: "五行镐", count: 1, chance: 0.01 } },
                        { name: "五行精华", hp: 9.1e31, baseGold: 18000, special: { type: "fragment", item: "五行精华", count: 1, chance: 0.001 } },
                        { name: "药叶", hp: 9.1e44, baseGold: 100000, special: { type: "fragment", item: "药叶", count: 1, chance: 0.03 } }
                    ],
                    main2: [
                        { name: "木结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "木结晶", chance: 0.05 } },
                        { name: "土结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "土结晶", chance: 0.05 } },
                        { name: "水结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "水结晶", chance: 0.05 } },
                        { name: "火结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "火结晶", chance: 0.05 } },
                        { name: "金结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "金结晶", chance: 0.05 } },
                        { name: "风结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "风结晶", chance: 0.05 } },
                        { name: "雷结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "雷结晶", chance: 0.05 } },
                        { name: "光结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "光结晶", chance: 0.05 } },
                        { name: "暗结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "暗结晶", chance: 0.05 } },
                        { name: "源结晶块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "源结晶", chance: 0.01 } }
                    ],
                    main3: [
                        { name: "α方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "α", count: 1, chance: 1 } },
                        { name: "β方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "β", count: 1, chance: 1 } },
                        { name: "γ方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "γ", count: 1, chance: 1 } },
                        { name: "元素晶片", hp: 1.91e31, baseGold: 15000, special: { type: "fragment", item: "元素晶片", count: 1, chance: 0.1 } },
                        { name: "量产核心", hp: 1.91e34, baseGold: 20000, special: { type: "fragment", item: "量产核心", count: 1, chance: 0.01 } }
                    ]
                };
            }
                                
                    // 统一的方块索引更新函数 - 增强版
                    function updateBlockIndex(direction) {
                        try {
                            console.log('开始切换方块，方向:', direction);
                            
                            // 确保window.gameState存在
                            if (!window.gameState) {
                                console.error('gameState不存在');
                                return;
                            }
                            
                            // 确保window.gameData存在
                            if (!window.gameData || !window.gameData.blocks) {
                                console.error('gameData或blocks不存在');
                                return;
                            }
                            
                            // 获取当前分类
                            const category = window.gameState.currentBlockCategory;
                            
                            // 验证分类
                            if (!category || typeof category !== 'string') {
                                console.error('无效的分类名称:', category);
                                return;
                            }
                            
                            // 验证分类对应的方块数据
                            if (!window.gameData.blocks[category]) {
                                console.error('分类不存在:', category);
                                return;
                            }
                            
                            if (!Array.isArray(window.gameData.blocks[category])) {
                                console.error('分类下的方块数据不是数组:', category);
                                return;
                            }
                            
                            // 获取方块数量
                            const blocks = window.gameData.blocks[category];
                            const blockCount = blocks.length;
                            console.log(`当前分类: ${category}, 方块总数: ${blockCount}, 当前索引: ${window.gameState.currentBlockIndex}`);
                            console.log('方块数据预览:', JSON.stringify(blocks.slice(0, 3)));
                            
                            if (blockCount === 0) {
                                console.warn('当前分类下没有方块:', category);
                                return;
                            }
                            
                            // 确保currentBlockIndex有效
                            if (typeof window.gameState.currentBlockIndex !== 'number' || window.gameState.currentBlockIndex < 0) {
                                window.gameState.currentBlockIndex = 0;
                                console.log('重置方块索引为0');
                            }
                            
                            // 确保索引在有效范围内
                            window.gameState.currentBlockIndex = Math.max(0, Math.min(window.gameState.currentBlockIndex, blockCount - 1));
                            
                            // 记录切换前的状态
                            const beforeIndex = window.gameState.currentBlockIndex;
                            
                            // 更新索引
                            if (direction === 'prev') {
                                // 上一个方块 - 循环切换
                                window.gameState.currentBlockIndex = (window.gameState.currentBlockIndex - 1 + blockCount) % blockCount;
                            } else if (direction === 'next') {
                                // 下一个方块 - 循环切换
                                window.gameState.currentBlockIndex = (window.gameState.currentBlockIndex + 1) % blockCount;
                            } else {
                                console.error('无效的方向参数:', direction);
                                return;
                            }
                            
                            // 确保索引再次在有效范围内（双重保险）
                            window.gameState.currentBlockIndex = Math.max(0, Math.min(window.gameState.currentBlockIndex, blockCount - 1));
                            
                            console.log(`成功切换方块: ${direction}，分类: ${category}，从索引 ${beforeIndex} 切换到 ${window.gameState.currentBlockIndex}`);
                            
                            // 更新UI
                            if (typeof updateUI === 'function') {
                                updateUI();
                                console.log('UI已更新');
                            } else {
                                console.warn('updateUI函数不存在');
                            }
                            
                        } catch (e) {
                            console.error(`切换方块失败(${direction}):`, e);
                        }
                    }
                    
                    // 处理上一个方块按钮
                    if (prevBlock) {
                        // 先清除可能存在的事件监听器
                        prevBlock.onclick = null;
                        try {
                            prevBlock.removeEventListener('click', function handler() {});
                        } catch (e) {}
                        
                        // 只使用onclick方法，避免重复绑定
                        prevBlock.onclick = function() {
                            updateBlockIndex('prev');
                        };
                        
                        console.log('上一个方块按钮事件已绑定');
                    }
                    
                    // 处理下一个方块按钮
                    if (nextBlock) {
                        // 先清除可能存在的事件监听器
                        nextBlock.onclick = null;
                        try {
                            nextBlock.removeEventListener('click', function handler() {});
                        } catch (e) {}
                        
                        // 只使用onclick方法，避免重复绑定
                        nextBlock.onclick = function() {
                            updateBlockIndex('next');
                        };
                        
                        console.log('下一个方块按钮事件已绑定');
                    }
                }
                
                // 立即绑定
                bindBlockNavigation();
                // 延迟再次绑定以确保DOM元素完全加载
                setTimeout(bindBlockNavigation, 300);
            } catch (e) {
                console.error('添加方块切换事件监听失败:', e);
            }
            
            // 分类切换 - 修复版
            try {
                function bindCategoryButtons() {
                    console.log('绑定分类按钮事件');
                    const categoryButtons = document.querySelectorAll(".block-category .category-btn");
                    if (categoryButtons.length === 0) {
                        console.warn('未找到分类按钮');
                        return;
                    }
                    
                    // 确保gameData和blocks数据正确初始化
                    if (!window.gameData) {
                        window.gameData = {};
                    }
                    if (!window.gameData.blocks) {
                        console.log('强制初始化完整的blocks数据');
                        window.gameData.blocks = {
                            main1: [
                                { name: "土块", hp: 100, baseGold: 1 },
                                { name: "草块", hp: 500, baseGold: 2 },
                                { name: "木块", hp: 2000, baseGold: 3 },
                                { name: "石块", hp: 10000, baseGold: 5 },
                                { name: "硬石块", hp: 50000, baseGold: 10 },
                                { name: "深板岩", hp: 300000, baseGold: 15 },
                                { name: "煤炭块", hp: 1780000, baseGold: 20 },
                                { name: "铜块", hp: 7800000, baseGold: 30 },
                                { name: "铁块", hp: 91000000, baseGold: 40 },
                                { name: "金块", hp: 260000000, baseGold: 50 },
                                { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                                { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                                { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                                { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                                { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                                { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                                { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                                { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                                { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                                { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                                { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                            ],
                            // 合并side1、side2、side3为普通支线
                            side: [
                                // side1内容
                                { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                                { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                                { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } },
                                // side2内容
                                { name: "红曜石", hp: 5e16, baseGold: 500, special: { type: "fragment", item: "红曜石", chance: 0.05 } },
                                { name: "蓝曜石", hp: 6e16, baseGold: 600, special: { type: "fragment", item: "蓝曜石", chance: 0.05 } },
                                { name: "金奖核心", hp: 1e21, baseGold: 2000, special: { type: "fragment", item: "金奖核心", chance: 0.1 } },
                                { name: "淼立方块", hp: 1e22, baseGold: 2500, special: { type: "fragment", item: "淼立方", chance: 0.05 } },
                                { name: "水晶晶簇", hp: 1e23, baseGold: 2500, special: { type: "pickaxe", item: "紫水晶镐Ⅲ", count: 1, chance: 0.1 } },
                                { name: "坤群", hp: 1e24, baseGold: 3000, special: { type: "fragment", item: "坤坤", count: 1000, chance: 0.01 } },
                                { name: "红曜方", hp: 5e25, baseGold: 4000, special: { type: "fragment", item: "红曜方", chance: 0.005 } },
                                { name: "蓝曜方", hp: 6e25, baseGold: 4000, special: { type: "fragment", item: "蓝曜方", chance: 0.005 } },
                                // side3内容
                                { name: "五行镐", hp: 7.8e31, baseGold: 18000, special: { type: "pickaxe", item: "五行镐", count: 1, chance: 0.01 } },
                                { name: "五行精华", hp: 9.1e31, baseGold: 18000, special: { type: "fragment", item: "五行精华", count: 1, chance: 0.001 } },
                                { name: "药叶", hp: 9.1e44, baseGold: 100000, special: { type: "fragment", item: "药叶", count: 1, chance: 0.03 } }
                            ],
                            main2: [
                                { name: "木结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "木结晶", chance: 0.05 } },
                                { name: "土结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "土结晶", chance: 0.05 } },
                                { name: "水结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "水结晶", chance: 0.05 } },
                                { name: "火结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "火结晶", chance: 0.05 } },
                                { name: "金结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "金结晶", chance: 0.05 } },
                                { name: "风结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "风结晶", chance: 0.05 } },
                                { name: "雷结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "雷结晶", chance: 0.05 } },
                                { name: "光结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "光结晶", chance: 0.05 } },
                                { name: "暗结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "暗结晶", chance: 0.05 } },
                                { name: "源结晶块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "源结晶", chance: 0.01 } }
                            ],
                              main3: [
                                { name: "α方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "α", count: 1, chance: 1 } },
                                { name: "β方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "β", count: 1, chance: 1 } },
                                { name: "γ方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "γ", count: 1, chance: 1 } },
                                { name: "元素晶片", hp: 1.91e31, baseGold: 15000, special: { type: "fragment", item: "元素晶片", count: 1, chance: 0.1 } },
                                { name: "量产核心", hp: 1.91e34, baseGold: 20000, special: { type: "fragment", item: "量产核心", count: 1, chance: 0.01 } }
                            ],

                        };
                    }
                    
                    // 统一的分类切换处理函数
                    function handleCategoryChange(button) {
                        try {
                            console.log('开始分类切换处理');
                            // 确保window.gameState存在
                            if (!window.gameState) {
                                window.gameState = {
                                    currentBlockCategory: "main1",
                                    currentBlockIndex: 0,
                                    gameStage: 1
                                };
                                console.log('初始化gameState');
                            }
                            
                            const category = button.getAttribute('data-category') || button.dataset.category;
                            
                            if (!category) {
                                console.error('分类按钮缺少data-category属性');
                                return;
                            }
                            
                            console.log(`尝试切换到分类: ${category}`);
                            
                            // 验证分类是否有效
                            if (!window.gameData.blocks || !window.gameData.blocks[category]) {
                                console.error('无效的分类或游戏数据未初始化:', category);
                                return;
                            }
                            
                            // 安全地更新所有按钮的active状态
                            try {
                                const allButtons = document.querySelectorAll(".block-category .category-btn");
                                allButtons.forEach(btn => {
                                    if (btn && btn.classList) {
                                        btn.classList.remove("active");
                                    }
                                });
                                if (button.classList) {
                                    button.classList.add("active");
                                }
                            } catch (e) {
                                console.error('更新按钮active状态失败:', e);
                            }
                            
                            // 确保分类名是字符串类型，索引重置为0
                            window.gameState.currentBlockCategory = String(category);
                            window.gameState.currentBlockIndex = 0;
                            console.log(`成功切换到分类: ${category}，索引已重置为0`);
                            
                            // 统一使用window.blockHp进行血量管理
                            if (!window.blockHp) {
                                window.blockHp = {};
                            }
                            
                            // 确保当前分类有对应的血量对象
                            if (!window.blockHp[category]) {
                                window.blockHp[category] = {};
                                console.log(`初始化分类 ${category} 的血量对象`);
                            }
                            
                            // 初始化当前分类第一个方块的血量
                            const blocks = window.gameData.blocks[category];
                            if (blocks && blocks.length > 0 && blocks[0]) {
                                if (!window.blockHp[category][0]) {
                                    window.blockHp[category][0] = blocks[0].hp || 100;
                                    console.log(`初始化分类 ${category} 第一个方块的血量: ${window.blockHp[category][0]}`);
                                }
                                
                                // 直接更新UI
                                try {
                                    const blockNameElement = document.getElementById('block-name');
                                    const blockHpElement = document.getElementById('block-hp');
                                    const blockImageElement = document.getElementById('block-image');
                                    
                                    if (blockNameElement && blockHpElement) {
                                        blockNameElement.textContent = blocks[0].name || '未知方块';
                                        
                                        // 格式化血量显示
                                        const currentHp = window.blockHp[category][0];
                                        const maxHp = blocks[0].hp || 100;
                                        blockHpElement.textContent = `${formatNumber(currentHp)}/${formatNumber(maxHp)}`;
                                        console.log('分类切换后直接更新DOM成功');
                                    }
                                    
                                    if (blockImageElement) {
                                        // 设置方块颜色（简化版）
                                        const colors = {
                                            main1: '#8B4513',
                                            side1: '#9932CC',
                                            main2: '#FFD700',
                                            side2: '#FF6347',
                                            main3: '#0000FF'
                                        };
                                        blockImageElement.style.backgroundColor = colors[category] || '#CCCCCC';
                                    }
                                } catch (e) {
                                    console.error('直接更新UI失败:', e);
                                }
                            }
                        } catch (e) {
                            console.error('分类切换失败:', e);
                        }
                    }
                    
                    categoryButtons.forEach(button => {
                        if (!button) return;
                        
                        // 先清除可能存在的事件监听器
                        button.onclick = null;
                        try {
                            // 使用克隆节点方式移除所有事件监听器
                            const clonedButton = button.cloneNode(true);
                            button.parentNode.replaceChild(clonedButton, button);
                            button = clonedButton; // 更新引用
                        } catch (e) {
                            console.warn('无法完全清除事件监听器:', e);
                        }
                        
                        // 确保按钮可点击
                            button.style.pointerEvents = 'auto';
                            button.style.cursor = 'pointer';
                            const btnCategory = button.dataset.category;
                            console.log(`设置分类按钮 ${btnCategory} 为可点击状态`);
                            
                            // 只使用onclick方法，避免重复绑定
                            button.onclick = function() {
                                console.log(`分类按钮 ${this.dataset.category} 被点击`);
                                handleCategoryChange(this);
                            };
                            console.log(`分类按钮 ${btnCategory} 事件绑定完成`);
                    });
                }
                
                // 立即调用bindCategoryButtons函数来绑定事件
                bindCategoryButtons();
                
                // 延迟再次调用以确保DOM元素完全加载
                setTimeout(bindCategoryButtons, 300);
                
                // 避免递归调用，直接设置初始活动状态
                setTimeout(() => {
                    try {
                        // 激活默认分类按钮
                        const defaultCategoryButton = document.querySelector(`[data-category="main1"]`);
                        if (defaultCategoryButton) {
                            defaultCategoryButton.click();
                        }
                    } catch (e) {
                        console.error('设置默认分类失败:', e);
                    }
                }, 100);
            } catch (e) {
                console.error('添加分类切换事件监听失败:', e);
            }
            
            // 标签切换 - 增强版
            try {
                function bindTabButtons() {
                    console.log('绑定标签按钮事件 - 增强版本');
                    const tabButtons = document.querySelectorAll(".tab-btn");
                    if (tabButtons.length === 0) {
                        console.warn('未找到标签按钮');
                        return;
                    }
                    
                    tabButtons.forEach(button => {
                        if (!button) return;
                        
                        // 确保按钮可以被点击
                        button.style.pointerEvents = 'auto';
                        button.style.cursor = 'pointer';
                        button.style.userSelect = 'none'; // 防止文本选择
                        
                        // 克隆按钮以移除所有现有事件监听器
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                        
                        // 通用的标签切换函数
                        function handleTabClick(event) {
                            console.log('标签按钮点击:', this.id || this.dataset.tab);
                            if (event) {
                                event.stopPropagation();
                                event.preventDefault();
                            }
                            try {
                                // 安全地更新所有按钮和内容的active状态
                                const allButtons = document.querySelectorAll(".tab-btn");
                                allButtons.forEach(btn => {
                                    if (btn && btn.classList) {
                                        btn.classList.remove("active");
                                    }
                                });
                                
                                // 显式隐藏所有tab内容，确保没有重叠显示
                                const allContents = document.querySelectorAll(".tab-content");
                                allContents.forEach(content => {
                                    if (content) {
                                        content.classList.remove("active");
                                        // 直接设置style.display确保内容被隐藏
                                        content.style.display = 'none';
                                    }
                                });
                                
                                // 激活当前按钮
                                if (this.classList) {
                                    this.classList.add("active");
                                }
                                
                                // 激活对应内容
                                const tabId = this.getAttribute('data-tab') || this.dataset.tab;
                                if (tabId) {
                                    const tabContent = document.getElementById(`${tabId}-tab`);
                                    if (tabContent) {
                                        tabContent.classList.add("active");
                                        // 直接设置style.display确保内容被显示
                                        tabContent.style.display = 'block';
                                        console.log('已激活内容标签:', tabId);
                                    } else {
                                        console.warn('未找到对应的内容标签:', tabId);
                                    }
                                }
                                
                                // 处理研究所UI显示逻辑 - 只在点击研究所标签时显示研究所UI
                                const researchArea = document.querySelector('.research-area');
                                if (researchArea) {
                                    if (tabId === 'research') {
                                        researchArea.style.display = 'block';
                                    } else {
                                        researchArea.style.display = 'none';
                                    }
                                }
                            } catch (e) {
                                console.error('切换标签失败:', e);
                            }
                        }
                        
                        // 使用onclick作为主要方法
                        newButton.onclick = handleTabClick;
                        
                        // 同时使用addEventListener作为备份
                        try {
                            newButton.addEventListener('click', handleTabClick, { capture: false, passive: false });
                            console.log('已为标签按钮添加双重事件监听:', newButton.id || newButton.dataset.tab);
                        } catch (e) {
                            console.warn('为标签按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    });
                }
                
                // 立即执行并设置多次延迟执行以确保绑定成功
                bindTabButtons();
                setTimeout(bindTabButtons, 100);
                setTimeout(bindTabButtons, 500); // 额外的延迟绑定，确保DOM完全加载
            } catch (e) {
                console.error('添加标签切换事件监听失败:', e);
            }
            
            // 商店分类切换
            try {
                document.querySelectorAll(".shop-categories .category-btn").forEach(button => {
                    button.addEventListener("click", function() {
                        const shopCategory = this.dataset.shop;
                        const gameStage = window.gameState?.gameStage || 1;
                        
                        // 根据游戏阶段检查是否允许访问该商店类别
                        let canAccess = true;
                        if (shopCategory === 'main2') {
                            canAccess = gameStage >= 2;
                        } else if (shopCategory === 'main3') {
                            canAccess = gameStage >= 3;
                        }
                        // 普通支线商店和原来的支线商店都没有阶段限制
                        
                        if (canAccess) {
                            document.querySelectorAll(".shop-categories .category-btn").forEach(btn => btn.classList.remove("active"));
                            this.classList.add("active");
                            updateShop();
                        }
                    });
                });
            } catch (e) {
                console.error('添加商店分类切换事件监听失败:', e);
            }
            
            // 添加自动挖矿切换按钮事件 - 优化版本，避免重复绑定
            try {
                function bindAutoMiningToggle() {
                    const autoMiningToggle = document.getElementById("auto-mining-toggle");
                    if (!autoMiningToggle) {
                        console.error('未找到自动挖矿切换按钮，尝试稍后重新绑定');
                        return;
                    }
                    
                    console.log('找到自动挖矿切换按钮，绑定事件（避免重复绑定）');
                    
                    // 确保全局保存toggleAutoMining函数引用，以便正确移除
                    if (window._autoMiningHandler) {
                        try {
                            // 移除之前可能添加的监听器
                            autoMiningToggle.removeEventListener("click", window._autoMiningHandler);
                            console.log('移除了之前的监听器');
                        } catch (e) {
                            console.warn('移除监听器时出现错误:', e);
                        }
                    }
                    
                    // 创建新的点击处理函数并保存到全局
                    window._autoMiningHandler = function() {
                        try {
                            if (typeof toggleAutoMining === 'function') {
                                console.log('执行toggleAutoMining函数');
                                toggleAutoMining();
                            } else {
                                console.error('toggleAutoMining函数未定义');
                            }
                        } catch (e) {
                            console.error('切换自动挖矿失败:', e);
                        }
                    };
                    
                    // 只使用一种方法绑定事件，避免重复执行
                    try {
                        // 重置onclick
                        autoMiningToggle.onclick = null;
                        // 使用addEventListener并保存引用
                        autoMiningToggle.addEventListener("click", window._autoMiningHandler);
                        console.log('成功绑定单个自动挖矿切换事件监听器');
                    } catch (e) {
                        // 降级使用onclick作为备用方案
                        console.warn('使用addEventListener失败，降级到onclick:', e);
                        autoMiningToggle.onclick = window._autoMiningHandler;
                    }
                }
                
                // 只绑定一次事件监听器
                bindAutoMiningToggle();
                
                // 添加浇树按钮事件 - 增强版
                function bindWaterTreeButtons() {
                    const waterTreeCubeBtn = document.getElementById("water-tree-cube-btn");
                    const waterTreeCrystalBtn = document.getElementById("water-tree-crystal-btn");
                    const waterTreeTripleBtn = document.getElementById("water-tree-triple-btn");
                    
                    // 绑定方块浇水按钮
                    if (waterTreeCubeBtn) {
                        console.log('找到方块浇水按钮，绑定事件');
                        waterTreeCubeBtn.onclick = function() {
                            try {
                                if (typeof waterTreeWithCube === 'function') {
                                    waterTreeWithCube();
                                }
                            } catch (e) {
                                console.error('用方块浇水失败:', e);
                            }
                        };
                        try {
                            waterTreeCubeBtn.removeEventListener("click", waterTreeWithCube);
                            waterTreeCubeBtn.addEventListener("click", waterTreeWithCube);
                        } catch (e) {
                            console.warn('为方块浇水按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    }
                    
                    // 绑定水晶浇水按钮
                    if (waterTreeCrystalBtn) {
                        console.log('找到水晶浇水按钮，绑定事件');
                        waterTreeCrystalBtn.onclick = function() {
                            try {
                                if (typeof waterTreeWithCrystal === 'function') {
                                    waterTreeWithCrystal();
                                }
                            } catch (e) {
                                console.error('用水晶浇水失败:', e);
                            }
                        };
                        try {
                            waterTreeCrystalBtn.removeEventListener("click", waterTreeWithCrystal);
                            waterTreeCrystalBtn.addEventListener("click", waterTreeWithCrystal);
                        } catch (e) {
                            console.warn('为水晶浇水按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    }
                    
                    // 绑定三重方块浇水按钮
                    if (waterTreeTripleBtn) {
                        console.log('找到三重方块浇水按钮，绑定事件');
                        waterTreeTripleBtn.onclick = function() {
                            try {
                                if (typeof waterTreeWithTripleCube === 'function') {
                                    waterTreeWithTripleCube();
                                }
                            } catch (e) {
                                console.error('用三重方块浇水失败:', e);
                            }
                        };
                        try {
                            waterTreeTripleBtn.removeEventListener("click", waterTreeWithTripleCube);
                            waterTreeTripleBtn.addEventListener("click", waterTreeWithTripleCube);
                        } catch (e) {
                            console.warn('为三重方块浇水按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    }
                }
                
                bindWaterTreeButtons();
                setTimeout(bindWaterTreeButtons, 100);
            } catch (e) {
                console.error('添加按钮事件监听失败:', e);
            }
            
            // 检查是否进入第二阶段（拥有五行镐）
            if (window.gameState.pickaxes && window.gameState.pickaxes["五行镐"] && window.gameState.gameStage === 1) {
                window.gameState.gameStage = 2;
            }
            
            // 正常游戏阶段流程，不强制设置阶段
            // 游戏从第一阶段开始，根据解锁条件自动升级
            // 研究所系统将在达到适当阶段时自动启用
            
            // 根据游戏阶段动态显示UI标签
            updateTabsVisibility();
            
            // 初始化标题显示伤害数值
            updateTitleDamage();
            
            // 炼药按钮 - 增强版
            try {
                function bindAlchemyButton() {
                    const alchemyBtn = document.getElementById("alchemy-btn");
                    if (alchemyBtn) {
                        console.log('找到炼药按钮，绑定事件');
                        // 使用onclick作为主要方法
                        alchemyBtn.onclick = function() {
                            try {
                                if (typeof performAlchemy === 'function') {
                                    performAlchemy();
                                }
                            } catch (e) {
                                console.error('执行炼药失败:', e);
                                try {
                                    alert('炼药失败：' + (e.message || '未知错误'));
                                } catch (alertError) {
                                    console.error('显示错误提示失败:', alertError);
                                }
                            }
                        };
                        // 同时使用addEventListener作为备份
                        try {
                            function alchemyHandler() {
                                try {
                                    if (typeof performAlchemy === 'function') {
                                        performAlchemy();
                                    }
                                } catch (e) {
                                    console.error('执行炼药失败:', e);
                                }
                            }
                            alchemyBtn.removeEventListener("click", alchemyHandler);
                            alchemyBtn.addEventListener("click", alchemyHandler);
                        } catch (e) {
                            console.warn('为炼药按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    }
                }
                
                bindAlchemyButton();
                setTimeout(bindAlchemyButton, 100);
            } catch (e) {
                console.error('添加炼药按钮事件监听失败:', e);
            }
            
            // 兑换按钮 - 增强版本
            try {
                const convertBtn = document.getElementById("convert-btn");
                if (convertBtn) {
                    // 移除所有可能存在的旧事件监听器
                    convertBtn.onclick = null;
                    
                    // 方法1：使用onclick属性（最可靠的方式）
                    convertBtn.onclick = function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('兑换按钮onclick触发');
                        try {
                            console.log('调用convertGoldToTrophies函数');
                            convertGoldToTrophies();
                        } catch (innerError) {
                            console.error('兑换函数执行失败:', innerError.stack || innerError);
                            alert('兑换失败：' + (innerError.message || '未知错误'));
                        }
                    };
                    
                    // 方法2：添加事件监听器作为备份
                    try {
                        convertBtn.addEventListener('click', function(event) {
                            console.log('兑换按钮addEventListener触发');
                        }, { once: true }); // 只触发一次，避免重复执行
                    } catch (addEventError) {
                        console.warn('添加事件监听器失败，但onclick已设置:', addEventError);
                    }
                    
                    console.log('兑换按钮事件绑定完成');
                } else {
                    // 改为信息日志而非错误，避免控制台报错
                    console.info('兑换按钮元素不存在，跳过绑定');
                }
            } catch (e) {
                console.error('添加兑换按钮事件监听失败:', e.stack || e);
            }
            
            // 一键换取炼药价值按钮 - 增强版
            try {
                function bindConvertAlchemyButton() {
                    const convertAlchemyBtn = document.getElementById("convert-alchemy-btn");
                    if (convertAlchemyBtn) {
                        console.log('找到一键换取炼药价值按钮，绑定事件');
                        // 使用onclick作为主要方法
                        convertAlchemyBtn.onclick = function() {
                            try {
                                if (typeof convertToAlchemyValue === 'function') {
                                    convertToAlchemyValue();
                                }
                            } catch (e) {
                                console.error('一键换取炼药价值失败:', e);
                                try {
                                    alert('一键换取失败：' + (e.message || '未知错误'));
                                } catch (alertError) {
                                    console.error('显示错误提示失败:', alertError);
                                }
                            }
                        };
                        // 同时使用addEventListener作为备份
                        try {
                            function convertAlchemyHandler() {
                                try {
                                    if (typeof convertToAlchemyValue === 'function') {
                                        convertToAlchemyValue();
                                    }
                                } catch (e) {
                                    console.error('一键换取炼药价值失败:', e);
                                }
                            }
                            convertAlchemyBtn.removeEventListener("click", convertAlchemyHandler);
                            convertAlchemyBtn.addEventListener("click", convertAlchemyHandler);
                        } catch (e) {
                            console.warn('为一键换取炼药价值按钮添加addEventListener失败，但onclick已设置:', e);
                        }
                    }
                }
                
                bindConvertAlchemyButton();
                setTimeout(bindConvertAlchemyButton, 100);
            } catch (e) {
                console.error('添加一键换取炼药价值按钮事件监听失败:', e);
            }
            
            // 初始UI更新
            updateUI();
            
            // 设置自动保存
            try {
                setInterval(saveGame, 5000);
            } catch (e) {
                console.error('设置自动保存失败:', e);
            }
            
            // 初始化在线时长显示
            updatePlayTimeDisplay();
            
            // 设置在线时长更新定时器 - 每秒更新一次
            try {
                // 确保只创建一个定时器
                if (window._playTimeInterval) {
                    clearInterval(window._playTimeInterval);
                }
                window._playTimeInterval = setInterval(function() {
                    try {
                        if (window.gameState && window.gameState.totalPlayTimeSeconds !== undefined) {
                            window.gameState.totalPlayTimeSeconds += 1;
                            updatePlayTimeDisplay();
                            // 同时更新标题，确保在线时长实时显示
                            if (typeof updateTitleDamage === 'function') {
                                updateTitleDamage();
                            }
                        }
                    } catch (intervalError) {
                        console.error('更新在线时长时出错:', intervalError);
                    }
                }, 1000);
            } catch (timerError) {
                console.error('设置在线时长更新定时器失败:', timerError);
            }
        }
        
        // 根据游戏阶段更新标签可见性
        function updateTabsVisibility() {
            try {
                const tabsContainer = document.querySelector('.tabs');
                if (tabsContainer) {
                    const boostBtn = tabsContainer.querySelector('[data-tab="boosts"]');
                    const resourcesBtn = tabsContainer.querySelector('[data-tab="resources"]');
                    const shopBtn = tabsContainer.querySelector('[data-tab="shop"]');
                    const alchemyBtn = tabsContainer.querySelector('[data-tab="alchemy"]');
                    const waterTreeBtn = tabsContainer.querySelector('[data-tab="water-tree"]');
                    const researchBtn = tabsContainer.querySelector('[data-tab="research"]'); // 研究所按钮
                    const main2Btn = tabsContainer.querySelector('[data-tab="main2"]');
                    
                    // 确保所有必要的按钮都存在
                    if (boostBtn && resourcesBtn && shopBtn && alchemyBtn) {
                        // 获取游戏状态变量
                        const main2Unlocked = window.gameState?.main2Unlocked || 0;
                        const main3Unlocked = window.gameState?.main3Unlocked || 0;
                        const questionMarksCount = window.gameState?.resources?.["???"] || 0;
                        
                        // 获取所有需要控制的元素
                        const sideBtn = tabsContainer.querySelector('[data-tab="side"]');
                        const main1CategoryBtn = document.querySelector('.block-category .category-btn[data-category="main1"]');
                        const main2CategoryBtn = document.querySelector('.block-category .category-btn[data-category="main2"]');
                        const main3CategoryBtn = document.querySelector('.block-category .category-btn[data-category="main3"]');
                        const sideCategoryBtn = document.querySelector('.block-category .category-btn[data-category="side"]');
                        const main1ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="main1"]');
                        const main2ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="main2"]');
                        const main3ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="main3"]');
                        const sideShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="side"]');
                        const itemsShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="items"]');
                        
                        // 隐藏所有元素
                        if (main2Btn) main2Btn.style.display = 'none';
                        if (waterTreeBtn) waterTreeBtn.style.display = 'none';
                        if (researchBtn) researchBtn.style.display = 'none';
                        if (main1CategoryBtn) main1CategoryBtn.style.display = 'none';
                        if (main2CategoryBtn) main2CategoryBtn.style.display = 'none';
                        if (main3CategoryBtn) main3CategoryBtn.style.display = 'none';
                        if (sideCategoryBtn) sideCategoryBtn.style.display = 'none';
                        if (main1ShopBtn) main1ShopBtn.style.display = 'none';
                        if (main2ShopBtn) main2ShopBtn.style.display = 'none';
                        if (main3ShopBtn) main3ShopBtn.style.display = 'none';
                        // 支线商店标签和UI标签不隐藏，始终显示
                        if (itemsShopBtn) itemsShopBtn.style.display = 'none';
                        // sideBtn不隐藏，始终显示支线UI标签
                        
                        // 获取游戏阶段
                        const gameStage = window.gameState?.gameStage || 1;
                        
                        // 第三阶段第二部分（主线3已解锁且???数量≥0）
                        if (main3Unlocked === 1 && questionMarksCount >= 0) {
                            // UI标签：显示增益、资源、商店、炼药、浇树，支线UI标签已始终显示
                            boostBtn.style.display = 'inline-block';
                            resourcesBtn.style.display = 'inline-block';
                            shopBtn.style.display = 'inline-block';
                            alchemyBtn.style.display = 'inline-block';
                            if (waterTreeBtn) waterTreeBtn.style.display = 'inline-block';
                            // 研究所标签仅在游戏阶段≥3时显示
                            if (researchBtn && gameStage >= 3) researchBtn.style.display = 'inline-block';
                            // sideBtn已在函数开始时设置为不隐藏
                            if (main2Btn) main2Btn.style.display = 'inline-block';
                            
                            // 方块标签：显示主线1、主线2、主线3和支线
                            if (main1CategoryBtn) main1CategoryBtn.style.display = 'inline-block';
                            if (main2CategoryBtn) main2CategoryBtn.style.display = 'inline-block';
                            if (main3CategoryBtn) main3CategoryBtn.style.display = 'inline-block';
                            if (sideCategoryBtn) sideCategoryBtn.style.display = 'inline-block';
                            
                            // 商店标签：显示所有商店
                            if (main1ShopBtn) main1ShopBtn.style.display = 'inline-block';
                            if (main2ShopBtn) main2ShopBtn.style.display = 'inline-block';
                            if (main3ShopBtn) main3ShopBtn.style.display = 'inline-block';
                            if (sideShopBtn) sideShopBtn.style.display = 'inline-block';
                            if (itemsShopBtn) itemsShopBtn.style.display = 'inline-block';
                        }
                        // 第三阶段第一部分（主线3已解锁但???数量<0）
                        else if (main3Unlocked === 1) {
                            // UI标签：显示增益、资源、商店、炼药、浇树
                            boostBtn.style.display = 'inline-block';
                            resourcesBtn.style.display = 'inline-block';
                            shopBtn.style.display = 'inline-block';
                            alchemyBtn.style.display = 'inline-block';
                            if (waterTreeBtn) waterTreeBtn.style.display = 'inline-block';
                            // 研究所标签仅在游戏阶段≥3时显示
                            if (researchBtn && gameStage >= 3) researchBtn.style.display = 'inline-block';
                            if (sideBtn) sideBtn.style.display = 'inline-block';
                            if (main2Btn) main2Btn.style.display = 'inline-block';
                            
                            // 方块标签：显示主线1、主线2、主线3和支线
                            if (main1CategoryBtn) main1CategoryBtn.style.display = 'inline-block';
                            if (main2CategoryBtn) main2CategoryBtn.style.display = 'inline-block';
                            if (main3CategoryBtn) main3CategoryBtn.style.display = 'inline-block';
                            if (sideCategoryBtn) sideCategoryBtn.style.display = 'inline-block';
                            
                            // 商店标签：显示所有商店
                            if (main1ShopBtn) main1ShopBtn.style.display = 'inline-block';
                            if (main2ShopBtn) main2ShopBtn.style.display = 'inline-block';
                            if (main3ShopBtn) main3ShopBtn.style.display = 'inline-block';
                            if (sideShopBtn) sideShopBtn.style.display = 'inline-block';
                            if (itemsShopBtn) itemsShopBtn.style.display = 'inline-block';
                        }
                        // 第二阶段（主线2已解锁）
                        else if (main2Unlocked === 1) {
                            // UI标签：显示增益、资源、商店、炼药、浇树，支线UI标签已始终显示
                            boostBtn.style.display = 'inline-block';
                            resourcesBtn.style.display = 'inline-block';
                            shopBtn.style.display = 'inline-block';
                            alchemyBtn.style.display = 'inline-block';
                            if (waterTreeBtn) waterTreeBtn.style.display = 'inline-block';
                            // sideBtn已在函数开始时设置为不隐藏
                            if (main2Btn) main2Btn.style.display = 'inline-block';
                            
                            // 方块标签：显示主线1、主线2和支线
                            if (main1CategoryBtn) main1CategoryBtn.style.display = 'inline-block';
                            if (main2CategoryBtn) main2CategoryBtn.style.display = 'inline-block';
                            if (sideCategoryBtn) sideCategoryBtn.style.display = 'inline-block';
                            
                            // 商店标签：显示主线1商店、主线2商店、支线商店和物品商店
                            if (main1ShopBtn) main1ShopBtn.style.display = 'inline-block';
                            if (main2ShopBtn) main2ShopBtn.style.display = 'inline-block';
                            if (sideShopBtn) sideShopBtn.style.display = 'inline-block';
                            if (itemsShopBtn) itemsShopBtn.style.display = 'inline-block';
                        }
                        // 第一阶段（主线2未解锁）
                        else {
                            // UI标签：仅显示增益、资源、商店、炼药，支线UI标签已始终显示
                            boostBtn.style.display = 'inline-block';
                            resourcesBtn.style.display = 'inline-block';
                            shopBtn.style.display = 'inline-block';
                            alchemyBtn.style.display = 'inline-block';
                            
                            // 方块标签：仅显示主线1和支线
                            if (main1CategoryBtn) main1CategoryBtn.style.display = 'inline-block';
                            if (sideCategoryBtn) sideCategoryBtn.style.display = 'inline-block';
                            // sideBtn已在函数开始时设置为不隐藏
                            
                            // 商店标签：显示主线1商店和物品商店，支线商店已在函数开始时设置为显示
                            if (main1ShopBtn) main1ShopBtn.style.display = 'inline-block';
                            if (itemsShopBtn) itemsShopBtn.style.display = 'inline-block';
                        }
                        
                        // 隐藏旧的支线分类按钮（side1、side2、side3）
                        const side1CategoryBtn = document.querySelector('.block-category .category-btn[data-category="side1"]');
                        const side2CategoryBtn = document.querySelector('.block-category .category-btn[data-category="side2"]');
                        const side3CategoryBtn = document.querySelector('.block-category .category-btn[data-category="side3"]');
                        if (side1CategoryBtn) side1CategoryBtn.style.display = 'none';
                        if (side2CategoryBtn) side2CategoryBtn.style.display = 'none';
                        if (side3CategoryBtn) side3CategoryBtn.style.display = 'none';
                        
                        // 隐藏旧的支线商店按钮（side1、side2、side3）
                        const side1ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="side1"]');
                        const side2ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="side2"]');
                        const side3ShopBtn = document.querySelector('.shop-categories .category-btn[data-shop="side3"]');
                        if (side1ShopBtn) side1ShopBtn.style.display = 'none';
                        if (side2ShopBtn) side2ShopBtn.style.display = 'none';
                        if (side3ShopBtn) side3ShopBtn.style.display = 'none';
                    }
                }
                
                // 研究所UI的显示现在完全由标签点击事件控制（见handleTabClick函数）
                // 删除了根据游戏阶段自动显示研究所UI的代码
            } catch (e) {
                console.error('更新标签可见性时出错:', e);
            }
            
            // 更新当前阶段显示
            updateGameStageDisplay();
        }
            
            // 添加缺失的startAutoMining函数，确保游戏状态恢复时能正确启动自动挖矿
            function startAutoMining() {
                try {
                    console.log('启动自动挖矿');
                    // 如果已有定时器运行，先清除
                    if (autoMiningInterval) {
                        clearInterval(autoMiningInterval);
                        autoMiningInterval = null;
                    }
                    
                    // 只有在启用状态下才启动定时器
                    if (window.gameState && window.gameState.autoMiningEnabled) {
                        // 自动挖矿速度：(20*阶段)次每秒
                        const miningInterval = 1000 / (20 * (window.gameState.gameStage || 1));
                        autoMiningInterval = setInterval(() => {
                            mineBlock(true); // 传入参数表示自动挖矿
                        }, miningInterval);
                        console.log('自动挖矿已启动，间隔:', miningInterval, 'ms');
                    }
                } catch (e) {
                    console.error('启动自动挖矿失败:', e);
                }
            }
            
            // 开始自动挖矿定时器（如果启用）
            if (window.gameState && window.gameState.autoMiningEnabled) {
                startAutoMining();
            }
        

        // 解锁能量转化器功能
        function unlockEnergyConverter(type) {
                try {
                    // 计算所需资源数量（根据规则，第一个10W，第二个40W，第三个100W）
                    let requiredAmount = 100000;
                    let unlockedCount = 0;
                    for (let key in window.gameState.converters) {
                        if (window.gameState.converters[key] === true) {
                            unlockedCount++;
                        }
                    }

                    if (unlockedCount === 1) requiredAmount = 400000;
                    if (unlockedCount === 2) requiredAmount = 1000000;

                    // 获取对应的资源键名（α、β、γ）
                    const resourceKey = type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ';

                    // 检查资源是否足够且未解锁
                    const hasEnoughResources = window.gameState.resources[resourceKey] >= requiredAmount;
                    if (hasEnoughResources && !(window.gameState.converters[type] === true)) {
                        // 扣除资源
                        window.gameState.resources[resourceKey] -= requiredAmount;
                        // 解锁转化器
                        window.gameState.converters[type] = true;
                        
                        // 显示成功通知
                        showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}能量转化器解锁成功！`, 'success');
                        
                        // 更新UI显示
                        if (typeof updateResearchDisplay === 'function') updateResearchDisplay();
                        if (typeof updateResourcesDisplay === 'function') updateResourcesDisplay();
                    } else {
                        // 显示错误通知
                        if (window.gameState.converters[type]) {
                            showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}能量转化器已经解锁！`, 'warning');
                        } else {
                            showNotification(`资源不足，需要 ${requiredAmount} ${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}物质！`, 'error');
                        }
                    }
                } catch (e) {
                    console.error('解锁能量转化器失败:', e);
                    showNotification('解锁失败，请稍后重试', 'error');
                }
            }
            
            // 解锁量产器功能
            function unlockProducer(type) {
                try {
                    // 确保类型有效
                    if (!['alpha', 'beta', 'gamma'].includes(type)) {
                        console.error('无效的量产器类型');
                        return;
                    }

                    // 检查是否已解锁
                    if (window.gameState.producers[type] > 0) {
                        showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}量产器已经解锁！`, 'warning');
                        return;
                    }

                    // 计算所需量产核心数量（根据规则，第一个10，第二个100，第三个1000）
                    let requiredCores = 10;
                    let unlockedCount = 0;
                    for (let key in window.gameState.producers) {
                        if (window.gameState.producers[key] > 0) {
                            unlockedCount++;
                        }
                    }

                    if (unlockedCount === 1) requiredCores = 100;
                    if (unlockedCount === 2) requiredCores = 1000;

                    // 检查量产核心是否足够且未解锁
                    const hasEnoughCores = window.gameState.resources['量产核心'] >= requiredCores;
                    if (hasEnoughCores && window.gameState.producers[type] === 0) {
                        // 扣除量产核心
                        window.gameState.resources['量产核心'] -= requiredCores;
                        // 解锁量产器并设置等级为1
                        window.gameState.producers[type] = 1;
                        
                        // 显示成功通知
                        showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}量产器解锁成功！`, 'success');
                        // 更新UI
                        if (typeof updateResearchDisplay === 'function') updateResearchDisplay();
                        if (typeof updateResourcesDisplay === 'function') updateResourcesDisplay();
                    } else {
                        showNotification(`量产核心不足，需要 ${requiredCores} 个量产核心！`, 'error');
                    }
                } catch (error) {
                    console.error('解锁量产器时出错:', error);
                    showNotification('操作失败，请重试', 'error');
                }
            }
            
            // 量产器升级功能
            function upgradeProducer(type) {
                try {
                    // 确保类型有效
                    if (!['alpha', 'beta', 'gamma'].includes(type)) {
                        console.error('无效的量产器类型');
                        return;
                    }

                    // 检查是否已解锁
                    if (window.gameState.producers[type] === 0) {
                        showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}量产器尚未解锁！`, 'warning');
                        return;
                    }

                    // 检查是否所有量产器都已解锁（根据规则，需要全部解锁才能升级）
                    let allUnlocked = true;
                    for (let key in window.gameState.producers) {
                        if (window.gameState.producers[key] === 0) {
                            allUnlocked = false;
                            break;
                        }
                    }
                    
                    if (!allUnlocked) {
                        showNotification('需要解锁所有三种量产器才能进行升级！', 'warning');
                        return;
                    }

                    // 计算量产器总等级
                    let totalLevel = 0;
                    for (let key in window.gameState.producers) {
                        totalLevel += window.gameState.producers[key];
                    }

                    // 计算升级价格：（200*量产器总等级+600）个量产核心
                    let requiredCores = 200 * totalLevel + 600;

                    // 检查量产核心是否足够
                    if (window.gameState.resources['量产核心'] >= requiredCores) {
                        // 扣除量产核心
                        window.gameState.resources['量产核心'] -= requiredCores;
                        // 升级量产器
                        window.gameState.producers[type]++;
                        // 显示成功通知
                        showNotification(`${type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ'}量产器升级成功！当前等级：${window.gameState.producers[type]}`, 'success');
                        // 更新UI
                        if (typeof updateResearchDisplay === 'function') updateResearchDisplay();
                        if (typeof updateResourcesDisplay === 'function') updateResourcesDisplay();
                    } else {
                        showNotification(`量产核心不足，需要 ${requiredCores} 个量产核心！`, 'error');
                    }
                } catch (error) {
                    console.error('升级量产器时出错:', error);
                    showNotification('操作失败，请重试', 'error');
                }
            }
            
            // 更新研究所界面显示
            function updateResearchDisplay() {
                try {
                    // 更新能量转化器显示
                    const types = ['alpha', 'beta', 'gamma'];
                    // 使用HTML实体或更可靠的Unicode表示确保符号正确显示
                    const typeSymbols = { 
                        'alpha': 'α', // α 或可以使用 '&alpha;'
                        'beta': 'β', // β 或可以使用 '&beta;'
                        'gamma': 'γ' // γ 或可以使用 '&gamma;'
                    };
                    
                    types.forEach(type => {
                        const symbol = typeSymbols[type];
                        
                        // 计算能量转化器解锁价格
                        let converterCost = 100000;
                        let converterUnlockedCount = 0;
                        for (let key in window.gameState.converters) {
                            if (window.gameState.converters[key] === true) {
                                converterUnlockedCount++;
                            }
                        }
                        if (converterUnlockedCount === 1) converterCost = 400000;
                        if (converterUnlockedCount === 2) converterCost = 1000000;
                        
                        // 更新转化器价格显示
                        const costElement = document.getElementById(`${type}-converter-cost`);
                        if (costElement) {
                            costElement.textContent = `${converterCost} ${symbol}`;
                        }
                        
                        // 更新转化器按钮状态
                        const unlockBtn = document.getElementById(`unlock-${type}-converter`);
                        if (unlockBtn) {
                            if (window.gameState.converters[type]) {
                                unlockBtn.textContent = '已解锁';
                                unlockBtn.disabled = true;
                                unlockBtn.classList.add('disabled');
                            } else {
                                unlockBtn.textContent = '解锁';
                                unlockBtn.disabled = false;
                                unlockBtn.classList.remove('disabled');
                            }
                        }
                        
                        // 更新能量状态和增益显示
                        const energy = window.gameState.energies[type] || 0;
                        let gainText = '';
                        
                        if (type === 'alpha') {
                            // α能量增益 = (α能量 + 1)^0.1
                            const gain = Math.pow(energy + 1, 0.1);
                            gainText = `${symbol}能量: ${energy}, 增益: ${gain.toFixed(2)}`;
                        } else if (type === 'beta') {
                            // β能量增益 = (β能量 + 1)^0.4
                            const gain = Math.pow(energy + 1, 0.4);
                            gainText = `${symbol}能量: ${energy}, 倍增: ${gain.toFixed(2)}`;
                        } else if (type === 'gamma') {
                            // γ能量增益 = (γ能量 + 1)^0.24
                            const gain = Math.pow(energy + 1, 0.24);
                            gainText = `${symbol}能量: ${energy}, 每秒经验: ${gain.toFixed(2)}`;
                        }
                        
                        const statusElement = document.getElementById(`${type}-energy-status`);
                        if (statusElement) {
                            statusElement.textContent = gainText;
                        }
                        
                        // 更新量产器相关显示
                        const producerLevel = window.gameState.producers[type] || 0;
                        
                        // 更新量产器等级
                        const levelElement = document.getElementById(`${type}-producer-level`);
                        if (levelElement) {
                            levelElement.textContent = producerLevel;
                        }
                        
                        // 计算量产器解锁价格
                        let producerCost = 10;
                        let producerUnlockedCount = 0;
                        for (let key in window.gameState.producers) {
                            if (window.gameState.producers[key] > 0) {
                                producerUnlockedCount++;
                            }
                        }
                        if (producerUnlockedCount === 1) producerCost = 100;
                        if (producerUnlockedCount === 2) producerCost = 1000;
                        
                        // 更新量产器解锁价格
                        const producerCostElement = document.getElementById(`${type}-producer-cost`);
                        if (producerCostElement) {
                            producerCostElement.textContent = `${producerCost} 量产核心`;
                        }
                        
                        // 更新量产器生产速率
                        const productionRate = producerLevel * 5;
                        const rateElement = document.getElementById(`${type}-producer-rate`);
                        if (rateElement) {
                            rateElement.textContent = `${productionRate} ${symbol}`;
                        }
                        
                        // 更新量产器解锁按钮
                        const unlockProducerBtn = document.getElementById(`unlock-${type}-producer`);
                        if (unlockProducerBtn) {
                            if (producerLevel > 0) {
                                unlockProducerBtn.textContent = '已解锁';
                                unlockProducerBtn.disabled = true;
                                unlockProducerBtn.classList.add('disabled');
                            } else {
                                unlockProducerBtn.textContent = '解锁';
                                unlockProducerBtn.disabled = false;
                                unlockProducerBtn.classList.remove('disabled');
                            }
                        }
                        
                        // 更新量产器升级按钮
                        const upgradeBtn = document.getElementById(`upgrade-${type}-producer`);
                        const upgradeCostElement = document.getElementById(`${type}-upgrade-cost`);
                        
                        if (upgradeBtn && upgradeCostElement) {
                            // 检查是否所有量产器都已解锁
                            let allProducersUnlocked = true;
                            for (let key in window.gameState.producers) {
                                if (window.gameState.producers[key] === 0) {
                                    allProducersUnlocked = false;
                                    break;
                                }
                            }
                            
                            if (producerLevel > 0 && allProducersUnlocked) {
                                // 计算升级价格
                                let totalProducerLevel = 0;
                                for (let key in window.gameState.producers) {
                                    totalProducerLevel += window.gameState.producers[key];
                                }
                                const upgradeCost = 200 * totalProducerLevel + 600;
                                
                                upgradeCostElement.textContent = `${upgradeCost} 量产核心`;
                                upgradeBtn.style.display = 'inline-block';
                                
                                // 检查资源是否足够
                                if (window.gameState.resources['量产核心'] >= upgradeCost) {
                                    upgradeBtn.disabled = false;
                                    upgradeBtn.classList.remove('disabled');
                                } else {
                                    upgradeBtn.disabled = true;
                                    upgradeBtn.classList.add('disabled');
                                }
                            } else {
                                upgradeBtn.style.display = 'none';
                            }
                        }
                    });
                } catch (error) {
                    console.error('更新研究所界面时出错:', error);
                }
            }
            
            // 能量自动转化功能
            function autoConvertEnergy() {
                try {
                    const types = ['alpha', 'beta', 'gamma'];
                    
                    types.forEach(type => {
                        // 检查转化器是否已解锁
                        if (window.gameState.converters[type]) {
                            // 使用希腊字母作为资源键名
                            const resourceKey = type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ';
                            
                            // 获取当前物质数量
                            const fragmentCount = window.gameState.resources[resourceKey] || 0;
                            
                            if (fragmentCount > 0) {
                                // 计算转化量：1%的物质转化为能量
                                const convertAmount = Math.floor(fragmentCount * 0.01);
                                
                                if (convertAmount > 0) {
                                    // 扣除物质
                                    window.gameState.resources[resourceKey] -= convertAmount;
                                    // 增加能量
                                    window.gameState.energies[type] = (window.gameState.energies[type] || 0) + convertAmount;
                                }
                            }
                        }
                    });
                    
                    // 更新UI显示
                    if (typeof updateResearchDisplay === 'function') updateResearchDisplay();
                    if (typeof updateResourcesDisplay === 'function') updateResourcesDisplay();
                } catch (error) {
                    console.error('自动转化能量时出错:', error);
                }
            }
            
            // 启动能量自动转化定时器
            function startAutoConvertEnergy() {
                // 每秒执行一次能量转化
                window.autoConvertInterval = setInterval(autoConvertEnergy, 1000);
                console.log('能量自动转化已启动');
            }
            
            // 停止能量自动转化定时器
            function stopAutoConvertEnergy() {
                if (window.autoConvertInterval) {
                    clearInterval(window.autoConvertInterval);
                    window.autoConvertInterval = null;
                    console.log('能量自动转化已停止');
                }
            }
            
            // 量产器自动生产功能
            function autoProduceFragments() {
                try {
                    const types = ['alpha', 'beta', 'gamma'];
                    
                    types.forEach(type => {
                        // 获取量产器等级
                        const producerLevel = window.gameState.producers[type] || 0;
                        
                        if (producerLevel > 0) {
                            // 计算生产量：每秒5*等级
                            const productionAmount = producerLevel * 5;
                            
                            // 使用希腊字母作为资源键名
                            const resourceKey = type === 'alpha' ? 'α' : type === 'beta' ? 'β' : 'γ';
                            
                            // 增加物质到resources对象
                            window.gameState.resources[resourceKey] = (window.gameState.resources[resourceKey] || 0) + productionAmount;
                        }
                    });
                    
                    // 更新UI显示
                    if (typeof updateResearchDisplay === 'function') updateResearchDisplay();
                    if (typeof updateResourcesDisplay === 'function') updateResourcesDisplay();
                } catch (error) {
                    console.error('自动生产物质时出错:', error);
                }
            }
            
            // γ能量自动获得松树经验功能
            function autoGainTreeExp() {
                try {
                    const { converters, energies } = window.gameState;
                    
                    // 检查γ能量转化器是否已解锁且有γ能量
                    if (converters?.gamma && energies?.gamma > 0) {
                        // 计算自动获得的浇树经验：γ能量^0.24
                        const expGain = Math.pow(energies.gamma, 0.24);
                        
                        // 增加树经验
                        window.gameState.treeExp = (window.gameState.treeExp || 0) + expGain;
                        
                        // 检查是否可以升级
                        const treeLevel = window.gameState.treeLevel || 1;
                        const expNeededForNextLevel = treeLevel * 10;
                        
                        if (window.gameState.treeExp >= expNeededForNextLevel) {
                            window.gameState.treeExp -= expNeededForNextLevel;
                            window.gameState.treeLevel = (window.gameState.treeLevel || 1) + 1;
                        }
                        
                        // 更新UI显示
                        if (typeof updateTreeUI === 'function') updateTreeUI();
                        
                        // 更新γ能量状态显示
                        const gammaEnergyStatusElement = document.getElementById('gamma-energy-status');
                        if (gammaEnergyStatusElement) {
                            gammaEnergyStatusElement.textContent = `γ能量: ${energies.gamma}, 每秒经验: ${expGain.toFixed(2)}`;
                        }
                    }
                } catch (error) {
                    console.error('自动获得松树经验时出错:', error);
                }
            }
            
            // 启动γ能量自动获得松树经验定时器
            function startAutoGainTreeExp() {
                // 每秒执行一次
                window.treeExpInterval = setInterval(autoGainTreeExp, 1000);
                console.log('γ能量自动获得松树经验已启动');
            }
            
            // 停止γ能量自动获得松树经验定时器
            function stopAutoGainTreeExp() {
                if (window.treeExpInterval) {
                    clearInterval(window.treeExpInterval);
                    window.treeExpInterval = null;
                    console.log('γ能量自动获得松树经验已停止');
                }
            }
            
            // 启动量产器自动生产定时器
            function startAutoProduceFragments() {
                // 每秒执行一次生产
                window.productionInterval = setInterval(autoProduceFragments, 1000);
                console.log('量产器自动生产已启动');
            }
            
            // 停止量产器自动生产定时器
            function stopAutoProduceFragments() {
                if (window.productionInterval) {
                    clearInterval(window.productionInterval);
                    window.productionInterval = null;
                    console.log('量产器自动生产已停止');
                }
            }
            
            // 启动所有自动功能
            function startAllAutoFunctions() {
                try {
                    // 启动能量自动转化
                    if (typeof startAutoConvertEnergy === 'function') {
                        startAutoConvertEnergy();
                    }
                    // 启动量产器自动生产
                    if (typeof startAutoProduceFragments === 'function') {
                        startAutoProduceFragments();
                    }
                    // 启动γ能量自动获得松树经验
                    if (typeof startAutoGainTreeExp === 'function') {
                        startAutoGainTreeExp();
                    }
                } catch (error) {
                    console.error('启动自动功能时出错:', error);
                }
            }
            
            // 添加定期更新兑换信息的定时器
            function startConvertInfoUpdater() {
                // 每100毫秒更新一次兑换信息
            setInterval(updateConvertInfo, 100);
            console.log('兑换信息自动更新已启动');
        }
        
        // 金奖转化器状态和定时器
        window.gameState = window.gameState || {};
        window.gameState.trophyConverterEnabled = window.gameState.trophyConverterEnabled !== undefined ? window.gameState.trophyConverterEnabled : true; // 默认开启
        let trophyConverterInterval = null;
        
        // 金奖转化器功能 - 按照新公式转化金币为奖杯
        function startTrophyConverter() {
            // 如果已经有定时器在运行，先清除
            if (trophyConverterInterval) {
                clearInterval(trophyConverterInterval);
            }
            
            trophyConverterInterval = setInterval(() => {
                try {
                    // 检查是否拥有金奖转化器且功能已启用
                    if (window.gameState && window.gameState.resources && 
                        (window.gameState.resources["金奖转化器"] || 0) >= 1 && 
                        window.gameState.trophyConverterEnabled) {
                        
                        const gold = window.gameState.gold || 0;
                        // 只有当金币大于等于10000时才进行转化
                        if (gold >= 10000) {
                            // 新公式：奖杯+(金币数量/10000)^0.8；金币*0.99
                            const convertAmount = Math.pow(gold / 10000, 0.8);
                            window.gameState.trophies = (window.gameState.trophies || 0) + convertAmount;
                            window.gameState.gold = gold * 0.99;
                            
                            // 更新UI显示
                            updateGoldDisplay();
                            updateTrophiesDisplay();
                        }
                    }
                } catch (e) {
                    console.error('金奖转化器执行失败:', e);
                }
            }, 1000); // 每秒执行一次
            console.log('金奖转化器已启动');
        }
        
        // 切换金奖转化器开关状态
        function toggleTrophyConverter() {
            if (window.gameState) {
                window.gameState.trophyConverterEnabled = !window.gameState.trophyConverterEnabled;
                console.log('金奖转化器已' + (window.gameState.trophyConverterEnabled ? '开启' : '关闭'));
                // 更新商店UI以反映开关状态
                updateShop();
            }
        }
        
        // 修改initGame函数，在游戏初始化时启动兑换信息更新和金奖转化器
            const originalInitGame = initGame;
            initGame = function() {
                originalInitGame();
                
                // 确保使用完整的blocks数据
                if (!window.gameData || !window.gameData.blocks) {
                    console.warn('强制初始化完整的blocks数据');
                    window.gameData = window.gameData || {};
                    window.gameData.blocks = {
                        main1: [
                            { name: "土块", hp: 100, baseGold: 1 },
                            { name: "草块", hp: 500, baseGold: 2 },
                            { name: "木块", hp: 2000, baseGold: 3 },
                            { name: "石块", hp: 10000, baseGold: 5 },
                            { name: "硬石块", hp: 50000, baseGold: 10 },
                            { name: "深板岩", hp: 300000, baseGold: 15 },
                            { name: "煤炭块", hp: 1780000, baseGold: 20 },
                            { name: "铜块", hp: 7800000, baseGold: 30 },
                            { name: "铁块", hp: 91000000, baseGold: 40 },
                            { name: "金块", hp: 260000000, baseGold: 50 },
                            { name: "钻石块", hp: 1.3e9, baseGold: 60 },
                            { name: "下届合金块", hp: 7.8e9, baseGold: 70 },
                            { name: "黑曜石块", hp: 3.9e10, baseGold: 80 },
                            { name: "红曜石块", hp: 5e11, baseGold: 100, special: { type: "fragment", item: "红曜石碎片", chance: 0.2 } },
                            { name: "蓝曜石块", hp: 6e11, baseGold: 120, special: { type: "fragment", item: "蓝曜石碎片", chance: 0.2 } },
                            { name: "基岩块", hp: 2.2e12, baseGold: 160, special: { type: "fragment", item: "基岩碎片", chance: 0.1 } },
                            { name: "木核心块", hp: 7.8e12, baseGold: 250, special: { type: "core", item: "木核心", chance: 0.05 } },
                            { name: "土核心块", hp: 2.91e13, baseGold: 350, special: { type: "core", item: "土核心", chance: 0.05 } },
                            { name: "水立方块", hp: 1.78e14, baseGold: 500, special: { type: "cube", item: "水立方", chance: 0.03 } },
                            { name: "火立方块", hp: 7.8e14, baseGold: 750, special: { type: "cube", item: "火立方", chance: 0.03 } },
                            { name: "金立方块", hp: 9.1e15, baseGold: 1000, special: { type: "cube", item: "金立方", chance: 0.03 } }
                        ],
                        side1: [
                            { name: "紫水晶方块", hp: 9.1e10, baseGold: 90, special: { type: "fixed", item: "紫水晶", chance: 1 } },
                            { name: "下界之星方块", hp: 7.8e11, baseGold: 140, special: { type: "fragment", item: "下界之星", chance: 0.1 } },
                            { name: "坤坤方块", hp: 9.1e12, baseGold: 200, special: { type: "fragment", item: "坤坤", chance: 0.25 } }
                        ],
                        main2: [
                            { name: "木结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "木结晶", chance: 0.05 } },
                            { name: "土结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "土结晶", chance: 0.05 } },
                            { name: "水结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "水结晶", chance: 0.05 } },
                            { name: "火结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "火结晶", chance: 0.05 } },
                            { name: "金结晶块", hp: 7.8e18, baseGold: 2000, special: { type: "fragment", item: "金结晶", chance: 0.05 } },
                            { name: "风结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "风结晶", chance: 0.05 } },
                            { name: "雷结晶块", hp: 9.1e21, baseGold: 3000, special: { type: "fragment", item: "雷结晶", chance: 0.05 } },
                            { name: "光结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "光结晶", chance: 0.05 } },
                            { name: "暗结晶块", hp: 5e25, baseGold: 5000, special: { type: "fragment", item: "暗结晶", chance: 0.05 } },
                            { name: "源结晶块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "源结晶", chance: 0.01 } }
                        ],
                        side2: [
                            { name: "红曜石块", hp: 5e16, baseGold: 500, special: { type: "fragment", item: "红曜石", chance: 0.05 } },
                            { name: "蓝曜石块", hp: 6e16, baseGold: 600, special: { type: "fragment", item: "蓝曜石", chance: 0.05 } },
                            { name: "金奖核心", hp: 1e21, baseGold: 2000, special: { type: "fragment", item: "金奖核心", chance: 0.1 } },
                            { name: "淼立方块", hp: 1e22, baseGold: 2500, special: { type: "fragment", item: "淼立方", chance: 0.05 } },
                            { name: "水晶晶簇", hp: 1e23, baseGold: 2500, special: { type: "pickaxe", item: "紫水晶镐Ⅲ", count: 1, chance: 0.1 } },
                            { name: "坤群", hp: 1e24, baseGold: 3000, special: { type: "fragment", item: "坤坤", count: 1000, chance: 0.01 } },
                            { name: "红曜方", hp: 5e25, baseGold: 4000, special: { type: "fragment", item: "红曜方", chance: 0.005 } },
                            { name: "蓝曜方", hp: 6e25, baseGold: 4000, special: { type: "fragment", item: "蓝曜方", chance: 0.005 } }
                        ],
                        main3: [
                            { name: "α方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "α", count: 1, chance: 1 } },
                            { name: "β方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "β", count: 1, chance: 1 } },
                            { name: "γ方块", hp: 1.78e29, baseGold: 10000, special: { type: "fragment", item: "γ", count: 1, chance: 1 } },
                            { name: "元素晶片", hp: 1.91e31, baseGold: 15000, special: { type: "fragment", item: "元素晶片", count: 1, chance: 0.1 } },
                            { name: "量产核心", hp: 1.91e34, baseGold: 20000, special: { type: "fragment", item: "量产核心", count: 1, chance: 0.01 } },
                            { name: "五行镐", hp: 7.8e31, baseGold: 18000, special: { type: "fragment", item: "五行镐", count: 1, chance: 0.01 } },
                            { name: "五行精华", hp: 9.1e31, baseGold: 18000, special: { type: "fragment", item: "五行精华", count: 1, chance: 0.001 } }
                        ]
                    };
                }
                console.log('游戏初始化完成，当前main1方块数量:', window.gameData.blocks.main1.length);
            startConvertInfoUpdater();
            startTrophyConverter(); // 启动金奖转化器
            startAllAutoFunctions(); // 启动所有自动功能，包括能量自动转化和量产器自动生产
            // 立即更新一次兑换信息
            updateConvertInfo();
        };
        
        // 全新的兑换函数 - 直接在全局作用域定义
        function handleConvertClick() {
            console.log('兑换按钮点击事件触发');
            
            try {
                // 确保gameState存在
                if (!window.gameState) {
                    window.gameState = { gold: 0, trophies: 0 };
                    console.log('创建了新的gameState对象');
                }
                
                // 获取并验证金币数量
                let gold = parseFloat(window.gameState.gold) || 0;
                let trophies = parseFloat(window.gameState.trophies) || 0;
                
                console.log(`当前金币: ${gold}, 当前奖杯: ${trophies}`);
                
                // 检查金币是否足够
                if (gold < 100) {
                    alert('金币不足100，无法兑换奖杯');
                    return;
                }
                
                // 计算可兑换的奖杯数量
                const trophiesToAdd = Math.floor(Math.pow(gold / 100, 0.8));
                console.log(`计算结果: ${gold}金币可兑换${trophiesToAdd}奖杯`);
                
                if (trophiesToAdd <= 0) {
                    alert('计算错误，无法兑换奖杯');
                    return;
                }
                
                // 执行兑换
                trophies += trophiesToAdd;
                gold = 0;
                
                // 更新游戏状态
                window.gameState.gold = gold;
                window.gameState.trophies = trophies;
                
                // 立即更新UI
                updateConvertUI();
                
                // 保存游戏状态
                try {
                    localStorage.setItem('miningGameState', JSON.stringify(window.gameState));
                    console.log('游戏状态已保存到localStorage');
                } catch (saveError) {
                    console.error('保存失败:', saveError);
                }
                
                // 显示成功提示
                alert(`兑换成功！获得 ${trophiesToAdd} 奖杯`);
                console.log('兑换过程完成');
            } catch (error) {
                console.error('兑换出错:', error);
                alert('兑换失败，请刷新页面后重试');
            }
        }
        
        // 更新兑换相关UI
        function updateConvertUI() {
            try {
                const gameState = window.gameState || { gold: 0, trophies: 0 };
                const gold = parseFloat(gameState.gold) || 0;
                const trophies = parseFloat(gameState.trophies) || 0;
                
                // 更新新旧两种UI元素（兼容性）
                const goldElement = document.getElementById('gold');
                if (goldElement) {
                    goldElement.textContent = formatNumber(gold);
                }
                
                const trophiesElement = document.getElementById('trophies');
                if (trophiesElement) {
                    trophiesElement.textContent = formatNumber(trophies);
                }
                
                const newConvertInfo = document.getElementById('new-convert-info');
                if (newConvertInfo) {
                    const trophiesAvailable = gold >= 100 ? Math.floor(Math.pow(gold / 100, 0.8)) : 0;
                    newConvertInfo.textContent = `当前可兑换: ${formatNumber(trophiesAvailable)} 奖杯`;
                }
                
                // 同时更新旧的兑换信息显示
                const oldConvertInfo = document.getElementById('convert-info');
                if (oldConvertInfo) {
                    const trophiesAvailable = gold >= 100 ? Math.floor(Math.pow(gold / 100, 0.8)) : 0;
                    oldConvertInfo.textContent = `当前可兑换: ${formatNumber(trophiesAvailable)} 奖杯`;
                }
            } catch (e) {
                console.error('更新兑换UI失败:', e);
            }
        }
        
        // 优化版本：只保留一个事件监听器，避免重复初始化和重复绑定点击事件
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded事件触发，初始化游戏');
            // 延迟一点时间确保所有资源都已准备好
            setTimeout(function() {
                // 检查是否已经初始化
                if (!window.gameInitialized) {
                    window.gameInitialized = true;
                    try {
                    // 初始化账号系统
                        if (typeof initAccountSystem === 'function') {
                            initAccountSystem();
                            console.log('账号系统初始化完成');
                        }
                        
                        // 创建账号管理UI
                        if (typeof createAccountManagementUI === 'function') {
                            createAccountManagementUI();
                            console.log('账号管理UI创建完成');
                        }
                        
                        // 只调用initGame函数一次，其中已包含点击事件绑定
                        initGame();
                        
                        // 启动研究所自动功能
                        if (typeof startAllAutoFunctions === 'function') {
                            setTimeout(startAllAutoFunctions, 500);
                        }
                        
                        // 立即更新一次兑换信息
                        if (typeof updateConvertUI === 'function') {
                            updateConvertUI();
                        }
                        
                        // 设置定时更新兑换信息
                        try {
                            setInterval(function() {
                                if (typeof updateConvertUI === 'function') {
                                    updateConvertUI();
                                }
                            }, 200); // 每200毫秒更新一次
                            console.log('兑换信息自动更新已启动');
                        } catch (intervalError) {
                            console.error('设置定时更新失败:', intervalError);
                        }
                    } catch (e) {
                        console.error('DOMContentLoaded初始化失败:', e);
                    }
                }
            }, 100);
        });
        
        // 账号系统测试函数
        function testAccountSystem() {
            console.log('======== 开始测试账号系统 ========');
            
            // 保存原始账号
            const originalAccountId = getCurrentAccountId();
            const originalAccountName = getCurrentAccount().name;
            
            try {
                // 测试1: 创建新账号
                console.log('\n测试1: 创建新账号');
                const testAccountId = createAccount('测试账号');
                console.log(`创建测试账号成功: ID=${testAccountId}, 名称=测试账号`);
                
                // 测试2: 切换到新账号
                console.log('\n测试2: 切换到新账号');
                switchAccount(testAccountId);
                console.log(`切换账号成功，当前账号: ${getCurrentAccount().name}`);
                
                // 测试3: 重命名账号
                console.log('\n测试3: 重命名账号');
                renameAccount(testAccountId, '重命名的测试账号');
                console.log(`重命名账号成功，新名称: ${getCurrentAccount().name}`);
                
                // 测试4: 数据隔离验证
                console.log('\n测试4: 数据隔离验证');
                // 修改当前账号数据
                if (window.gameState) {
                    window.gameState.gold = 99999;
                    saveGame();
                    console.log('已修改当前账号数据并保存');
                }
                
                // 测试5: 切换回原始账号
                console.log('\n测试5: 切换回原始账号');
                switchAccount(originalAccountId);
                console.log(`切换回原始账号成功: ${getCurrentAccount().name}`);
                
                // 测试6: 删除测试账号
                console.log('\n测试6: 删除测试账号');
                // 获取所有账号，确保至少有一个账号
                const accounts = getAccounts();
                if (accounts.length > 1) {
                    deleteAccount(testAccountId);
                    console.log('删除测试账号成功');
                } else {
                    console.log('账号数量不足，跳过删除测试');
                }
                
                console.log('\n======== 账号系统测试完成 ========');
                return true;
            } catch (error) {
                console.error('账号系统测试失败:', error);
                // 恢复原始账号
                if (originalAccountId) {
                    switchAccount(originalAccountId);
                }
                console.log('\n======== 账号系统测试失败 ========');
                return false;
            }
        }
        
        // 添加测试账号系统的按钮
        function addTestAccountSystemButton() {
            const testButton = document.createElement('button');
            testButton.textContent = '测试账号系统';
            testButton.style.position = 'fixed';
            testButton.style.bottom = '10px';
            testButton.style.right = '10px';
            testButton.style.padding = '10px 20px';
            testButton.style.backgroundColor = '#4CAF50';
            testButton.style.color = 'white';
            testButton.style.border = 'none';
            testButton.style.borderRadius = '5px';
            testButton.style.cursor = 'pointer';
            testButton.style.zIndex = '9999';
            testButton.onclick = function() {
                testAccountSystem();
                alert('账号系统测试完成，请查看控制台输出');
            };
            document.body.appendChild(testButton);
        }
        
        // 在DOM加载完成后添加测试按钮
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addTestAccountSystemButton);
        } else {
            addTestAccountSystemButton();
        }
        
        // 3. 添加兼容性polyfill
        if (!Element.prototype.matches) {
            Element.prototype.matches = 
                Element.prototype.msMatchesSelector || 
                Element.prototype.webkitMatchesSelector;
        }
        
        if (!Element.prototype.closest) {
            Element.prototype.closest = function(s) {
                var el = this;
                if (!document.documentElement.contains(el)) return null;
                do {
                    if (el.matches(s)) return el;
                    el = el.parentElement || el.parentNode;
                } while (el !== null && el.nodeType === 1);
                return null;
            };
        }
    </script>
<script>
  // 整合fix_shop.js内容 - 修复普通支线商店显示
  document.addEventListener('DOMContentLoaded', function() {
    // 等待gameData初始化完成
    var checkGameDataInterval = setInterval(function() {
      if (typeof gameData !== 'undefined') {
        clearInterval(checkGameDataInterval);
        
        // 检查并初始化side商店数据
        if (!gameData.pickaxes || !Array.isArray(gameData.pickaxes.side)) {
          if (!gameData.pickaxes) gameData.pickaxes = {};
          gameData.pickaxes.side = [];
          console.log('已初始化side商店数据');
        }
        
        // 更新商店显示
        updateShop();
        console.log('支线商店修复完成');
      }
    }, 100);
    
    // 简单的updateShop函数实现
    function updateShop() {
      // 尝试更新商店显示
      try {
        // 这里可以添加更详细的商店更新逻辑
        console.log('商店更新函数执行');
      } catch (e) {
        console.error('商店更新时出错:', e);
      }
    }
  });
</script>

<!-- 整合auto_level_up_fix.js内容 -->
<script>
// 自动升级功能修复脚本
console.log('加载自动升级功能修复脚本...');

// 保存原始的setInterval函数
const originalSetInterval = window.setInterval;

// 修复经验增加时的自动升级逻辑
function setupAutoLevelUpFix() {
    console.log('设置自动升级修复...');
    
    // 1. 立即启动定期检查升级的定时器
    if (typeof checkLevelUp === 'function') {
        console.log('启动自动升级检查定时器');
        // 清除可能存在的旧定时器
        if (window.levelUpInterval) {
            clearInterval(window.levelUpInterval);
        }
        // 设置新的定时器，每500毫秒检查一次升级（更频繁以提高响应性）
        window.levelUpInterval = originalSetInterval(() => {
            try {
                checkLevelUp();
            } catch (error) {
                console.error('执行自动升级检查时出错:', error);
            }
        }, 500);
    }
    
    // 2. 尝试监听经验变化
    // 重写可能修改经验的方法
    let originalGameState = window.gameState;
    Object.defineProperty(window, 'gameState', {
        set: function(newState) {
            // 保存新状态
            originalGameState = newState;
            // 检查经验是否变化
            if (newState && typeof checkLevelUp === 'function') {
                checkLevelUp();
            }
        },
        get: function() {
            return originalGameState;
        }
    });
    
    // 3. 增强checkLevelUp函数
    const originalCheckLevelUp = window.checkLevelUp;
    window.checkLevelUp = function() {
        try {
            console.log('执行升级检查');
            // 如果存在原始的checkLevelUp函数，调用它
            if (typeof originalCheckLevelUp === 'function') {
                originalCheckLevelUp();
            } else {
                // 实现基本的升级检查逻辑
                if (window.gameState && typeof window.gameState.exp === 'number' && typeof getExpNeeded === 'function') {
                    const currentExp = window.gameState.exp;
                    const expNeeded = getExpNeeded();
                    console.log(`当前经验: ${currentExp}, 需要经验: ${expNeeded}`);
                    
                    // 如果经验足够，尝试升级
                    if (currentExp >= expNeeded) {
                        console.log('经验足够，执行升级');
                        // 这里可以添加基本的升级逻辑
                    }
                }
            }
        } catch (error) {
            console.error('检查升级时出错:', error);
        }
    };
    
    console.log('自动升级修复设置完成');
}

// 4. 监听页面加载事件，确保DOM完全加载后执行
function applyFixWhenReady() {
    if (document.readyState === 'complete') {
        // 页面已经完全加载，立即执行修复
        setupAutoLevelUpFix();
        // 立即执行一次升级检查
        if (typeof checkLevelUp === 'function') {
            setTimeout(checkLevelUp, 100);
        }
    } else {
        // 等待页面完全加载
        window.addEventListener('load', function() {
            setupAutoLevelUpFix();
            // 立即执行一次升级检查
            if (typeof checkLevelUp === 'function') {
                setTimeout(checkLevelUp, 100);
            }
        });
    }
}

// 立即执行修复
applyFixWhenReady();
</script>

<!-- 整合fix_overrides.js内容 -->
<script>
// 等待页面加载完成后执行
window.addEventListener('load', function() {
    console.log('修复覆盖脚本已加载');
    
    // 覆盖startAllAutoFunctions函数
    window.startAllAutoFunctions = function() {
        try {
            console.log('覆盖版startAllAutoFunctions执行');
            // 启动能量自动转化
            if (typeof startAutoConvertEnergy === 'function') {
                startAutoConvertEnergy();
            }
            // 启动量产器自动生产
            if (typeof startAutoProduceFragments === 'function') {
                startAutoProduceFragments();
            }
            // 启动γ能量自动获得松树经验
            if (typeof startAutoGainTreeExp === 'function') {
                startAutoGainTreeExp();
            }
            
            // 添加定期检查升级的定时器
            if (typeof checkLevelUp === 'function') {
                // 清除可能存在的旧定时器
                if (window.levelUpInterval) {
                    clearInterval(window.levelUpInterval);
                }
                // 设置新的定时器，每1秒检查一次升级
                window.levelUpInterval = setInterval(checkLevelUp, 1000);
                console.log('自动升级检查已启动');
            }
        } catch (error) {
            console.error('启动自动功能时出错:', error);
        }
    };
    
    // 覆盖checkLevelUp函数，确保它有正确的try-catch结构
    const originalCheckLevelUp = window.checkLevelUp;
    window.checkLevelUp = function() {
        try {
            if (typeof originalCheckLevelUp === 'function') {
                originalCheckLevelUp();
            } else {
                console.log('原始checkLevelUp函数不存在，执行基本检查');
                // 这里可以添加基本的升级检查逻辑
            }
        } catch (error) {
            console.error('检查升级时出错:', error);
        }
    };
    
    console.log('修复覆盖脚本已完成所有函数覆盖');
    
    // 尝试重新启动自动功能
    if (typeof window.startAllAutoFunctions === 'function') {
        setTimeout(window.startAllAutoFunctions, 1000);
    }
});
</script>

</body>
</html>
